(function(t){function e(e){for(var s,a,o=e[0],h=e[1],c=e[2],l=0,d=[];l<o.length;l++)a=o[l],i[a]&&d.push(i[a][0]),i[a]=0;for(s in h)Object.prototype.hasOwnProperty.call(h,s)&&(t[s]=h[s]);u&&u(e);while(d.length)d.shift()();return n.push.apply(n,c||[]),r()}function r(){for(var t,e=0;e<n.length;e++){for(var r=n[e],s=!0,a=1;a<r.length;a++){var h=r[a];0!==i[h]&&(s=!1)}s&&(n.splice(e--,1),t=o(o.s=r[0]))}return t}var s={},i={app:0},n=[];function a(t){return o.p+"js/"+({about:"about"}[t]||t)+"."+{about:"6d1e053d"}[t]+".js"}function o(e){if(s[e])return s[e].exports;var r=s[e]={i:e,l:!1,exports:{}};return t[e].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.e=function(t){var e=[],r=i[t];if(0!==r)if(r)e.push(r[2]);else{var s=new Promise(function(e,s){r=i[t]=[e,s]});e.push(r[2]=s);var n,h=document.createElement("script");h.charset="utf-8",h.timeout=120,o.nc&&h.setAttribute("nonce",o.nc),h.src=a(t),n=function(e){h.onerror=h.onload=null,clearTimeout(c);var r=i[t];if(0!==r){if(r){var s=e&&("load"===e.type?"missing":e.type),n=e&&e.target&&e.target.src,a=new Error("Loading chunk "+t+" failed.\n("+s+": "+n+")");a.type=s,a.request=n,r[1](a)}i[t]=void 0}};var c=setTimeout(function(){n({type:"timeout",target:h})},12e4);h.onerror=h.onload=n,document.head.appendChild(h)}return Promise.all(e)},o.m=t,o.c=s,o.d=function(t,e,r){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},o.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)o.d(r,s,function(e){return t[e]}.bind(null,s));return r},o.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="",o.oe=function(t){throw console.error(t),t};var h=window["webpackJsonp"]=window["webpackJsonp"]||[],c=h.push.bind(h);h.push=e,h=h.slice();for(var l=0;l<h.length;l++)e(h[l]);var u=c;n.push([0,"chunk-vendors"]),r()})({0:function(t,e,r){t.exports=r("cd49")},"09f8":function(t,e,r){},"0ae1":function(t,e,r){"use strict";var s=r("8286"),i=r.n(s);i.a},"0c5f":function(t,e,r){},"11c9":function(t,e,r){"use strict";var s=r("387b"),i=r.n(s);i.a},"1b4f":function(t,e,r){},2770:function(t,e,r){"use strict";var s=r("0c5f"),i=r.n(s);i.a},"2bc0":function(t,e,r){t.exports=r.p+"img/artgl.d3d716c6.svg"},"2fea":function(t,e,r){},"2ffb":function(t,e,r){},"387b":function(t,e,r){},"3f96":function(t,e,r){},"4e23":function(t,e,r){"use strict";var s=r("5d0f"),i=r.n(s);i.a},5763:function(t,e,r){"use strict";var s=r("be39"),i=r.n(s);i.a},"5c0b":function(t,e,r){"use strict";var s=r("5e27"),i=r.n(s);i.a},"5d0f":function(t,e,r){},"5e27":function(t,e,r){},"5fb1":function(t,e,r){"use strict";var s=r("3f96"),i=r.n(s);i.a},"61ae":function(t,e,r){"use strict";var s=r("6283"),i=r.n(s);i.a},6283:function(t,e,r){},"6def":function(t,e,r){"use strict";var s=r("e67b"),i=r.n(s);i.a},"6e6e":function(t,e,r){"use strict";var s=r("2fea"),i=r.n(s);i.a},"704a":function(t,e,r){"use strict";var s=r("b81e"),i=r.n(s);i.a},"786b":function(t,e,r){"use strict";var s=r("9e8d"),i=r.n(s);i.a},8286:function(t,e,r){},"96a7":function(t,e,r){},"986a":function(t,e,r){},"9e8d":function(t,e,r){},a1ed:function(t,e,r){"use strict";var s=r("f942"),i=r.n(s);i.a},a656:function(t,e,r){"use strict";var s=r("09f8"),i=r.n(s);i.a},a6a9:function(t,e,r){"use strict";var s=r("be2a"),i=r.n(s);i.a},a7b7:function(t,e,r){"use strict";var s=r("ff4f"),i=r.n(s);i.a},aeb3:function(t,e,r){"use strict";var s=r("1b4f"),i=r.n(s);i.a},b2c1:function(t,e,r){"use strict";var s=r("986a"),i=r.n(s);i.a},b720:function(t,e,r){"use strict";var s=r("dbd8"),i=r.n(s);i.a},b81e:function(t,e,r){},be2a:function(t,e,r){},be39:function(t,e,r){},c1b2:function(t,e,r){t.exports=r.p+"img/art.1868a50d.svg"},c3a5:function(t,e,r){"use strict";var s=r("ca8b"),i=r.n(s);i.a},ca8b:function(t,e,r){},cd49:function(t,e,r){"use strict";r.r(e);var s=r("2b0e"),i=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{attrs:{id:"app"}},[t.showTopNav?r("TopNav"):t._e(),r("router-view")],1)},n=[],a=r("9ab4"),o=r("60a3"),h=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"top-nav"},[s("img",{attrs:{src:r("c1b2"),alt:""},on:{click:t.gotoHome}}),s("div",{staticClass:"current-project"},[s("router-link",{attrs:{"active-class":"current",to:"/viewer"}},[t._v("Viewer")]),s("router-link",{attrs:{"active-class":"current",to:"/shader"}},[t._v("Composer")]),s("router-link",{attrs:{"active-class":"current",to:"/examples"}},[t._v("Examples")])],1)])},c=[];let l=class extends o["e"]{gotoHome(){this.$router.push({name:"home"})}};l=a["b"]([o["a"]],l);var u=l,d=u,p=(r("aeb3"),r("2877")),f=Object(p["a"])(d,h,c,!1,null,"7f659a97",null),m=f.exports;let g=class extends o["e"]{get showTopNav(){return"home"!==this.$route.name}};g=a["b"]([Object(o["a"])({components:{TopNav:m}})],g);var v=g,x=v,w=(r("5c0b"),Object(p["a"])(x,i,n,!1,null,null,null)),y=w.exports,_=r("8c4f"),b=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"home-page"},[t._m(0),r("ul",[r("router-link",{attrs:{"active-class":"current",to:"/viewer"}},[t._v("Scene Viewer")]),r("router-link",{attrs:{"active-class":"current",to:"/shader"}},[t._v("Shader Composer")]),r("router-link",{attrs:{"active-class":"current",to:"/examples"}},[t._v("Simple Examples")])],1)])},M=[function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",[s("img",{attrs:{src:r("2bc0"),alt:""}})])}],C=(r("786b"),{}),S=Object(p["a"])(C,b,M,!1,null,"70f84b50",null),E=S.exports,T=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"viewer"},[this.$store.state.showScenePanel?r("ScenePanel"):t._e(),r("ViewerCanvas"),this.$store.state.showConfigPanel?r("ConfigPanel",{attrs:{appConfig:t.appConf}}):t._e()],1)},A=[],R=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"config-panel"},[r("div",{staticClass:"panel-title"},[t._v("\n    Render configuration\n    "),r("button",{on:{click:t.hide}},[t._v("hide")])]),r("div",{staticClass:"config-wrap"},[r("Config",{attrs:{config:t.appConfig}})],1)])},P=[],z=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"conf"},[r("Folder",{attrs:{config:t.config}})],1)},N=[],O=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"folder"},[r("div",{staticClass:"title",on:{click:t.toggle}},[t.expand?r("span",[t._v("=")]):r("span",[t._v(">")]),t._v("\n    "+t._s(t.config.name)+"\n    "),t.isEmptyList?r("span",{staticClass:"empty-hint"},[t._v(" empty ")]):t._e()]),t.expand?r("div",{staticClass:"subitem"},t._l(t.config.value,function(e){return r("div",{key:e.name},[Array.isArray(e.value)?r("config-folder",{attrs:{config:e}}):r("ConfigItem",{attrs:{config:e},model:{value:e.value,callback:function(r){t.$set(e,"value",r)},expression:"subConfig.value"}})],1)}),0):t._e()])},F=[],D=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"item"},[r("div",{staticClass:"item-head"},[r("div",{staticClass:"item-name"},[t._v("\n    "+t._s(t.config.name)+" \n    ")]),r("div",{staticClass:"inline-editor"},["number"===typeof t.config.value&&void 0===t.config.valueConfig?r("NumberEditor",{model:{value:t.configValue,callback:function(e){t.configValue=e},expression:"configValue"}}):t._e(),"boolean"===typeof t.config.value&&void 0===t.config.valueConfig?r("BooleanEditor",{model:{value:t.configValue,callback:function(e){t.configValue=e},expression:"configValue"}}):t._e(),t.config.valueConfig&&"select"===t.config.valueConfig.type?r("SelectEditor",{attrs:{list:t.config.valueConfig.selectItem},model:{value:t.configValue,callback:function(e){t.configValue=e},expression:"configValue"}}):t._e(),t.shouldHaveCustomEditor?r("button",{staticClass:"expand-editor",on:{click:function(e){t.expandEditor=!t.expandEditor}}},[t._v("&")]):t._e()],1)]),t.shouldHaveCustomEditor&&t.expandEditor?r("Editors",{attrs:{editorConfig:t.config.editors},model:{value:t.configValue,callback:function(e){t.configValue=e},expression:"configValue"}}):t._e()],1)},I=[],L=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"editor"},[t.isMultiEditor?r("div",{staticClass:"editor-list"},t._l(t.editorConfig,function(e,s){return r("div",{key:e.type,staticClass:"editor-nav",class:{"active-editor-nav":s===t.currentEditor},on:{click:function(e){return t.useEditor(s)}}},[t._v("\n    "+t._s(e.type)+"\n    ")])}),0):"slider"===t.editor.type?r("NumberSliderEditor",{attrs:{config:t.editor},model:{value:t._value,callback:function(e){t._value=e},expression:"_value"}}):t._e()],1)},V=[],U=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",[r("input",{directives:[{name:"model",rawName:"v-model",value:t._value,expression:"_value"}],attrs:{type:"range",max:t.config.max,min:t.config.min,step:t.config.step},domProps:{value:t._value},on:{__r:function(e){t._value=e.target.value}}})])},k=[];let B=class extends o["e"]{get _value(){return this.value}set _value(t){this.$emit("input",t-0)}};a["b"]([Object(o["c"])({required:!0})],B.prototype,"value",void 0),a["b"]([Object(o["c"])({required:!0})],B.prototype,"config",void 0),B=a["b"]([o["a"]],B);var G=B,j=G,$=Object(p["a"])(j,U,k,!1,null,null,null),q=$.exports;let X=class extends o["e"]{constructor(){super(...arguments),this.currentEditor=0}get isMultiEditor(){return 1!==this.editorConfig.length}get editor(){return this.editorConfig[this.currentEditor]}get _value(){return this.value}set _value(t){this.$emit("input",t)}useEditor(t){this.currentEditor=t}};a["b"]([Object(o["c"])({required:!0})],X.prototype,"editorConfig",void 0),a["b"]([Object(o["c"])({required:!0})],X.prototype,"value",void 0),X=a["b"]([Object(o["a"])({components:{NumberSliderEditor:q}})],X);var W=X,H=W,Y=(r("b2c1"),Object(p["a"])(H,L,V,!1,null,"50902bf1",null)),Z=Y.exports,Q=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"number-editor"},[r("input",{directives:[{name:"model",rawName:"v-model",value:t._value,expression:"_value"}],attrs:{type:"number"},domProps:{value:t._value},on:{input:function(e){e.target.composing||(t._value=e.target.value)}}})])},K=[];let J=class extends o["e"]{get _value(){return this.value}set _value(t){this.$emit("input",t-0)}};a["b"]([Object(o["c"])({required:!0})],J.prototype,"value",void 0),J=a["b"]([o["a"]],J);var tt=J,et=tt,rt=(r("704a"),Object(p["a"])(et,Q,K,!1,null,"4393da8d",null)),st=rt.exports,it=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",[r("input",{directives:[{name:"model",rawName:"v-model",value:t._value,expression:"_value"}],attrs:{type:"checkbox"},domProps:{checked:Array.isArray(t._value)?t._i(t._value,null)>-1:t._value},on:{change:function(e){var r=t._value,s=e.target,i=!!s.checked;if(Array.isArray(r)){var n=null,a=t._i(r,n);s.checked?a<0&&(t._value=r.concat([n])):a>-1&&(t._value=r.slice(0,a).concat(r.slice(a+1)))}else t._value=i}}})])},nt=[];let at=class extends o["e"]{get _value(){return this.value}set _value(t){this.$emit("input",t)}};a["b"]([Object(o["c"])({required:!0})],at.prototype,"value",void 0),at=a["b"]([o["a"]],at);var ot=at,ht=ot,ct=Object(p["a"])(ht,it,nt,!1,null,null,null),lt=ct.exports,ut=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"select-editor"},[r("select",{directives:[{name:"model",rawName:"v-model",value:t._value,expression:"_value"}],on:{change:function(e){var r=Array.prototype.filter.call(e.target.options,function(t){return t.selected}).map(function(t){var e="_value"in t?t._value:t.value;return e});t._value=e.target.multiple?r:r[0]}}},t._l(t.list,function(e){return r("option",{key:e},[t._v(t._s(e))])}),0)])},dt=[];let pt=class extends o["e"]{get _value(){return this.value}set _value(t){this.$emit("input",t)}};a["b"]([Object(o["c"])({required:!0})],pt.prototype,"value",void 0),a["b"]([Object(o["c"])({required:!0})],pt.prototype,"list",void 0),pt=a["b"]([o["a"]],pt);var ft=pt,mt=ft,gt=(r("2770"),Object(p["a"])(mt,ut,dt,!1,null,"4d845963",null)),vt=gt.exports;let xt=class extends o["e"]{constructor(){super(...arguments),this.expandEditor=!1}get configValue(){return this.config.value}set configValue(t){void 0!==this.config.onChange&&this.config.onChange(t),this.config.value=t}get shouldHaveCustomEditor(){return void 0!==this.config.editors}};a["b"]([Object(o["c"])({required:!0})],xt.prototype,"config",void 0),xt=a["b"]([Object(o["a"])({components:{Editors:Z,NumberEditor:st,BooleanEditor:lt,SelectEditor:vt}})],xt);var wt=xt,yt=wt,_t=(r("a7b7"),Object(p["a"])(yt,D,I,!1,null,"40003b0d",null)),bt=_t.exports;let Mt=class extends o["e"]{constructor(){super(...arguments),this.expand=!0}get isEmptyList(){return 0===this.config.value.length}toggle(){this.isEmptyList||(this.expand=!this.expand)}};a["b"]([Object(o["c"])({required:!0})],Mt.prototype,"config",void 0),Mt=a["b"]([Object(o["a"])({name:"config-folder",components:{ConfigItem:bt}})],Mt);var Ct=Mt,St=Ct,Et=(r("a6a9"),Object(p["a"])(St,O,F,!1,null,"a0e8d0e0",null)),Tt=Et.exports;let At=class extends o["e"]{};a["b"]([Object(o["c"])({required:!0})],At.prototype,"config",void 0),At=a["b"]([Object(o["a"])({components:{Folder:Tt}})],At);var Rt,Pt,zt=At,Nt=zt,Ot=(r("6e6e"),Object(p["a"])(Nt,z,N,!1,null,"2d21bbf9",null)),Ft=Ot.exports;(function(t){t["ANGLE_instanced_arrays"]="ANGLE_instanced_arrays",t["OES_texture_float"]="OES_texture_float",t["OES_texture_half_float"]="OES_texture_half_float",t["OES_texture_float_linear"]="OES_texture_float_linear",t["OES_texture_half_float_linear"]="OES_texture_half_float_linear",t["OES_standard_derivatives"]="OES_standard_derivatives",t["OES_vertex_array_object"]="OES_vertex_array_object",t["OES_element_index_uint"]="OES_element_index_uint",t["WEBGL_compressed_texture_s3tc"]="WEBGL_compressed_texture_s3tc",t["WEBGL_depth_texture"]="WEBGL_depth_texture",t["EXT_texture_filter_anisotropic"]="EXT_texture_filter_anisotropic",t["EXT_shader_texture_lod"]="EXT_shader_texture_lod",t["WEBGL_draw_buffers"]="WEBGL_draw_buffers",t["EXT_frag_depth"]="EXT_frag_depth",t["EXT_sRGB"]="EXT_sRGB"})(Rt||(Rt={})),function(t){t["MAX_TEXTURE_SIZE"]="MAX_TEXTURE_SIZE",t["MAX_CUBE_MAP_TEXTURE_SIZE"]="MAX_CUBE_MAP_TEXTURE_SIZE"}(Pt||(Pt={}));const Dt=Object.keys(Rt),It=Object.keys(Pt);class Lt{constructor(t){this.extensions={},this.parameters={},this.gl=t,this.createAllExtension(),this.getAllParams(),void 0!==this.getExtension(Rt.OES_element_index_uint)&&(this.supportUintIndexDraw=!0)}createExtension(t){const e=this.gl;var r=e.getExtension(t);r||(r=e.getExtension("MOZ_"+t)),r||(r=e.getExtension("WEBKIT_"+t)),this.extensions[t]=r}getExtension(t){return t in this.extensions||this.createExtension(t),this.extensions[t]}getParameter(t){return this.parameters[t]}createAllExtension(){for(var t=0;t<Dt.length;t++){var e=Dt[t];this.createExtension(e)}}getAllParams(){for(var t=0;t<It.length;t++){var e=It[t];this.parameters[e]=this.gl.getParameter(this.gl[e])}}}var Vt;(function(t){t[t["vertex"]=0]="vertex",t[t["fragment"]=1]="fragment"})(Vt||(Vt={}));class Ut{constructor(t,e){this.renderer=t;const r=this.renderer.gl;this.type=e;var s=r.createShader(e===Vt.vertex?r.VERTEX_SHADER:r.FRAGMENT_SHADER);if(null===s)throw"webgl shader create failed";this.shader=s}compileShader(t){const e=this.renderer.gl;if(e.shaderSource(this.shader,t),e.compileShader(this.shader),!e.getShaderParameter(this.shader,e.COMPILE_STATUS)){let r=e.getShaderInfoLog(this.shader);if(r)throw kt(t),new Error(r)}if(!this.shader)throw"Something went wrong while compile the shader.";return this.shader}dispose(){this.renderer.gl.deleteShader(this.shader)}}function kt(t){console.warn(Bt(t))}function Bt(t){for(var e=t.split("\n"),r=0;r<e.length;r++)e[r]=r+1+": "+e[r];return e.join("\n")}var Gt,jt="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),$t=new Array(36),qt=0;function Xt(){for(var t=0;t<36;t++)8===t||13===t||18===t||23===t?$t[t]="-":14===t?$t[t]="4":(qt<=2&&(qt=33554432+16777216*Math.random()|0),Gt=15&qt,qt>>=4,$t[t]=jt[19===t?3&Gt|8:Gt]);return $t.join("")}class Wt{constructor(t,e,r){this.x=t||0,this.y=e||0,this.z=r||0}set(t,e,r){return this.x=t,this.y=e,this.z=r,this}setAll(t){return this.x=t,this.y=t,this.z=t,this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}clone(){return new Wt(this.x,this.y,this.z)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}mag(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.mag())}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}normalize(){const t=1/this.length();return this.multiplyScalar(t)}lengthManhattan(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}crossVectors(t,e){const r=t.x,s=t.y,i=t.z,n=e.x,a=e.y,o=e.z;return this.x=s*o-i*a,this.y=i*n-r*o,this.z=r*a-s*n,this}cross(t){return this.crossVectors(this,t)}setFromQuaternion(t){const e=this.x,r=this.y,s=this.z,i=t.x,n=t.y,a=t.z,o=t.w,h=o*e+n*s-a*r,c=o*r+a*e-i*s,l=o*s+i*r-n*e,u=-i*e-n*r-a*s;return this.x=h*o+u*-i+c*-a-l*-n,this.y=c*o+u*-n+l*-i-h*-a,this.z=l*o+u*-a+h*-n-c*-i,this}setFromSpherical(t){const e=Math.sin(t.polar)*t.radius;return this.x=e*Math.sin(t.azim),this.y=Math.cos(t.polar)*t.radius,this.z=e*Math.cos(t.azim),this}applyMatrix4(t){const e=this.x,r=this.y,s=this.z,i=t.elements,n=1/(i[3]*e+i[7]*r+i[11]*s+i[15]);return this.x=(i[0]*e+i[4]*r+i[8]*s+i[12])*n,this.y=(i[1]*e+i[5]*r+i[9]*s+i[13])*n,this.z=(i[2]*e+i[6]*r+i[10]*s+i[14])*n,this}transformDirection(t){var e=this.x,r=this.y,s=this.z,i=t.elements;return this.x=i[0]*e+i[4]*r+i[8]*s,this.y=i[1]*e+i[5]*r+i[9]*s,this.z=i[2]*e+i[6]*r+i[10]*s,this.normalize()}setFromMatrixPosition(t){var e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}project(t,e){return this.applyMatrix4(t).applyMatrix4(e)}unProject(t,e){const r=new te;return r.multiplyMatrices(t,r.getInverse(e,!1)),this.applyMatrix4(r)}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){var e=this.x-t.x,r=this.y-t.y,s=this.z-t.z;return e*e+r*r+s*s}getBuffer(){return new Float32Array([this.x,this.y,this.z])}fromArray(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}static flatten(t,e){return t.toArray(e,0)}}class Ht{constructor(t,e,r,s){this.isVector4=!0,this.x=t||0,this.y=e||0,this.z=r||0,this.w=void 0!==s?s:1}clone(){return new Ht(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=void 0!==t.w?t.w:1,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}set(t,e,r,s){return this.x=t,this.y=e,this.z=r,this.w=s,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this.w=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setW(t){return this.w=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;case 3:this.w=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+t)}}setAxisAngleFromQuaternion(t){this.w=2*Math.acos(t.w);var e=Math.sqrt(1-t.w*t.w);return e<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}applyMatrix4(t){var e=this.x,r=this.y,s=this.z,i=this.w,n=t.elements;return this.x=n[0]*e+n[4]*r+n[8]*s+n[12]*i,this.y=n[1]*e+n[5]*r+n[9]*s+n[13]*i,this.z=n[2]*e+n[6]*r+n[10]*s+n[14]*i,this.w=n[3]*e+n[7]*r+n[11]*s+n[15]*i,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this.w=Math.max(t.w,Math.min(e.w,this.w)),this}clampScalar(t,e){return Yt.set(t,t,t,t),Zt.set(e,e,e,e),this.clamp(Yt,Zt)}clampLength(t,e){var r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(t,Math.min(e,r)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthManhattan(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this}lerpVectors(t,e,r){return this.subVectors(e,t).multiplyScalar(r).add(t)}setAxisAngleFromRotationMatrix(t){var e,r,s,i,n=.01,a=.1,o=t.elements,h=o[0],c=o[4],l=o[8],u=o[1],d=o[5],p=o[9],f=o[2],m=o[6],g=o[10];if(Math.abs(c-u)<n&&Math.abs(l-f)<n&&Math.abs(p-m)<n){if(Math.abs(c+u)<a&&Math.abs(l+f)<a&&Math.abs(p+m)<a&&Math.abs(h+d+g-3)<a)return this.set(1,0,0,0),this;e=Math.PI;var v=(h+1)/2,x=(d+1)/2,w=(g+1)/2,y=(c+u)/4,_=(l+f)/4,b=(p+m)/4;return v>x&&v>w?v<n?(r=0,s=.707106781,i=.707106781):(r=Math.sqrt(v),s=y/r,i=_/r):x>w?x<n?(r=.707106781,s=0,i=.707106781):(s=Math.sqrt(x),r=y/s,i=b/s):w<n?(r=.707106781,s=.707106781,i=0):(i=Math.sqrt(w),r=_/i,s=b/i),this.set(r,s,i,e),this}var M=Math.sqrt((m-p)*(m-p)+(l-f)*(l-f)+(u-c)*(u-c));return Math.abs(M)<.001&&(M=1),this.x=(m-p)/M,this.y=(l-f)/M,this.z=(u-c)/M,this.w=Math.acos((h+d+g-1)/2),this}fromArray(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}static flatten(t,e){return t.toArray(e,0)}}const Yt=new Ht,Zt=new Ht,Qt=new Wt,Kt=new Wt,Jt=new Wt;class te{constructor(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}copy(t){var e=this.elements,r=t.elements;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],this}clone(){return(new te).fromArray(this.elements)}equals(t){for(var e=this.elements,r=t.elements,s=0;s<16;s++)if(e[s]!==r[s])return!1;return!0}set(t,e,r,s,i,n,a,o,h,c,l,u,d,p,f,m){const g=this.elements;return g[0]=t,g[4]=e,g[8]=r,g[12]=s,g[1]=i,g[5]=n,g[9]=a,g[13]=o,g[2]=h,g[6]=c,g[10]=l,g[14]=u,g[3]=d,g[7]=p,g[11]=f,g[15]=m,this}compose(t,e,r){return this.makeRotationFromQuaternion(e),this.scale(r.x,r.y,r.z),this.setPosition(t.x,t.y,t.z),this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}makePerspective(t,e,r,s,i,n){const a=this.elements,o=2*i/(e-t),h=2*i/(r-s),c=(e+t)/(e-t),l=(r+s)/(r-s),u=-(n+i)/(n-i),d=-2*n*i/(n-i);return a[0]=o,a[4]=0,a[8]=c,a[12]=0,a[1]=0,a[5]=h,a[9]=l,a[13]=0,a[2]=0,a[6]=0,a[10]=u,a[14]=d,a[3]=0,a[7]=0,a[11]=-1,a[15]=0,this}makeOrthographic(t,e,r,s,i,n){var a=this.elements,o=1/(e-t),h=1/(r-s),c=1/(n-i),l=(e+t)*o,u=(r+s)*h,d=(n+i)*c;return a[0]=2*o,a[4]=0,a[8]=0,a[12]=-l,a[1]=0,a[5]=2*h,a[9]=0,a[13]=-u,a[2]=0,a[6]=0,a[10]=-2*c,a[14]=-d,a[3]=0,a[7]=0,a[11]=0,a[15]=1,this}multiplyMatrices(t,e){var r=t.elements,s=e.elements,i=this.elements,n=r[0],a=r[4],o=r[8],h=r[12],c=r[1],l=r[5],u=r[9],d=r[13],p=r[2],f=r[6],m=r[10],g=r[14],v=r[3],x=r[7],w=r[11],y=r[15],_=s[0],b=s[4],M=s[8],C=s[12],S=s[1],E=s[5],T=s[9],A=s[13],R=s[2],P=s[6],z=s[10],N=s[14],O=s[3],F=s[7],D=s[11],I=s[15];return i[0]=n*_+a*S+o*R+h*O,i[4]=n*b+a*E+o*P+h*F,i[8]=n*M+a*T+o*z+h*D,i[12]=n*C+a*A+o*N+h*I,i[1]=c*_+l*S+u*R+d*O,i[5]=c*b+l*E+u*P+d*F,i[9]=c*M+l*T+u*z+d*D,i[13]=c*C+l*A+u*N+d*I,i[2]=p*_+f*S+m*R+g*O,i[6]=p*b+f*E+m*P+g*F,i[10]=p*M+f*T+m*z+g*D,i[14]=p*C+f*A+m*N+g*I,i[3]=v*_+x*S+w*R+y*O,i[7]=v*b+x*E+w*P+y*F,i[11]=v*M+x*T+w*z+y*D,i[15]=v*C+x*A+w*N+y*I,this}getInverse(t,e){var r=this.elements,s=t.elements,i=s[0],n=s[1],a=s[2],o=s[3],h=s[4],c=s[5],l=s[6],u=s[7],d=s[8],p=s[9],f=s[10],m=s[11],g=s[12],v=s[13],x=s[14],w=s[15],y=p*x*u-v*f*u+v*l*m-c*x*m-p*l*w+c*f*w,_=g*f*u-d*x*u-g*l*m+h*x*m+d*l*w-h*f*w,b=d*v*u-g*p*u+g*c*m-h*v*m-d*c*w+h*p*w,M=g*p*l-d*v*l-g*c*f+h*v*f+d*c*x-h*p*x,C=i*y+n*_+a*b+o*M;if(0===C){var S="Matrix4.getInverse(): can't invert matrix, determinant is 0";if(!0===e)throw new Error(S);return console.warn(S),this.identity()}var E=1/C;return r[0]=y*E,r[1]=(v*f*o-p*x*o-v*a*m+n*x*m+p*a*w-n*f*w)*E,r[2]=(c*x*o-v*l*o+v*a*u-n*x*u-c*a*w+n*l*w)*E,r[3]=(p*l*o-c*f*o-p*a*u+n*f*u+c*a*m-n*l*m)*E,r[4]=_*E,r[5]=(d*x*o-g*f*o+g*a*m-i*x*m-d*a*w+i*f*w)*E,r[6]=(g*l*o-h*x*o-g*a*u+i*x*u+h*a*w-i*l*w)*E,r[7]=(h*f*o-d*l*o+d*a*u-i*f*u-h*a*m+i*l*m)*E,r[8]=b*E,r[9]=(g*p*o-d*v*o-g*n*m+i*v*m+d*n*w-i*p*w)*E,r[10]=(h*v*o-g*c*o+g*n*u-i*v*u-h*n*w+i*c*w)*E,r[11]=(d*c*o-h*p*o-d*n*u+i*p*u+h*n*m-i*c*m)*E,r[12]=M*E,r[13]=(d*v*a-g*p*a+g*n*f-i*v*f-d*n*x+i*p*x)*E,r[14]=(g*c*a-h*v*a-g*n*l+i*v*l+h*n*x-i*c*x)*E,r[15]=(h*p*a-d*c*a+d*n*l-i*p*l-h*n*f+i*c*f)*E,this}lookAt(t,e,r){const s=this.elements;return Jt.copy(t).sub(e),0===Jt.mag()&&(Jt.z=1),Jt.normalize(),Qt.crossVectors(r,Jt),0===Qt.mag()&&(1===Math.abs(r.z)?Jt.x+=1e-4:Jt.z+=1e-4,Jt.normalize(),Qt.crossVectors(r,Jt)),Qt.normalize(),Kt.crossVectors(Jt,Qt),s[0]=Qt.x,s[4]=Kt.x,s[8]=Jt.x,s[1]=Qt.y,s[5]=Kt.y,s[9]=Jt.y,s[2]=Qt.z,s[6]=Kt.z,s[10]=Jt.z,this}scale(t,e,r){const s=this.elements;return s[0]*=t,s[4]*=e,s[8]*=r,s[1]*=t,s[5]*=e,s[9]*=r,s[2]*=t,s[6]*=e,s[10]*=r,s[3]*=t,s[7]*=e,s[11]*=r,this}setPosition(t,e,r){var s=this.elements;return s[12]=t,s[13]=e,s[14]=r,this}getMaxScaleOnAxis(){var t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],r=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],s=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,r,s))}makeRotationFromQuaternion(t){var e=this.elements,r=t.x,s=t.y,i=t.z,n=t.w,a=r+r,o=s+s,h=i+i,c=r*a,l=r*o,u=r*h,d=s*o,p=s*h,f=i*h,m=n*a,g=n*o,v=n*h;return e[0]=1-(d+f),e[4]=l-v,e[8]=u+g,e[1]=l+v,e[5]=1-(c+f),e[9]=p-m,e[2]=u-g,e[6]=p+m,e[10]=1-(c+d),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeTranslation(t,e,r){return this.set(1,0,0,t,0,1,0,e,0,0,1,r,0,0,0,1),this}makeRotationX(t){var e=Math.cos(t),r=Math.sin(t);return this.set(1,0,0,0,0,e,-r,0,0,r,e,0,0,0,0,1),this}makeRotationY(t){var e=Math.cos(t),r=Math.sin(t);return this.set(e,0,r,0,0,1,0,0,-r,0,e,0,0,0,0,1),this}makeRotationZ(t){var e=Math.cos(t),r=Math.sin(t);return this.set(e,-r,0,0,r,e,0,0,0,0,1,0,0,0,0,1),this}toArray(t,e){void 0===t&&(t=[]),void 0===e&&(e=0);var r=this.elements;return t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8],t[e+9]=r[9],t[e+10]=r[10],t[e+11]=r[11],t[e+12]=r[12],t[e+13]=r[13],t[e+14]=r[14],t[e+15]=r[15],t}fromArray(t,e){void 0===e&&(e=0);for(var r=0;r<16;r++)this.elements[r]=t[r+e];return this}static flatten(t,e){return t.toArray(e,0)}}const ee={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,clamp:function(t,e,r){return Math.max(e,Math.min(r,t))},euclideanModulo:function(t,e){return(t%e+e)%e},mapLinear:function(t,e,r,s,i){return s+(t-e)*(i-s)/(r-e)},lerp:function(t,e,r){return(1-r)*t+r*e},smoothstep:function(t,e,r){return t<=e?0:t>=r?1:(t=(t-e)/(r-e),t*t*(3-2*t))},smootherstep:function(t,e,r){return t<=e?0:t>=r?1:(t=(t-e)/(r-e),t*t*t*(t*(6*t-15)+10))},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},randFloat:function(t,e){return t+Math.random()*(e-t)},randFloatSpread:function(t){return t*(.5-Math.random())},degToRad:function(t){return t*ee.DEG2RAD},radToDeg:function(t){return t*ee.RAD2DEG},isPowerOfTwo:function(t){return 0===(t&t-1)&&0!==t},nearestPowerOfTwo:function(t){return Math.pow(2,Math.round(Math.log(t)/Math.LN2))},nextPowerOfTwo:function(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,t++,t}};var re;(function(t){t[t["XYZ"]=0]="XYZ",t[t["YZX"]=1]="YZX",t[t["ZXY"]=2]="ZXY",t[t["XZY"]=3]="XZY",t[t["YXZ"]=4]="YXZ",t[t["ZYX"]=5]="ZYX"})(re||(re={}));const se=new te;class ie{constructor(t,e,r,s){this._order=ie.defaultOrder,this.onChangeCallback=()=>{},this._x=t||0,this._y=e||0,this._z=r||0,this._order=s||ie.defaultOrder}get x(){return this._x}get y(){return this._y}get z(){return this._z}set x(t){this._x=t,this.onChangeCallback()}set y(t){this._y=t,this.onChangeCallback()}set z(t){this._z=t,this.onChangeCallback()}get order(){return this._order}set order(t){this._order=t}clone(){return new ie(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this.onChangeCallback(),this}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}setFromRotationMatrix(t,e,r){var s=ee.clamp,i=t.elements,n=i[0],a=i[4],o=i[8],h=i[1],c=i[5],l=i[9],u=i[2],d=i[6],p=i[10];return e=e||this._order,e===re.XYZ?(this._y=Math.asin(s(o,-1,1)),Math.abs(o)<.99999?(this._x=Math.atan2(-l,p),this._z=Math.atan2(-a,n)):(this._x=Math.atan2(d,c),this._z=0)):e===re.YXZ?(this._x=Math.asin(-s(l,-1,1)),Math.abs(l)<.99999?(this._y=Math.atan2(o,p),this._z=Math.atan2(h,c)):(this._y=Math.atan2(-u,n),this._z=0)):e===re.ZXY?(this._x=Math.asin(s(d,-1,1)),Math.abs(d)<.99999?(this._y=Math.atan2(-u,p),this._z=Math.atan2(-a,c)):(this._y=0,this._z=Math.atan2(h,n))):e===re.ZYX?(this._y=Math.asin(-s(u,-1,1)),Math.abs(u)<.99999?(this._x=Math.atan2(d,p),this._z=Math.atan2(h,n)):(this._x=0,this._z=Math.atan2(-a,c))):e===re.YZX?(this._z=Math.asin(s(h,-1,1)),Math.abs(h)<.99999?(this._x=Math.atan2(-l,c),this._y=Math.atan2(-u,n)):(this._x=0,this._y=Math.atan2(o,p))):e===re.XZY&&(this._z=Math.asin(-s(a,-1,1)),Math.abs(a)<.99999?(this._x=Math.atan2(d,c),this._y=Math.atan2(o,n)):(this._x=Math.atan2(-l,p),this._y=0)),this._order=e,!1!==r&&this.onChangeCallback(),this}setFromQuaternion(t,e,r){return se.makeRotationFromQuaternion(t),this.setFromRotationMatrix(se,e,r)}set(t,e,r,s){return this._x=t,this._y=e,this._z=r,this._order=s||this._order,this.onChangeCallback(),this}setFromVector3(t,e){return this.set(t.x,t.y,t.z,e||this._order)}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this.onChangeCallback(),this}toArray(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}toVector3(t){return t?t.set(this._x,this._y,this._z):new Wt(this._x,this._y,this._z)}}ie.defaultOrder=re.XYZ;const ne=new Wt;let ae=0;const oe=1e-6;class he{constructor(t,e,r,s){this.onChangeCallback=()=>{},this._x=t||0,this._y=t||0,this._z=r||0,this._w=s||1}get x(){return this._x}get y(){return this._y}get z(){return this._z}get w(){return this._w}set x(t){this._x=t,this.onChangeCallback()}set y(t){this._y=t,this.onChangeCallback()}set z(t){this._z=t,this.onChangeCallback()}set w(t){this._w=t,this.onChangeCallback()}set(t,e,r,s){return this._x=t,this._y=e,this._z=r,this._w=s,this.onChangeCallback(),this}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this.onChangeCallback(),this}clone(){return new he(this._x,this._y,this._z,this._w)}inverse(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this.onChangeCallback(),this}setFromAxisAngle(t,e){const r=e/2,s=Math.sin(r);return this._x=t.x*s,this._y=t.y*s,this._z=t.z*s,this._w=Math.cos(r),this.onChangeCallback(),this}setFromUnitVectors(t,e){return ae=t.dot(e)+1,ae<oe?(ae=0,Math.abs(t.x)>Math.abs(t.z)?ne.set(-t.y,t.x,0):ne.set(0,-t.z,t.y)):ne.crossVectors(t,e),this._x=ne.x,this._y=ne.y,this._z=ne.z,this._w=ae,this.onChangeCallback(),this.normalize()}setFromRotationMatrix(t){const e=t.elements,r=e[0],s=e[4],i=e[8],n=e[1],a=e[5],o=e[9],h=e[2],c=e[6],l=e[10],u=r+a+l;let d;return u>0?(d=.5/Math.sqrt(u+1),this._w=.25/d,this._x=(c-o)*d,this._y=(i-h)*d,this._z=(n-s)*d):r>a&&r>l?(d=2*Math.sqrt(1+r-a-l),this._w=(c-o)/d,this._x=.25*d,this._y=(s+n)/d,this._z=(i+h)/d):a>l?(d=2*Math.sqrt(1+a-r-l),this._w=(i-h)/d,this._x=(s+n)/d,this._y=.25*d,this._z=(o+c)/d):(d=2*Math.sqrt(1+l-r-a),this._w=(n-s)/d,this._x=(i+h)/d,this._y=(o+c)/d,this._z=.25*d),this.onChangeCallback(),this}setFromEuler(t,e){var r=t._x,s=t._y,i=t._z,n=t.order,a=Math.cos,o=Math.sin,h=a(r/2),c=a(s/2),l=a(i/2),u=o(r/2),d=o(s/2),p=o(i/2);return n===re.XYZ?(this._x=u*c*l+h*d*p,this._y=h*d*l-u*c*p,this._z=h*c*p+u*d*l,this._w=h*c*l-u*d*p):n===re.YXZ?(this._x=u*c*l+h*d*p,this._y=h*d*l-u*c*p,this._z=h*c*p-u*d*l,this._w=h*c*l+u*d*p):n===re.ZXY?(this._x=u*c*l-h*d*p,this._y=h*d*l+u*c*p,this._z=h*c*p+u*d*l,this._w=h*c*l-u*d*p):n===re.ZYX?(this._x=u*c*l-h*d*p,this._y=h*d*l+u*c*p,this._z=h*c*p-u*d*l,this._w=h*c*l+u*d*p):n===re.YZX?(this._x=u*c*l+h*d*p,this._y=h*d*l+u*c*p,this._z=h*c*p-u*d*l,this._w=h*c*l-u*d*p):n===re.XZY&&(this._x=u*c*l-h*d*p,this._y=h*d*l-u*c*p,this._z=h*c*p+u*d*l,this._w=h*c*l+u*d*p),!1!==e&&this.onChangeCallback(),this}}class ce{constructor(t,e){this.x=t||0,this.y=e||0}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}clone(){return new ce(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}equals(t){return t.x===this.x&&t.y===this.y}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}sub(t){return this.x-=t.x,this.y-=t.y,this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthManhattan(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}clampScalar(t,e){return le.set(t,t),ue.set(e,e),this.clamp(le,ue)}clampLength(t,e){var r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(t,Math.min(e,r)))}rotate(t,e){e=e||new ce;const r=e.sub(this).multiplyScalar(-1),s=r.x,i=r.y,n=Math.cos(t),a=Math.sin(t);return this.x=s*n-i*a,this.y=s*a+i*n,this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}lengthSq(){return this.x*this.x+this.y*this.y}angle(){var t=Math.atan2(this.y,this.x);return t<0&&(t+=2*Math.PI),t}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){var e=this.x-t.x,r=this.y-t.y;return e*e+r*r}distanceToManhattan(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,r){return this.subVectors(e,t).multiplyScalar(r).add(t)}rotateAround(t,e){var r=Math.cos(e),s=Math.sin(e),i=this.x-t.x,n=this.y-t.y;return this.x=i*r-n*s+t.x,this.y=i*s+n*r+t.y,this}fromArray(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this}toArray(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t}static flatten(t,e){return t.toArray(e,0)}}const le=new ce,ue=new ce;var de;(function(t){t[t["float"]=0]="float",t[t["floatVec2"]=1]="floatVec2",t[t["floatVec3"]=2]="floatVec3",t[t["floatVec4"]=3]="floatVec4",t[t["int"]=4]="int",t[t["intVec2"]=5]="intVec2",t[t["intVec3"]=6]="intVec3",t[t["intVec4"]=7]="intVec4",t[t["Mat2"]=8]="Mat2",t[t["Mat3"]=9]="Mat3",t[t["Mat4"]=10]="Mat4",t[t["boolean"]=11]="boolean",t[t["sampler2D"]=12]="sampler2D"})(de||(de={}));const pe={float:de.float,vec2:de.floatVec2,vec3:de.floatVec3,vec4:de.floatVec4,mat2:de.Mat2,mat3:de.Mat3,mat4:de.Mat4,sampler2D:de.sampler2D};let fe={};Object.keys(pe).forEach(t=>{fe[pe[t]]=t});const me={float:{type:de.float,stride:1,default:0},vec2:{type:de.floatVec2,stride:2,default:new ce},vec3:{type:de.floatVec3,stride:3,default:new Wt},vec4:{type:de.floatVec4,stride:4,default:new Ht}};let ge={};function ve(t){return fe[t]}function xe(t){return ge[t].stride}function we(t){return ge[t].name}function ye(t,e){let r="";return r+=Me(t),r+=Ce(t),r+=Se(t),r+e}function _e(t,e){let r="";return r+="precision highp float;\n",r+=Ce(t),r+=Se(t),r+=be(t),r+e}function be(t){let e="";return void 0!==t.textures&&t.textures.forEach(t=>{e=e+"uniform sampler2D "+t.name+";\n"}),e}function Me(t){let e="";return void 0!==t.attributes&&t.attributes.forEach(t=>{const r=we(t.type);e=e+"attribute "+r+" "+t.name+";\n"}),e}function Ce(t){let e="";if(void 0!==t.uniforms)for(const r in t.uniforms){const s=t.uniforms[r],i=ve(s.type);e=e+"uniform "+i+" "+s.name+";\n"}return e}function Se(t){let e="";return void 0!==t.varyings&&t.varyings.forEach(t=>{const r=ve(t.type);e=e+"varying "+r+" "+t.name+";\n"}),e}function Ee(t){switch(t){case de.float:return Te;case de.floatVec2:return Ae;case de.floatVec3:return Re;case de.floatVec4:return Pe;case de.Mat2:return Ne;case de.Mat3:return Oe;case de.Mat4:return Fe;case de.int:case de.boolean:return ze}throw"uniform setter not found"}function Te(t,e,r){t.uniform1f(e,r)}function Ae(t,e,r){t.uniform2fv(e,r)}function Re(t,e,r){t.uniform3fv(e,r)}function Pe(t,e,r){t.uniform4fv(e,r)}function ze(t,e,r){t.uniform1i(e,r)}function Ne(t,e,r){t.uniformMatrix4fv(e,!1,r)}function Oe(t,e,r){t.uniformMatrix4fv(e,!1,r)}function Fe(t,e,r){t.uniformMatrix4fv(e,!1,r)}function De(t,e){return t!==e}function Ie(t,e){if(t.length!==e.length)return!0;for(let r=0;r<t.length;r++)if(t[r]!==e[r])return!0;return!1}function Le(t,e){return t}function Ve(t,e){let r=e;void 0!==e&&t.length===e.length||(r=[]);for(let s=0;s<t.length;s++)r[s]=t[s];return r}function Ue(t){return t===de.float||t===de.int?De:Ie}function ke(t){return t===de.float||t===de.int?Le:Ve}function Be(t){switch(t){case de.float:return t=>t;case de.floatVec2:return ce.flatten;case de.floatVec3:return Wt.flatten;case de.floatVec4:return Ht.flatten;case de.Mat2:throw"not support yet";case de.Mat3:throw"not support yet";case de.Mat4:return te.flatten}throw"uniform flattener not found"}var Ge;Object.keys(me).forEach(t=>{ge[me[t].type]={name:t,stride:me[t].stride,default:me[t].default}}),function(t){t[t["MMatrix"]=0]="MMatrix",t[t["VPMatrix"]=1]="VPMatrix",t[t["LastVPMatrix"]=2]="LastVPMatrix"}(Ge||(Ge={}));const je=new Map;function $e(t){const e=je.get(t.mapInner),r={name:t.name,type:e.type,default:e.default,_innerGlobalUniform:t.mapInner};return r}je.set(Ge.MMatrix,{name:"MMatrix",type:de.Mat4,default:new te}),je.set(Ge.VPMatrix,{name:"VPMatrix",type:de.Mat4,default:new te}),je.set(Ge.LastVPMatrix,{name:"LastVPMatrix",type:de.Mat4,default:new te});class qe{constructor(t,e){this.programChangeId=-1,this.name=e.name,this.renderer=t.renderer,this.gl=t.renderer.gl;const r=t.getProgram(),s=this.gl.getUniformLocation(r,e.name);this.isActive=null!==s,this.location=s,this.flattener=void 0!==e.flattener?e.flattener:Be(e.type),this.setter=void 0!==e.setter?e.setter:Ee(e.type),this.differ=void 0!==e.differ?e.differ:Ue(e.type),this.copier=void 0!==e.copier?e.copier:ke(e.type),this.innerGlobal=e._innerGlobalUniform}set(t){if(!this.isActive)return;if(this.receiveData=this.flattener(t,this.receiveData),void 0===this.lastReceiveData)return this.lastReceiveData=this.flattener(t,this.lastReceiveData),this.setter(this.gl,this.location,this.receiveData),void this.renderer.stat.uniformUpload++;let e=!1;this.programChangeId!==this.renderer._programChangeId&&(e=!0,this.programChangeId=this.renderer._programChangeId),this.renderer.enableUniformDiff&&!e?this.differ(this.receiveData,this.lastReceiveData)&&(this.setter(this.gl,this.location,this.receiveData),this.renderer.stat.uniformUpload++,this.lastReceiveData=this.copier(this.receiveData,this.lastReceiveData)):(this.setter(this.gl,this.location,this.receiveData),this.renderer.stat.uniformUpload++)}}var Xe,We,He,Ye,Ze,Qe,Ke,Je,tr;(function(t){t["position"]="position",t["normal"]="normal",t["color"]="color",t["uv"]="uv"})(Xe||(Xe={}));class er{constructor(t,e){this.angleInstanceExt=null,this.asInstance=!1,this.name=e.name,this.gl=t.renderer.gl,this.location=this.gl.getAttribLocation(t.getProgram(),e.name),this.type=e.type,this.isActive=-1!==this.location;const r=t.renderer.glInfo.getExtension(Rt.ANGLE_instanced_arrays);void 0!==r&&(this.angleInstanceExt=r),!0===e.asInstance&&(t.useInstance=!0,this.asInstance=e.asInstance,this.instanceDivisor=e.instanceDivisor)}useBuffer(t){if(!this.isActive)return;const e=this.gl;if(e.bindBuffer(e.ARRAY_BUFFER,t),e.vertexAttribPointer(this.location,xe(this.type),e.FLOAT,!1,0,0),e.enableVertexAttribArray(this.location),this.asInstance){if(null===this.angleInstanceExt)throw"instance not support";this.angleInstanceExt.vertexAttribDivisorANGLE(this.location,this.instanceDivisor)}}}(function(t){t[t["texture2D"]=0]="texture2D"})(We||(We={}));class rr{constructor(t,e){this.webglTexture=null,this.renderer=t.renderer,this.slotManager=t.renderer.state.textureSlot,this.gl=t.renderer.gl,this.name=e.name,this.channel=e.channelType;const r=t.getProgram(),s=this.gl.getUniformLocation(r,e.name);this.isActive=null!==s,this.location=s,this.currentActiveSlot=-1}useTexture(t){if(!this.isActive)return;const e=this.slotManager.updateSlotTexture(t);this.currentActiveSlot!==e&&(this.renderer.stat.uniformUpload++,this.currentActiveSlot=e,this.gl.uniform1i(this.location,e))}}function sr(t){return void 0===t.useIndex&&(t.useIndex=!0),void 0===t.uniforms&&(t.uniforms=[]),void 0!==t.uniformsIncludes&&!0!==t._hasUniformIncludesExpand&&(t.uniformsIncludes.forEach(e=>{t.uniforms.push($e(e))}),t._hasUniformIncludesExpand=!0),t}class ir{constructor(t,e){this.id=Xt(),this.program=null,this.attributes={},this.uniforms={},this.globalUniforms=[],this.textures={},this.framebufferTextureMap={},this.drawFrom=0,this.drawCount=0,this.instanceCount=0,this.useInstance=!1,this.useIndexDraw=!1,this._indexUINT=!1,sr(e),this.renderer=t,this.vertexShader=new Ut(this.renderer,Vt.vertex),this.fragmentShader=new Ut(this.renderer,Vt.fragment),this.compileShaders(e),this.createProgram(this.vertexShader,this.fragmentShader),this.createGLResource(e),void 0!==e.uniformsIncludes&&e.uniformsIncludes.forEach(t=>{this.globalUniforms.push(this.uniforms[t.name])}),this.config=e,void 0!==e.useIndex&&(this.useIndexDraw=e.useIndex),t.programManager.addNewProgram(this)}getProgram(){if(null===this.program)throw"program is broken";return this.program}getConfig(){return this.config}set indexUINT(t){if(t&&!this._indexUINT&&!this.renderer.glInfo.supportUintIndexDraw)throw"your webgl not support uint draw";this._indexUINT=t}defineFrameBufferTextureDep(t,e){this.framebufferTextureMap[e]=t}forUniforms(t){for(const e in this.textures)t(this.uniforms[e])}forTextures(t){for(const e in this.textures)t(this.textures[e])}forAttributes(t){for(const e in this.attributes)t(this.attributes[e])}compileShaders(t){let e=t.vertexShaderString,r=t.fragmentShaderString;t.autoInjectHeader&&(e=ye(t,t.vertexShaderString),r=_e(t,t.fragmentShaderString)),this.vertexShader.compileShader(e),this.fragmentShader.compileShader(r)}createProgram(t,e){const r=this.renderer.gl,s=r.createProgram();if(null===s)throw"webgl program create failed";if(this.program=s,r.attachShader(this.program,t.shader),r.attachShader(this.program,e.shader),r.linkProgram(this.program),!r.getProgramParameter(this.program,r.LINK_STATUS)){let t=r.getProgramInfoLog(this.program);throw"Could not compile WebGL program. \n\n"+t}}createGLResource(t){void 0!==t.attributes&&t.attributes.forEach(t=>{this.attributes[t.name]=new er(this,t)}),void 0!==t.uniforms&&t.uniforms.forEach(t=>{this.uniforms[t.name]=new qe(this,t)}),void 0!==t.textures&&t.textures.forEach(t=>{this.textures[t.name]=new rr(this,t)})}updateAttribute(t,e){const r=this.attributes[t];if(void 0===r)throw"try to set a none exist attribute";r.useBuffer(e)}setTexture(t,e){this.textures[t].useTexture(e)}setDrawRange(t,e){this.drawFrom=t,this.drawCount=e}setUniform(t,e){this.uniforms[t].set(e)}setUniformIfExist(t,e){const r=this.uniforms[t];void 0!==r&&this.uniforms[t].set(e)}updateInnerGlobalUniforms(t){this.globalUniforms.forEach(e=>{e.set(t.getGlobalUniform(e.innerGlobal).value)})}useIndexBuffer(t){const e=this.renderer.gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t)}dispose(){this.vertexShader.dispose(),this.fragmentShader.dispose(),this.renderer.gl.deleteProgram(this.program)}}class nr{constructor(){this.programs=new Map}addNewProgram(t){this.programs.set(t.id,t)}getProgram(t){return this.programs.get(t)}get compiledProgramsCount(){return this.programs.size}releaseGL(){this.programs.forEach(t=>{t.dispose()}),this.programs=new Map}}class ar{constructor(t){this.buffers=new WeakMap,this.renderer=t}getGLBuffer(t){return this.buffers.get(t)}createBuffer(t,e){const r=this.renderer.gl,s=r.createBuffer();if(null===s)throw"webgl buffer create fail";return e?(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,s),r.bufferData(r.ELEMENT_ARRAY_BUFFER,t,r.STATIC_DRAW)):(r.bindBuffer(r.ARRAY_BUFFER,s),r.bufferData(r.ARRAY_BUFFER,t,r.STATIC_DRAW)),this.buffers.set(t,s),s}disposeBuffer(t){if(!this.buffers.has(t))throw"cant find buffer to dispose";const e=this.renderer.gl,r=this.buffers.get(t);e.deleteBuffer(r),this.buffers.delete(t)}updateOrCreateBuffer(t,e){if(!this.buffers.has(t))return this.createBuffer(t,e);this.disposeBuffer(t),this.createBuffer(t,e)}releaseGL(){this.buffers=new WeakMap}}(function(t){t[t["POINTS"]=0]="POINTS",t[t["LINES"]=1]="LINES",t[t["LINES_LOOP"]=2]="LINES_LOOP",t[t["LINES_STRIP"]=2]="LINES_STRIP",t[t["TRIANGLES"]=4]="TRIANGLES",t[t["TRIANGLE_STRIP"]=5]="TRIANGLE_STRIP",t[t["TRIANGLE_FAN"]=6]="TRIANGLE_FAN"})(He||(He={})),function(t){t[t["CullFaceNone"]=0]="CullFaceNone",t[t["CullFaceBack"]=1]="CullFaceBack",t[t["CullFaceFront"]=2]="CullFaceFront",t[t["CullFaceFrontBack"]=3]="CullFaceFrontBack"}(Ye||(Ye={})),function(t){t[t["NeverDepth"]=99]="NeverDepth",t[t["AlwaysDepth"]=1]="AlwaysDepth",t[t["LessDepth"]=2]="LessDepth",t[t["LessEqualDepth"]=3]="LessEqualDepth",t[t["EqualDepth"]=4]="EqualDepth",t[t["GreaterEqualDepth"]=5]="GreaterEqualDepth",t[t["GreaterDepth"]=6]="GreaterDepth",t[t["NotEqualDepth"]=7]="NotEqualDepth"}(Ze||(Ze={})),function(t){t[t["NoBlending"]=0]="NoBlending",t[t["NormalBlending"]=1]="NormalBlending",t[t["AdditiveBlending"]=2]="AdditiveBlending",t[t["SubtractiveBlending"]=3]="SubtractiveBlending",t[t["MultiplyBlending"]=4]="MultiplyBlending",t[t["CustomBlending"]=5]="CustomBlending"}(Qe||(Qe={})),function(t){t[t["texture2D"]=3553]="texture2D",t[t["textureCubeMap"]=34067]="textureCubeMap"}(Ke||(Ke={})),function(t){t[t["nearest"]=9728]="nearest",t[t["linear"]=9729]="linear",t[t["NEAREST_MIPMAP_NEAREST"]=9984]="NEAREST_MIPMAP_NEAREST",t[t["LINEAR_MIPMAP_NEAREST"]=9985]="LINEAR_MIPMAP_NEAREST",t[t["NEAREST_MIPMAP_LINEAR"]=9986]="NEAREST_MIPMAP_LINEAR",t[t["LINEAR_MIPMAP_LINEAR"]=9987]="LINEAR_MIPMAP_LINEAR"}(Je||(Je={})),function(t){t[t["repeat"]=10497]="repeat",t[t["clampToEdge"]=33071]="clampToEdge",t[t["mirroredRepeat"]=33648]="mirroredRepeat"}(tr||(tr={}));var or,hr;(function(t){t[t["FUNC_ADD"]=32774]="FUNC_ADD",t[t["FUNC_SUBTRACT"]=32778]="FUNC_SUBTRACT",t[t["FUNC_REVERSE_SUBTRACT"]=32779]="FUNC_REVERSE_SUBTRACT"})(or||(or={})),function(t){t[t["ZERO"]=0]="ZERO",t[t["ONE"]=1]="ONE",t[t["SRC_COLOR"]=768]="SRC_COLOR",t[t["ONE_MINUS_SRC_COLOR"]=769]="ONE_MINUS_SRC_COLOR",t[t["SRC_ALPHA"]=770]="SRC_ALPHA",t[t["ONE_MINUS_SRC_ALPHA"]=771]="ONE_MINUS_SRC_ALPHA",t[t["DST_ALPHA"]=772]="DST_ALPHA",t[t["ONE_MINUS_DST_ALPHA"]=773]="ONE_MINUS_DST_ALPHA",t[t["DST_COLOR"]=774]="DST_COLOR",t[t["ONE_MINUS_DST_COLOR"]=775]="ONE_MINUS_DST_COLOR",t[t["SRC_ALPHA_SATURATE"]=776]="SRC_ALPHA_SATURATE",t[t["CONSTANT_COLOR"]=32769]="CONSTANT_COLOR",t[t["ONE_MINUS_CONSTANT_COLOR"]=32770]="ONE_MINUS_CONSTANT_COLOR",t[t["CONSTANT_ALPHA"]=32771]="CONSTANT_ALPHA",t[t["ONE_MINUS_CONSTANT_ALPHA"]=32772]="ONE_MINUS_CONSTANT_ALPHA"}(hr||(hr={}));var cr,lr,ur=204,dr=205;(function(t){t[t["Alpha"]=6406]="Alpha",t[t["RGB"]=6407]="RGB",t[t["RGBA"]=6408]="RGBA"})(cr||(cr={})),function(t){t[t["UNSIGNED_BYTE"]=5121]="UNSIGNED_BYTE",t[t["UNSIGNED_SHORT_5_6_5"]=32819]="UNSIGNED_SHORT_5_6_5",t[t["UNSIGNED_SHORT_4_4_4_4"]=32820]="UNSIGNED_SHORT_4_4_4_4",t[t["UNSIGNED_SHORT_5_5_5_1"]=33635]="UNSIGNED_SHORT_5_5_5_1",t[t["FLOAT"]=33636]="FLOAT"}(lr||(lr={}));class pr{constructor(t){this.redMaskEnabled=!1,this.greenMaskEnabled=!1,this.blueMaskEnabled=!1,this.alphaMaskEnabled=!1,this.currentClearColor=new Ht,this.gl=t.gl,this.resetDefaultClearColor()}setColorMask(t,e,r,s){this.redMaskEnabled===t&&this.greenMaskEnabled===e&&this.blueMaskEnabled===r&&this.alphaMaskEnabled===s||(this.gl.colorMask(t,e,r,s),this.redMaskEnabled=t,this.greenMaskEnabled=e,this.blueMaskEnabled=r,this.alphaMaskEnabled=s)}setClearColor(t,e){t.equals(this.currentClearColor)||(this.currentClearColor.copy(t),this.gl.clearColor(t.x,t.y,t.z,t.w))}resetDefaultClearColor(){this.setClearColor(pr.defaultClearColor)}clear(){this.gl.clear(this.gl.COLOR_BUFFER_BIT)}}pr.defaultClearColor=new Ht(.8,.8,.8,1);class fr{constructor(t){this.currentDepthMask=null,this.currentDepthFunc=null,this.currentDepthClear=null,this._enableTest=!1,this.gl=t.gl,this.resetDefault()}set enableTest(t){this._enableTest!==t&&(t?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST))}get enableTest(){return this._enableTest}clear(){this.gl.clear(this.gl.DEPTH_BUFFER_BIT)}resetDefault(){this.enableTest=!0}setMask(t){this.currentDepthMask!==t&&(this.gl.depthMask(t),this.currentDepthMask=t)}setFunc(t){const e=this.gl;if(this.currentDepthFunc!==t){if(t)switch(t){case Ze.NeverDepth:e.depthFunc(e.NEVER);break;case Ze.AlwaysDepth:e.depthFunc(e.ALWAYS);break;case Ze.LessDepth:e.depthFunc(e.LESS);break;case Ze.LessEqualDepth:e.depthFunc(e.LEQUAL);break;case Ze.EqualDepth:e.depthFunc(e.EQUAL);break;case Ze.GreaterEqualDepth:e.depthFunc(e.GEQUAL);break;case Ze.GreaterDepth:e.depthFunc(e.GREATER);break;case Ze.NotEqualDepth:e.depthFunc(e.NOTEQUAL);break;default:e.depthFunc(e.LEQUAL)}else e.depthFunc(e.LEQUAL);this.currentDepthFunc=t}}}class mr{constructor(t){this.currentTextureSlot=null,this.currentBindTextures=[],this.slotIndex=0,this.renderer=t,this.gl=t.gl,this.maxSupport=t.glInfo.getParameter(Pt.MAX_TEXTURE_SIZE),vr(this.maxSupport,this.gl)}activeTexture(t){this.currentTextureSlot!==t&&(this.gl.activeTexture(t),this.currentTextureSlot=t)}bindTexture(t,e){null===this.currentTextureSlot&&this.activeTexture(this.gl.TEXTURE0);let r=this.currentBindTextures[this.currentTextureSlot];void 0===r&&(r={type:void 0,texture:void 0},this.currentBindTextures[this.currentTextureSlot]=r),r.type===t&&r.texture===e||(this.gl.bindTexture(t,e),r.type=t,r.texture=e)}resetSlotIndex(){this.slotIndex=0}findSlot(t){let e=this.slotIndex;if(this.slotIndex>this.maxSupport)throw"texture use exceed max texture support";return this.slotIndex++,e}updateSlotTexture(t){const e=this.findSlot(t),r=gr[e];return this.activeTexture(r),this.bindTexture(Ke.texture2D,t),e}}const gr=[];function vr(t,e){for(let r=0;r<t;r++){const t=`TEXTURE${r}`;gr[r]=e[t]}}class xr{constructor(t){this.currentViewport=new Ht,this.newViewport=new Ht,this.currentScissor=new Ht,this.newScissor=new Ht,this.currentCullFace=Ye.CullFaceNone,this.currentPolygonOffsetFactor=0,this.currentPolygonOffsetUnits=0,this.renderer=t,this.gl=t.gl,this.colorbuffer=new pr(t),this.depthbuffer=new fr(t),this.textureSlot=new mr(t)}setViewport(t,e,r,s){this.newViewport.set(t,e,r,s),this.newViewport.equals(this.currentViewport)||(this.gl.viewport(t,e,r,s),this.currentViewport.copy(this.newViewport))}setFullScreenViewPort(){this.setViewport(0,0,this.renderer.width,this.renderer.height)}setScissor(t,e,r,s){this.newScissor.set(t,e,r,s),this.newScissor.equals(this.currentScissor)||(this.gl.viewport(t,e,r,s),this.currentScissor.copy(this.newScissor))}setCullFace(t){const e=this.gl;t!==Ye.CullFaceNone?(e.enable(e.CULL_FACE),t!==this.currentCullFace&&(t===Ye.CullFaceBack?e.cullFace(e.BACK):t===Ye.CullFaceFront?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):e.disable(e.CULL_FACE),this.currentCullFace=t}setPolygonOffset(t,e,r){const s=this.gl;t?(s.enable(s.POLYGON_OFFSET_FILL),this.currentPolygonOffsetFactor===e&&this.currentPolygonOffsetUnits===r||(s.polygonOffset(e,r),this.currentPolygonOffsetFactor=e,this.currentPolygonOffsetUnits=r)):s.disable(s.POLYGON_OFFSET_FILL)}}const wr={minFilter:Je.nearest,maxFilter:Je.nearest,sWrap:tr.clampToEdge,tWrap:tr.clampToEdge},yr=wr;class _r{constructor(t){this.textures=new Map,this.renderer=t,this.POTResizeCanvas=document.createElement("canvas")}init(){const t=this.renderer.gl;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0)}getGLTexture(t){return this.textures.get(t)}deleteGLTexture(t){const e=this.getGLTexture(t);this.renderer.gl.deleteTexture(e),this.textures.delete(t)}createTextureFromImageElement(t){const e=this.renderer.gl,r=this.createWebGLTexture(wr);return e.bindTexture(e.TEXTURE_2D,r),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t.image),this.textures.set(t,r),r}createTextureForRenderTarget(t){const e=this.renderer.gl,r=this.createWebGLTexture(yr);e.bindTexture(e.TEXTURE_2D,r);const s=e.RGBA,i=0,n=e.RGBA,a=e.UNSIGNED_BYTE,o=null;return e.texImage2D(e.TEXTURE_2D,0,s,t.width,t.height,i,n,a,o),this.textures.set(t,r),r}createWebGLTexture(t){const e=this.renderer.gl,r=e.createTexture();if(null===r)throw"webgl texture create fail";return e.bindTexture(e.TEXTURE_2D,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,t.minFilter),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,t.maxFilter),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,t.sWrap),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,t.tWrap),r}releaseGL(){}}var br,Mr;(function(t){t[t["AlphaFormat"]=1021]="AlphaFormat",t[t["RGBFormat"]=1022]="RGBFormat",t[t["RGBAFormat"]=1023]="RGBAFormat"})(br||(br={})),function(t){t[t["UNSIGNED_BYTE"]=0]="UNSIGNED_BYTE",t[t["UNSIGNED_SHORT_5_6_5"]=1]="UNSIGNED_SHORT_5_6_5",t[t["UNSIGNED_SHORT_4_4_4_4"]=2]="UNSIGNED_SHORT_4_4_4_4",t[t["UNSIGNED_SHORT_5_5_5_1"]=3]="UNSIGNED_SHORT_5_5_5_1",t[t["FLOAT"]=4]="FLOAT"}(Mr||(Mr={}));class Cr{constructor(){this.needUpdate=!0,this.format=br.RGBAFormat,this.dataType=Mr.UNSIGNED_BYTE}setNeedUpdate(){this.needUpdate=!0}getGLTexture(t){const e=t.renderer.textureManger.getGLTexture(this);return void 0===e?(this.needUpdate=!1,this.upload(t)):this.needUpdate?(this.needUpdate=!1,this.releaseGraphics(t),this.upload(t)):void 0}releaseGraphics(t){t.renderer.textureManger.deleteGLTexture(this)}}class Sr extends Cr{constructor(){super(...arguments),this.width=5,this.height=5}upload(t){return t.renderer.textureManger.createTextureForRenderTarget(this)}attach(t,e,r){t.renderer.setRenderTarget(e);const s=e.gl;this.width=e.width,this.height=e.height,this.releaseGraphics(t);const i=this.upload(t),n=Er[r];s.framebufferTexture2D(s.FRAMEBUFFER,n,s.TEXTURE_2D,i,0)}}const Er=[];function Tr(t){if(0===Er.length)for(let e=0;e<32;e++)Er[e]=t["COLOR_ATTACHMENT"+e]}class Ar{constructor(t,e,r,s){this.enableDepth=!0,this.webglDepthBuffer=null,this.textureAttachedSlot=[],this.name=e,this.renderer=t,this.gl=t.gl,Tr(this.gl),this.webglFrameBuffer=this.createGLFramebuffer(),this.width=r,this.height=s}createGLFramebuffer(){const t=this.gl.createFramebuffer();if(null===t)throw"webgl framebuffer create failed";return t}createGLRenderbuffer(){const t=this.gl.createRenderbuffer();if(null===t)throw"webgl renderbuffer create failed";return t}resize(t,e,r){this.width===e&&this.height===r||(this.width=e,this.height=r,this.gl.deleteFramebuffer(this.webglFrameBuffer),this.webglFrameBuffer=this.createGLFramebuffer(),this.renderer.setRenderTarget(this),this.textureAttachedSlot.forEach((e,r)=>{e&&e.attach(t,this,r)}),this.disposeAttachedDepthBuffer(),this.createAttachDepthBuffer())}createAttachTexture(t,e){if(void 0!==this.textureAttachedSlot[e])throw"framebuffer has attached texture";const r=new Sr;r.attach(t,this,e),this.textureAttachedSlot[e]=r}createAttachDepthBuffer(){if(this.renderer.setRenderTarget(this),null!==this.webglDepthBuffer)return;const t=this.gl,e=this.createGLRenderbuffer();this.webglDepthBuffer=e,t.bindRenderbuffer(t.RENDERBUFFER,e),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.width,this.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,e)}disposeAttachedDepthBuffer(){this.gl.deleteRenderbuffer(this.webglDepthBuffer),this.webglDepthBuffer=null}attachTexture(t,e){}readPixels(t,e,r,s,i){const n=this.gl;if(this.renderer.setRenderTarget(this),t<0||e<0||t>this.width-r||e>this.height-s)throw"read area exceed frameSize";if(i.length<r*s)throw"readBuffer size not sufficient";n.readPixels(t,e,r,s,cr.RGBA,n.UNSIGNED_BYTE,i)}dispose(){this.textureAttachedSlot=[],this.disposeAttachedDepthBuffer(),this.gl.deleteFramebuffer(this.webglFrameBuffer),this.webglFrameBuffer=null}}class Rr{constructor(t){this.framebuffers=new Map,this.renderer=t,this.gl=t.gl}createFrameBuffer(t,e,r,s,i){if(this.framebuffers.has(e))throw"duplicate framebuffer key name";const n=new Ar(this.renderer,e,r,s);return n.createAttachTexture(t,0),n.enableDepth=i,i&&n.createAttachDepthBuffer(),this.framebuffers.set(e,n),n}getFramebuffer(t){return this.framebuffers.get(t)}getFramebufferTexture(t){const e=this.framebuffers.get(t);if(void 0===e)throw`cant find framebuffer ${t}`;return this.renderer.textureManger.getGLTexture(e.textureAttachedSlot[0])}releaseGL(){}}class Pr{constructor(){this.drawcall=0,this.programSwitch=0,this.uniformUpload=0,this.framebufferSwitch=0,this.faceDraw=0,this.vertexDraw=0}reset(){this.drawcall=0,this.programSwitch=0,this.uniformUpload=0,this.framebufferSwitch=0,this.faceDraw=0,this.vertexDraw=0}}class zr{constructor(t){this.vaos=new WeakMap,this.renderer=t,this.gl=t.gl,this.vaoExt=t.glInfo.getExtension(Rt.OES_vertex_array_object),this.isSupported=void 0!==this.vaoExt}getVAO(t){return this.vaos.get(t)}createVAO(t){const e=this.vaoExt.createVertexArrayOES();return this.vaoExt.bindVertexArrayOES(e),this.vaos.set(t,e),{vao:e,unbind:()=>{this.vaoExt.bindVertexArrayOES(null)}}}deleteVAO(t){this.vaos.delete(t)}useVAO(t){this.vaoExt.bindVertexArrayOES(t)}releaseGL(){this.vaoExt.bindVertexArrayOES(null),this.vaos=new WeakMap}}class Nr{constructor(t,e){this.angleInstanceExt=null,this.enableRenderErrorCatch=!1,this.enableUniformDiff=!0,this._width=100,this._height=100,this.devicePixelRatio=window.devicePixelRatio,this.stat=new Pr,this.activeProgram=null,this._programChangeId=0,this.programManager=new nr,this.textureManger=new _r(this),this.attributeBufferManager=new ar(this),this.currentFramebuffer=null,void 0===t&&(t=document.createElement("canvas")),e=Object.assign({},e),e.antialias=!1;const r=t.getContext("webgl",e);if(null===r)throw"webgl context create failed";this.gl=r,this.el=t,this.glInfo=new Lt(r),this.framebufferManager=new Rr(this),this.vaoManager=new zr(this),this.state=new xr(this),this.textureManger.init();const s=this.glInfo.getExtension(Rt.ANGLE_instanced_arrays);void 0!==s&&(this.angleInstanceExt=s),this.setSize(this.el.offsetWidth,this.el.offsetHeight)}get width(){return this._width}get height(){return this._height}setSize(t,e){return this.setRawRenderSize(t*this.devicePixelRatio,e*this.devicePixelRatio)}setRawRenderSize(t,e){let r=this._width!==t||this._height!==e;return this._width=t,this._height=e,this.el.width=this._width,this.el.height=this._height,this.state.setViewport(0,0,t,e),r}createProgram(t){const e=new ir(this,t);return this.programManager.addNewProgram(e),e}getProgram(t){return this.programManager.getProgram(t)}useProgram(t){this.activeProgram!==t&&(this.stat.programSwitch++,this.activeProgram=t,this._programChangeId++,this.gl.useProgram(t.getProgram()))}draw(t){const e=this.activeProgram;if(null===e)throw"renderer hasn't active program";if(e.useInstance){if(null===this.angleInstanceExt)throw"instance not support";e.useIndexDraw?this.angleInstanceExt.drawElementsInstancedANGLE(t,e.drawCount,e._indexUINT?this.gl.UNSIGNED_INT:this.gl.UNSIGNED_SHORT,e.drawFrom,e.instanceCount):this.angleInstanceExt.drawArraysInstancedANGLE(t,e.drawFrom,e.drawCount,e.instanceCount)}else e.useIndexDraw?this.gl.drawElements(t,e.drawCount,e._indexUINT?this.gl.UNSIGNED_INT:this.gl.UNSIGNED_SHORT,e.drawFrom):this.gl.drawArrays(t,e.drawFrom,e.drawCount);this.enableRenderErrorCatch&&this.checkGLError(),this.state.textureSlot.resetSlotIndex(),this.stat.drawcall++,t===He.TRIANGLES&&(this.stat.faceDraw+=e.drawCount/3*e.instanceCount,this.stat.vertexDraw+=e.drawCount*e.instanceCount)}checkGLError(){const t=this.gl.getError();if(t!==this.gl.NO_ERROR)throw`gl draw error: ${t}`}setRenderTarget(t){if(this.currentFramebuffer!==t){this.stat.framebufferSwitch++,this.currentFramebuffer=t;const e=this.gl;null===t?e.bindFramebuffer(e.FRAMEBUFFER,null):e.bindFramebuffer(e.FRAMEBUFFER,t.webglFrameBuffer)}}setRenderTargetScreen(){this.setRenderTarget(null)}releaseGL(){this.attributeBufferManager.releaseGL(),this.programManager.releaseGL(),this.textureManger.releaseGL(),this.framebufferManager.releaseGL(),this.vaoManager.releaseGL()}}class Or extends Wt{constructor(t,e,r){super(),this.onChange=()=>{},this._x=t||0,this._y=e||0,this._z=r||0}get x(){return this._x}set x(t){this.onChange&&this.onChange(),this._x=t}get y(){return this._y}set y(t){this.onChange&&this.onChange(),this._y=t}get z(){return this._z}set z(t){this.onChange&&this.onChange(),this._z=t}}const Fr=new Wt,Dr=new te;class Ir{constructor(){this.transformFrameChanged=!0,this._matrix=new te,this.matrixIsDirty=!0,this._position=new Or,this.positionIsDirty=!1,this._scale=new Or(1,1,1),this.scaleIsDirty=!1,this._rotation=new ie,this.eulerIsDirty=!1,this._quaternion=new he,this.quaternionIsDirty=!1,this._position.onChange=()=>{this.matrixIsDirty=!0,this.transformFrameChanged=!0},this._scale.onChange=()=>{this.matrixIsDirty=!0,this.transformFrameChanged=!0},this._rotation.onChangeCallback=()=>{this.matrixIsDirty=!0,this.transformFrameChanged=!0,this._quaternion.setFromEuler(this._rotation,!1)},this._quaternion.onChangeCallback=()=>{this.matrixIsDirty=!0,this.transformFrameChanged=!0,this._rotation.setFromQuaternion(this._quaternion,this._rotation.order,!1)}}notifyMatrixChange(){this.matrixIsDirty=!1,this.positionIsDirty=!0,this.scaleIsDirty=!0,this.eulerIsDirty=!0,this.quaternionIsDirty=!0}get matrix(){return this.matrixIsDirty&&this._matrix.compose(this._position,this._quaternion,this._scale),this._matrix}get position(){return this.positionIsDirty&&(this._position._x=this._matrix.elements[12],this._position._y=this._matrix.elements[13],this._position._z=this._matrix.elements[14],this.positionIsDirty=!1),this._position}get scale(){return this.scaleIsDirty&&(Fr.set(this._matrix.elements[0],this._matrix.elements[1],this._matrix.elements[2]),this._scale._x=Fr.length(),Fr.set(this._matrix.elements[4],this._matrix.elements[5],this._matrix.elements[6]),this._scale._x=Fr.length(),Fr.set(this._matrix.elements[8],this._matrix.elements[9],this._matrix.elements[10]),this._scale._x=Fr.length(),this.scaleIsDirty=!1),this._scale}get rotation(){return this.eulerIsDirty&&(this._rotation.setFromQuaternion(this.quaternion,ie.defaultOrder,!1),this.eulerIsDirty=!1),this._rotation}get quaternion(){return this.quaternionIsDirty&&(Dr.copy(this._matrix),Dr.scale(1/this.scale.x,1/this.scale.y,1/this.scale.z),this._quaternion.setFromRotationMatrix(Dr),this.quaternionIsDirty=!1),this._quaternion}}class Lr{constructor(){this.uuid=Xt(),this.scene=null,this.sceneNodeListIndex=-1,this.parent=null,this.children=[],this.transform=new Ir,this._worldMatrix=new te,this._worldMatrixUpdateFrameId=0,this._visible=!0,this._visibleNet=!0,this._visibleUpdateFrameId=0}get worldMatrix(){return this._worldMatrix}set visible(t){this._visible=t,null!==this.scene&&(this.scene.isFrameVisibleChange=!0)}get visible(){return this._visible}addChild(t){if(t===this)throw"Cant add a scene node to it self";return null!==this.scene&&(this.scene.isFrameStructureChange=!0,this.scene.addNode(t)),null!==t.parent&&t.parent.removeChild(t),t.parent=this,this.children.push(t),this}removeChild(t){null!==this.scene&&(this.scene.isFrameStructureChange=!0,this.scene.removeNode(t));let e=this.children.indexOf(t);return-1!==e&&(t.parent=null,this.children.splice(e,1)),this}traverse(t){function e(r){if(!1!==t(r))for(let t=0;t<r.children.length;t++)e(r.children[t])}return e(this),this}traversePair(t){function e(r,s){const i=t(r,s);for(let t=0;t<s.children.length;t++)e(s,s.children[t]);return i}return e(this.parent,this)}map(t){const e=new Map,r=this.traversePair((r,s)=>{const i=t(s);if(e.set(s,i),null!==r&&e.has(r)){const t=e.get(r);if(void 0===t)throw"tree map error: cant find mapped parent";t.children.push(i)}return i});return r}findSubNode(t){let e=null;return this.traverse(r=>{if(r.uuid===t)return e=r,!1}),e}updateWorldMatrix(t){(this.transform.transformFrameChanged||t)&&(null===this.parent?this.worldMatrix.copy(this.transform.matrix):this.worldMatrix.multiplyMatrices(this.parent.worldMatrix,this.transform.matrix),this.transform.transformFrameChanged=!1,t=!0);for(var e=this.children,r=0,s=e.length;r<s;r++)e[r].updateWorldMatrix(t);return this}}class Vr extends Lr{constructor(){super(),this.projectionMatrix=new te,this.projectionMatrixNeedUpdate=!1,this.renderSizeObserver=null}updateProjectionMatrix(){}onRenderResize(t){}bindEngineRenderSize(t){null!==this.renderSizeObserver&&t.resizeObservable.remove(this.renderSizeObserver),this.renderSizeObserver=t.resizeObservable.add(this.onRenderResize)}}const Ur=new te;class kr extends Vr{constructor(t,e,r,s,i){super(),this.up=new Wt(0,1,0),this._fov=void 0!==r?r:50,this._zoom=1,this._near=void 0!==t?t:.1,this._far=void 0!==e?e:2e3,this._aspect=void 0!==s?s:1,this.updateProjectionMatrix()}get near(){return this._near}set near(t){this._near=t,this.projectionMatrixNeedUpdate=!0}get far(){return this._far}set far(t){this._far=t,this.projectionMatrixNeedUpdate=!0}get fov(){return this._fov}set fov(t){this._fov=t,this.projectionMatrixNeedUpdate=!0}get aspect(){return this._aspect}set aspect(t){this._aspect=t,this.projectionMatrixNeedUpdate=!0}get zoom(){return this._zoom}set zoom(t){this._zoom=t,this.projectionMatrixNeedUpdate=!0}get width(){return this._aspect*this.height}get height(){return 2*this._near*Math.tan(.5*ee.DEG2RAD*this._fov)/this._zoom}updateProjectionMatrix(){const t=this._near*Math.tan(.5*ee.DEG2RAD*this._fov)/this._zoom,e=2*t,r=this._aspect*e,s=-.5*r;this.projectionMatrix.makePerspective(s,s+r,t,t-e,this._near,this._far),this.projectionMatrixNeedUpdate=!1}lookAt(t){Ur.lookAt(this.transform.position,t,this.up),this.transform.quaternion.setFromRotationMatrix(Ur)}updateRaycaster(t,e,r){t.worldRay.origin.setFromMatrixPosition(this.worldMatrix),t.worldRay.direction.set(e,r,.5).unProject(this.worldMatrix,this.projectionMatrix).sub(t.worldRay.origin).normalize()}}class Br{constructor(t){this._needUpdate=!0,this._value=t}setValue(t){this._value=t,this._needUpdate=!0}setValueNeedUpdate(){this._needUpdate=!0}get value(){return this._value}resetUpdate(){this._needUpdate=!1}}class Gr{constructor(t){this.callback=t,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1}}class jr{constructor(t){this._observers=new Array,t&&(this._onObserverAdded=t)}add(t,e=!1){if(!t)return null;var r=new Gr(t);return r.unregisterOnNextCall=e,this._observers.push(r),this._onObserverAdded&&this._onObserverAdded(r),r}addOnce(t){return this.add(t,!0)}remove(t){if(!t)return!1;var e=this._observers.indexOf(t);return-1!==e&&(this._deferUnregister(t),!0)}_deferUnregister(t){t.unregisterOnNextCall=!1,t._willBeUnregistered=!0,setTimeout(()=>{this._remove(t)},0)}_remove(t){if(!t)return!1;var e=this._observers.indexOf(t);return-1!==e&&(this._observers.splice(e,1),!0)}notifyObservers(t){if(0===this._observers.length)return!0;for(var e of this._observers)e._willBeUnregistered||(e.callback(t),e.unregisterOnNextCall&&this._deferUnregister(e));return!0}notifyObserver(t,e){t.callback(e)}hasObservers(){return this._observers.length>0}clear(){this._observers=new Array,this._onObserverAdded=null}clone(){var t=new jr;return t._observers=this._observers.slice(0),t}}class $r{constructor(){this.cullSide=Ye.CullFaceBack,this.blending=Qe.NormalBlending,this.blendSrc=ur,this.blendDst=dr,this.blendEquation=or.FUNC_ADD,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=Ze.LessEqualDepth,this.depthTest=!0,this.depthWrite=!0,this.colorWriteR=!0,this.colorWriteG=!0,this.colorWriteB=!0,this.colorWriteA=!0,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.alphaTest=0,this.premultipliedAlpha=!1}syncGL(t){t.state.setCullFace(this.cullSide);const e=t.state.depthbuffer;e.enableTest=this.depthTest,e.setFunc(this.depthFunc),e.setMask(this.depthWrite);const r=t.state.colorbuffer;r.setColorMask(this.colorWriteR,this.colorWriteG,this.colorWriteB,this.colorWriteA),t.state.setPolygonOffset(this.polygonOffset,this.polygonOffsetFactor,this.polygonOffsetUnits)}}class qr{constructor(t,e){this.start=0,this.count=0,this.instanceCount=1,void 0!==t&&(this.start=t),void 0!==e&&(this.count=e)}static fromStandardGeometry(t){return new qr(0,t.indexBuffer.count)}setRange(t,e){this.start=t,this.count=e}}var Xr;(function(t){t[t["triangle"]=0]="triangle",t[t["point"]=1]="point",t[t["lineSegment"]=2]="lineSegment"})(Xr||(Xr={}));class Wr extends Lr{constructor(){super(...arguments),this.state=new $r,this.drawMode=He.TRIANGLES,this.primitiveType=Xr.triangle}foreachPrimitive(t){throw"not implement"}g(t){return this.geometry=t,this}m(t){return this.material=t,this}s(t){return this.shading=t,this}}class Hr{constructor(t,e){this.center=new Wt,this.radius=1,void 0!==t&&(this.center=t),void 0!==e&&(this.radius=e)}clone(){return(new Hr).copy(this)}copy(t){return this.center.copy(t.center),this.radius=t.radius,this}equals(t){return t.center.equals(this.center)&&t.radius===this.radius}applyMatrix4(t){return this.center.applyMatrix4(t),this.radius=this.radius*t.getMaxScaleOnAxis(),this}}const Yr=new te,Zr=new Hr;class Qr extends Wr{constructor(){super(),this.raycasterable=!0,this.drawMode=He.TRIANGLES,this.primitiveType=Xr.triangle}foreachPrimitive(t){void 0!==this.geometry&&this.geometry.foreachFace(t,this.range)}raycast(t,e){Yr.getInverse(this.worldMatrix,!1);const r=t.getLocalRay(Yr),s=new Wt;Zr.copy(this.geometry.boundingSphere),Zr.applyMatrix4(this.worldMatrix),t.worldRay.ifIntersectSphere(Zr)&&this.geometry.foreachFace(t=>{const i=r.intersectTriangle(t.p1,t.p2,t.p3,this.state.cullSide===Ye.CullFaceBack,s);null!==i&&e.push({object:this,hitLocalPosition:s.clone()})},this.range)}raycastIfHit(t){throw new Error("Method not implemented.")}raycastFirst(t){throw new Error("Method not implemented.")}}class Kr{constructor(t,e){this.min=new Wt,this.max=new Wt,void 0!==t&&(this.min.copy(t),this.max.copy(e))}clone(){const t=new Kr;return t.copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}}class Jr{constructor(){this.name="",this.uuid=Xt(),this._bufferArraysChange=!0,this._bufferDatum={},this._shapeChanged=!0,this._AABBBox=new Kr,this._AABBBoxNeedUpdate=!0,this._boundingSphere=new Hr,this._boundingSphereNeedUpdate=!0}_markBufferArrayHasUpload(){this._bufferArraysChange=!1}getBuffer(t){return this._bufferDatum[t]}setBuffer(t,e){return this._bufferDatum[t]=e,this._bufferArraysChange=!0,this}get indexBuffer(){return this._indexBuffer}set indexBuffer(t){this._indexBuffer=t,this._bufferArraysChange=!0}setIndexBuffer(t){return this.indexBuffer=t,this}checkBufferArrayChange(){if(this._bufferArraysChange)return this._bufferArraysChange;for(const t in this._bufferDatum)if(this._bufferDatum[t].dataChanged)return this._bufferArraysChange=!0,this._bufferArraysChange;return this._bufferArraysChange}set shapeChanged(t){this._shapeChanged=t,t&&(this._AABBBoxNeedUpdate=!0,this._boundingSphereNeedUpdate=!0)}get AABBBox(){return this._AABBBoxNeedUpdate&&(this.updateAABBBox(),this._AABBBoxNeedUpdate=!1),this._AABBBox}get boundingSphere(){return this._boundingSphereNeedUpdate&&(this.updateBoundingSphere(),this._boundingSphereNeedUpdate=!1),this._boundingSphere}buildShape(){this.shape(),this.shapeChanged=!0}}class ts{constructor(){this.p1=new Wt,this.p2=new Wt,this.p3=new Wt}}class es{constructor(t,e){return this.p1=void 0!==t?t:new Wt,this.p2=void 0!==e?e:new Wt,this}lengthSq(){return this.p1.distanceToSquared(this.p2)}length(){return this.p1.distanceTo(this.p2)}applyMatrix4(t){return this.p1.applyMatrix4(t),this.p2.applyMatrix4(t),this}clone(){const t=new es;return t.copy(this)}copy(t){return this.p1.copy(t.p1),this.p2.copy(t.p2),this}}class rs{constructor(t,e){this.stride=1,this.dataChanged=!0,this.data=t,this.stride=e}static f3(t){return new rs(new Float32Array(t),3)}static f2(t){return new rs(new Float32Array(t),2)}static u32Index(t){return new rs(new Uint32Array(t),1)}get count(){return this.data.length/this.stride}foreach(t,e,r){const s=Math.max(0,e),i=Math.max(this.count,r);for(let n=s;n<i;n++)t(this.data,n*this.stride,this.stride,n)}setIndex(t,e,r){this.dataChanged=!0,this.data[t*this.stride+r]=e}getIndex(t,e){return this.data[t*this.stride+e]}setData(t){this.dataChanged=!0,this.data=t}getGLAttribute(t){return t.getGLAttributeBuffer(this)}getDataSizeByte(){return this.data.byteLength}}const ss=new ts,is=new es,ns=new Wt;class as extends Jr{constructor(){super()}static create(t,e,r,s){return(new as).create(t,e,r,s)}create(t,e,r,s){const i=rs.f3(e);this.setBuffer(Xe.position,i);const n=rs.f3(r);this.setBuffer(Xe.normal,n);const a=rs.f2(s);this.setBuffer(Xe.uv,a);const o=rs.u32Index(t);return this.indexBuffer=o,this}updateBoundingSphere(){const t=this._boundingSphere,e=this.AABBBox,r=e.getCenter(t.center);let s=0;this.foreachVertex(t=>{s=Math.max(s,r.distanceToSquared(t))}),t.radius=Math.sqrt(s)}updateAABBBox(){const t=this._AABBBox;t.makeEmpty(),this.foreachVertex(e=>{t.expandByPoint(e)})}foreachFace(t,e){const r=this.getBuffer(Xe.position),s=this.indexBuffer,i=void 0===e?0:e.start,n=void 0===e?s.count:e.start+e.count;for(let a=i;a<n;a++){const e=s.getIndex(3*a,0),i=s.getIndex(3*a+1,0),n=s.getIndex(3*a+2,0);ss.p1.set(r.getIndex(e,0),r.getIndex(e,1),r.getIndex(e,2)),ss.p2.set(r.getIndex(i,0),r.getIndex(i,1),r.getIndex(i,2)),ss.p3.set(r.getIndex(n,0),r.getIndex(n,1),r.getIndex(n,2)),t(ss)}}foreachLineSegment(t,e){const r=this.getBuffer(Xe.position),s=this.indexBuffer,i=void 0===e?0:e.start,n=void 0===e?s.count:e.start+e.count;for(let a=i;a<n;a++){const e=s.getIndex(3*a,0),i=s.getIndex(3*a+1,0),n=s.getIndex(3*a+2,0);ss.p1.set(r.getIndex(e,0),r.getIndex(e,1),r.getIndex(e,2)),ss.p2.set(r.getIndex(i,0),r.getIndex(i,1),r.getIndex(i,2)),ss.p3.set(r.getIndex(n,0),r.getIndex(n,1),r.getIndex(n,2)),is.p1.copy(ss.p1),is.p2.copy(ss.p2),t(is),is.p2.copy(ss.p3),t(is),is.p1.copy(ss.p2),t(is)}}foreachVertex(t,e){const r=this.getBuffer(Xe.position),s=this.indexBuffer,i=void 0===e?0:e.start,n=void 0===e?s.count:e.start+e.count;for(let a=i;a<n;a++){const e=s.getIndex(a,0);ns.set(r.getIndex(e,0),r.getIndex(e,1),r.getIndex(e,2)),t(ns)}}shape(){throw"generate methods not impl"}}class os extends as{constructor(t,e,r,s){super(),this.name="PlaneGeometry",this.width=void 0!==t?t:1,this.height=void 0!==e?e:1,this.widthSegments=void 0!==r?r:1,this.heightSegments=void 0!==s?s:1,this.buildShape()}shape(){var t,e,r=this.width/2,s=this.height/2,i=Math.floor(this.widthSegments)||1,n=Math.floor(this.heightSegments)||1,a=i+1,o=n+1,h=this.width/i,c=this.height/n,l=[],u=[],d=[],p=[];for(e=0;e<o;e++){var f=e*c-s;for(t=0;t<a;t++){var m=t*h-r;u.push(m,-f,0),d.push(0,0,1),p.push(t/i),p.push(1-e/n)}}for(e=0;e<n;e++)for(t=0;t<i;t++){const r=t+a*e,s=t+a*(e+1),i=t+1+a*(e+1),n=t+1+a*e;l.push(r,s,n),l.push(s,i,n)}this.create(l,u,d,p)}}const hs=new Qr,cs=new os(2,2,1,1);hs.geometry=cs;class ls{constructor(){this.hasRendered=!1}resetSource(){this.hasRendered=!1}nextRenderable(){return this.hasRendered?null:(this.hasRendered=!0,hs)}updateSource(){}}var us=r("6dbe");function ds(t,e){const r=document.createElement("a");r.setAttribute("download",e+".png"),r.setAttribute("href",t.toDataURL("image/png").replace("image/png","image/octet-stream")),r.click()}function ps(t){return us["a"](this,void 0,void 0,function*(){const e=new FileReader;return new Promise(function(r,s){e.onload=function(t){const s=e.result;r(s)},e.readAsText(t)})})}function fs(){return new Promise(t=>{const e=document.createElement("input");e.setAttribute("type","file");const r=e=>{t(e.target.files[0])};e.addEventListener("change",r),e.click()})}function ms(){return us["a"](this,void 0,void 0,function*(){const t=yield fs(),e=yield ps(t);return e})}function gs(t,e){for(let r=0;r<t.length;r++)if(e(t[r]))return t[r]}const vs=2;let xs="";for(let Vh=0;Vh<vs;Vh++)xs+=" ";const ws=[];function ys(t){if(void 0!==ws[t])return ws[t];let e="";for(let r=0;r<t;r++)e+=xs;return ws[t]=e,e}class _s{constructor(){this.currentIndent=0,this.result=""}addIndent(){this.currentIndent++}reduceIndent(){this.currentIndent--}emptyLine(){this.writeLine("")}writeLine(t){this.result+=ys(this.currentIndent)+t+"\n"}writeBlock(t){const e=t.split("\n");e.forEach(t=>{const e=t.trim();e.length>0&&this.writeLine(e)})}writeBlockRaw(t){this.result+=t}writeCommentBlock(t){this.writeLine("/*"),t.split("\n").forEach(t=>{this.writeLine(" * "+t)}),this.writeLine(" */")}reset(){this.currentIndent=0,this.result=""}output(){const t=this.result;return this.reset(),t}}class bs{constructor(){this.uuid=Xt(),this.toNodes=new Set,this.fromNodes=new Set,this.fulfillList=new Map}connectTo(t){this.toNodes.add(t),t._addFromRef(this)}disconnectTo(t){this.toNodes.delete(t),t._removeFromRef(this)}clearAllTo(){this.toNodes.forEach(t=>{t._removeFromRef(this)}),this.toNodes.clear()}clearAllFrom(){this.fromNodes.forEach(t=>{t._removeToRef(this)}),this.fromNodes.clear()}_addFromRef(t){this.fromNodes.add(t)}_removeFromRef(t){this.fromNodes.delete(t)}_addToRef(t){this.toNodes.add(t)}_removeToRef(t){this.toNodes.delete(t)}generateDependencyOrderList(){let t=this.generateAllDependencyList();t.forEach(t=>{t.fulfillList.clear(),t.fromNodes.forEach(e=>{t.fulfillList.set(e.uuid,!1)})});let e=1;const r=[];function s(t){r.push(t),t.toNodes.forEach(e=>{e.fulfillList.delete(t.uuid)})}while(t.length>0)if(t=t.filter(t=>{return 0!==t.fulfillList.size||(s(t),!1)}),e++,e>1e4)throw"generateDependencyOrderList failed, graph may contains loop.";return r}traverseDFS(t){const e=new Set;function r(s){e.has(s)||(e.add(s),t(s),s.fromNodes.forEach(t=>{r(t)}))}r(this)}traverseDFS2(t){const e=new Map;function r(s,i){if(e.has(s)){if(e.get(s)<i)throw"graph contains cycle."}else e.set(s,i),t(s),s.fromNodes.forEach(t=>{r(t,i+1)})}r(this,0)}generateAllDependencyList(){const t=[];return this.traverseDFS(e=>{t.push(e)}),t}}class Ms extends bs{constructor(t){super(),this.type=t}swizzling(t){return new Ls(this,t)}}class Cs extends Ms{constructor(t){super(t.define.returnType),this.inputMap=new Map,this.factory=t}name(t){return this.meaningfulName=t,this}input(t,e){const r=this.factory.define.inputs[t];if(void 0===r)throw`this shader function node has not a input which key is ${t}`;if(r!==e.type)throw console.warn("node:",this),console.warn("inputNode:",e),"constructFragmentGraph failed: type mismatch";return e.connectTo(this),this.inputMap.set(t,e),this}}class Ss extends Ms{constructor(t,e){super(e),this.name=t,this.type=e}}class Es extends Ss{constructor(t){super(t.name,t.type)}default(t){return this.defaultValue=t,this}}class Ts extends Ss{constructor(t,e){super(t,e)}}class As extends Ss{constructor(t){super(t.name,je.get(t.mapInner).type),this.mapInner=t.mapInner}}class Rs extends Ss{constructor(t){super(t.name,t.type)}makeInstance(){return this.isInstance=!0,this}}function Ps(t){let e=t+"";return-1===e.indexOf(".")&&(e+=".0"),e}class zs extends Ms{constructor(t){if("number"===typeof t)super(de.float),this.shaderString=Ps(t);else if(t instanceof ce)super(de.floatVec2),this.shaderString=`vec2(${Ps(t.x)}, ${Ps(t.y)})`;else if(t instanceof Wt)super(de.floatVec3),this.shaderString=`vec2(${Ps(t.x)}, ${Ps(t.y)}, ${Ps(t.z)})`;else{if(!(t instanceof Ht))throw"un support shader const node value";super(de.floatVec4),this.shaderString=`vec4(${Ps(t.x)}, ${Ps(t.y)}, ${Ps(t.z)}, ${Ps(t.w)})`}this.value=t}}class Ns extends Ss{constructor(t,e,r){super(t,e),this.name=t,this.type=e,this.textureType=r}fetch(t){return new Os(this,t)}}class Os extends Ms{constructor(t,e){super(e.type),this.source=t,this.fetchByNode=e,t.connectTo(this),e.connectTo(this),this.type=de.floatVec4}}function Fs(t){switch(t){case de.float:return 1;case de.floatVec2:return 2;case de.floatVec3:return 3;case de.floatVec4:return 4;default:throw"not support combine type"}}class Ds extends Ms{constructor(t,e){super(e);let r=0;if(t.forEach(t=>{r+=Fs(t.type)}),r!==Fs(e))throw"combine node input not satisfied";this.combineCount=r,this.combines=t,this.combines.forEach(t=>{t.connectTo(this)})}}function Is(t){switch(t.length){case 1:return de.float;case 2:return de.floatVec2;case 3:return de.floatVec3;case 4:return de.floatVec4;default:throw"error"}}class Ls extends Ms{constructor(t,e){super(t.type),this.swizzleType="";const r=Fs(t.type),s=e.trim().split("");if(s.length>4)throw"swizzle not valid";if(s.length>r)throw"swizzle not valid, swizzle part exceed swizzledSource";this.from=t,t.connectTo(this),this.swizzleType=e,this.type=Is(e)}}function Vs(t){const e=new _s;e.reset(),e.writeLine("void main(){"),e.addIndent();const r=new Map,s=t.fragmentRoot.generateDependencyOrderList(),i=js(s,"gl_FragColor",r);e.writeBlock(i.code),ks(r,i.varList),e.reduceIndent(),e.writeLine("}");const n=e.output(),a=Bs(r);return a+n}function Us(t){const e=new _s;e.reset(),e.writeLine("void main(){"),e.addIndent();const r=new Map,s=t.vertexRoot.generateDependencyOrderList(),i=js(s,"gl_Position",r);ks(r,i.varList),e.writeBlock(i.code),e.writeLine("gl_PointSize = 5.0;"),e.emptyLine(),t.varyings.forEach((t,s)=>{const i=t.generateDependencyOrderList(),n=js(i,s,r);ks(r,n.varList),e.writeBlock(n.code),e.emptyLine()}),e.reduceIndent(),e.writeLine("}");const n=e.output(),a=Bs(r);return a+n}function ks(t,e){e.forEach(e=>{t.has(e.refedNode)||t.set(e.refedNode,e)})}function Bs(t){let e="\n";const r=new Set;t.forEach((t,e)=>{e instanceof Cs&&r.add(e.factory)});const s=new Set;return r.forEach(t=>{e+=t.genShaderFunctionIncludeCode(s),e+="\n"}),e}function Gs(t,e,r){function s(t){let s;return s=r.has(t)?r.get(t):gs(e,e=>{return e.refedNode===t}),s}function i(t){let e="";return e=t.refedNode instanceof Ss?t.refedNode.name:t.varKey,e}function n(t){const e=s(t);if(void 0===e)throw"_var_miss";return i(e)}let a=s(t);if(a)return i(a);if(t instanceof Cs){const e=t.factory.define;let r="";Object.keys(e.inputs).forEach((s,i)=>{const a=t.inputMap.get(s);if(void 0===a)throw`we have a shader function node but the input <${s}> has no input node`;r+=n(a),i!==Object.keys(e.inputs).length-1&&(r+=", ")});const s=`${e.name}(${r})`;return s}if(t instanceof Ss)return t.name;if(t instanceof Os)return`texture2D(${t.source.name}, ${n(t.fetchByNode)})`;if(t instanceof Ds){let e="";t.combines.forEach((r,s)=>{e+=n(r),s!==t.combines.length-1&&(e+=", ")});const r=`vec${t.combineCount}(${e})`;return r}if(t instanceof zs)return t.shaderString;if(t instanceof Ls)return n(t.from)+"."+t.swizzleType;throw"unknown shader node"}function js(t,e,r){const s=new _s;s.reset();const i=[];t.forEach(t=>{const e="var"+t.uuid.slice(0,4);i.push({refedNode:t,varKey:e,expression:Gs(t,i,r)})}),i.forEach(t=>{if(t.refedNode instanceof Ss)return;if(r.has(t.refedNode))return;const e=ve(t.refedNode.type);s.writeLine(`${e} ${t.varKey} = ${t.expression};`)});const n=i[i.length-1];return n.refedNode instanceof Ss?s.writeLine(`${e} = ${n.refedNode.name};`):s.writeLine(`${e} = ${n.varKey};`),{code:s.output(),varList:i}}function $s(t){try{const[r,s]=qs(t.source,"{"),[i,n]=qs(r,"("),{name:a,returnType:o}=Zs(i),h=Hs(n),c=Ys(s);return{name:a,description:t.description,source:c,inputs:h,returnType:o}}catch(e){throw"shader function parsed error"}}function qs(t,e){for(let r=0;r<t.length;r++){const s=t[r];if(s===e)return[t.substr(0,r),t.substr(r)]}throw"split error"}function Xs(t){switch(t.trim()){case"float":return de.float;case"vec2":return de.floatVec2;case"vec3":return de.floatVec3;case"vec4":return de.floatVec4;case"mat2":return de.Mat2;case"mat3":return de.Mat3;case"mat4":return de.Mat4;case"sampler2D":return de.sampler2D;default:throw"parse error"}}function Ws(t){const e=t.trim().split(" ").filter(t=>""!==t);return{name:e[1].trim(),type:Xs(e[0])}}function Hs(t){const e=t.trim();if(")"!==e[e.length-1]||"("!==e[0])throw"err";const r=e.substring(1,e.length-1),s=r.split(",").filter(t=>""!==t.trim()),i={};return s.forEach(t=>{const{name:e,type:r}=Ws(t);i[e]=r}),i}function Ys(t){const e=t.trim();if("}"!==e[e.length-1]||"{"!==e[0])throw"err";return e.substring(1,e.length-1)}function Zs(t){const e=t.split(" ").filter(t=>""!==t.trim());return{name:e[1].trim(),returnType:Xs(e[0])}}const Qs={};class Ks{constructor(t){this.dependShaderFunction=[],this.define=$s(t),this.name=this.define.name;const e=Qs[this.define.name];void 0!==e?(Qs[this.define.name]=e+1,this.define.name=this.define.name+e):Qs[this.define.name]=1,void 0!==t.dependFunction&&(this.dependShaderFunction=t.dependFunction)}make(){const t=new Cs(this);return t}genShaderFunctionIncludeCode(t){const e=new _s;e.reset(),this.dependShaderFunction.forEach(r=>{t.has(r)||(e.writeBlock(r.genShaderFunctionIncludeCode(t)),t.add(r))}),t.add(this);const r=this.define,s=ve(r.returnType);let i="";const n=Object.keys(r.inputs);return n.forEach((t,e)=>{const s=ve(r.inputs[t]),a=`${s} ${t}`;i+=a,e!==n.length-1&&(i+=", ")}),void 0!==r.description&&e.writeCommentBlock(r.description),e.writeLine(`${s} ${r.name}(${i}){`),e.addIndent(),e.writeBlock(this.replaceFunctionCalls(r.source)),e.reduceIndent(),e.writeLine("}"),e.output()}replaceFunctionCalls(t){let e=t.slice();return this.dependShaderFunction.forEach(t=>{t.name.trim()!==t.define.name.trim()&&Js(e,t.name,t.define.name)}),e}}function Js(t,e,r){return t.replace(new RegExp(e,"g"),r)}new Ks({source:"\n    vec3 DivW ( vec4 position){\n      return position.xyz / position.w;\n    }\n  "});const ti=new Ks({source:"\n    vec4 MTransform (mat4 MMatrix, vec3 position){\n      return MMatrix * vec4(position, 1.0);\n    }\n  "}),ei=new Ks({source:"\n    vec4 VPTransform (mat4 VPMatrix, vec4 position){\n      return VPMatrix * position;\n    }\n  "}),ri=new Ks({description:"Transform from the current view projection matrix and its inverse, \n     and uv coordinates to world position",source:"\n    vec4 getWorldPosition(\n      vec2 uv, \n      float depth, \n      mat4 VPMatrix, \n      mat4 VPMatrixInverse\n    ){\n      float clipW = VPMatrix[2][3] * depth + VPMatrix[3][3];\n      vec4 position = VPMatrixInverse * (vec4(uv * 2.0 - 1.0, depth, 1.0) * clipW);\n      return position / position.w;\n    }\n    "}),si=new Ks({description:"Get texture uv lookup position from NDC",source:"\n  vec2 NDCTextureLookUp(vec3 ndc){\n    return vec2(ndc.x / 2.0 + 0.5, ndc.y / 2.0 + 0.5);\n  }"}),ii=new Ks({source:"\n  vec4 UVDepthToNDC(float depth, vec2 uv){\n    return vec4(uv.x * 2.0 - 1.0, uv.y * 2.0 - 1.0,depth, 1.0);\n  }"}),ni=new Ks({source:"\n  vec3 getLastPixelNDC(vec4 ndc, mat4 VPMatrixInverse, mat4 LastVPMatrix){\n\n    // we consider frag too far is background\n    if(ndc.z > 0.99){\n      return ndc.xyz;\n    }\n    \n    vec4 worldPosition = VPMatrixInverse * ndc;\n    vec4 oldPosition = LastVPMatrix * worldPosition;\n    oldPosition = oldPosition / oldPosition.w;\n    return  oldPosition.xyz;\n  }\n  "}),ai=new Ks({source:"\n  vec3 randDir(float x, float y){\n    float PI =  3.14159265; // TODO\n    float lambda = acos(2.0 * x - 1.0) - PI / 2.0;\n    float phi = 2.0 * PI * y;\n    return vec3(\n      cos(lambda) * cos(phi),\n      cos(lambda) * sin(phi),\n      sin(lambda)\n    );\n  }\n  "});function oi(t,e){return new Rs({name:t,type:e})}function hi(t,e){const r=void 0!==e?e:We.texture2D;return new Ns(t,de.sampler2D,r)}function ci(t,e){return new Es({name:t,type:e})}function li(t,e){if("number"===typeof e)return ci(t,de.float).default(e);if(e instanceof ce)return ci(t,de.floatVec2).default(e);if(e instanceof Wt)return ci(t,de.floatVec3).default(e);if(e instanceof Ht)return ci(t,de.floatVec4).default(e);if(e instanceof te)return ci(t,de.Mat4).default(e);throw"un support uniform value"}function ui(t){return new As({name:"inner"+je.get(t).name,mapInner:t})}function di(...t){return new Ds(t,de.floatVec4)}function pi(t){return new zs(t)}function fi(){return ei.make().input("VPMatrix",ui(Ge.VPMatrix)).input("position",ti.make().input("MMatrix",ui(Ge.MMatrix)).input("position",oi(Xe.position,de.floatVec3)))}function mi(){return di(oi(Xe.position,de.floatVec3),pi(1))}const gi="v_uv",vi="v_normal",xi="v_position_world";class wi{constructor(){this.varyings=new Map,this.reset()}setFragmentRoot(t){return this.fragmentRoot=t,this}updateAutoWorldPositionVary(t){if(this.varyings.delete(xi),t instanceof Cs&&"VPTransform"===t.factory.define.name){const e=t.inputMap.get("position");if(void 0===e)throw"we have a shader function node but the input <position> has no input node";e instanceof Cs&&"MTransform"===e.factory.define.name&&this.setVary(xi,e.swizzling("xyz"))}}setVertexRoot(t){return this.vertexRoot=t,this.updateAutoWorldPositionVary(t),this}declareFragNormal(){return this.varyings.has(vi)?this:this.setVary(vi,oi(Xe.normal,de.floatVec3))}declareFragUV(){return this.varyings.has(gi)?this:this.setVary(gi,oi(Xe.uv,de.floatVec2))}setVary(t,e){return this.varyings.set(t,e),this}getFragRoot(){return this.fragmentRoot}getVary(t){let e=this.varyings.get(t);if(void 0===e){if(t!==vi)throw"cant get vary";this.declareFragNormal(),e=this.varyings.get(t)}return new Ts(t,e.type)}reset(){return this.varyings.clear(),this.setVertexRoot(fi()),this.setFragmentRoot(pi(new Ht)),this}compile(){return Object.assign({},this.collectInputs(),{vertexShaderString:this.compileVertexSource(),fragmentShaderString:this.compileFragSource(),autoInjectHeader:!0})}get nodes(){const t=new Set;this.fragmentRoot.traverseDFS(e=>{t.add(e)}),this.vertexRoot.traverseDFS(e=>{t.add(e)}),this.varyings.forEach(e=>{e.traverseDFS(e=>{t.add(e)})});const e=[];return t.forEach(t=>{e.push(t)}),e}collectInputs(){const t=this.nodes,e=t.filter(t=>t instanceof Ss),r=e.filter(t=>t instanceof Rs).map(t=>{return{name:t.name,type:t.type}}),s=e.filter(t=>t instanceof Es).map(t=>{return{name:t.name,type:t.type,default:t.defaultValue}}),i=e.filter(t=>t instanceof As).map(t=>{return{name:t.name,mapInner:t.mapInner}}),n=e.filter(t=>t instanceof Ns).map(t=>{return{name:t.name,type:t.textureType}}),a=[];return this.varyings.forEach((t,e)=>{a.push({name:e,type:t.type})}),{attributes:r,uniforms:s,textures:n,varyings:a,uniformsIncludes:i}}compileVertexSource(){return Us(this)}compileFragSource(){return Vs(this)}}class yi{constructor(){this.uuid=Xt(),this.graph=new wi,this._programConfigCache=null,this._needRebuildShader=!0,this._decorators=[],this._decoratorSlot=new Map,this._decoratorObs=new Map,this.afterShaderCompiled=new jr}updateDecorator(t,e){void 0===e&&(e=t.constructor.name);const r=this._decoratorSlot.get(e);if(void 0===r)throw`slot ${e} has not been decorate before`;if(!(t instanceof r.constructor))throw"provider not the same type before";this._decoratorSlot.set(e,t)}reset(){this._decoratorObs.forEach((t,e)=>{e.notifyNeedRedecorate.remove(t)}),this._decoratorObs.clear(),this._decoratorSlot.clear(),this._decorators=[],this._needRebuildShader=!0,this._programConfigCache=null}decorate(t,e){if(void 0===e&&(e=t.constructor.name),this._decoratorSlot.has(e))throw`slot ${e} has been decorate before`;const r=t.notifyNeedRedecorate.add(t=>{this._needRebuildShader=!0});return this._decoratorObs.set(t,r),this._decoratorSlot.set(e,t),this._decorators.push(t),this}build(){this.graph.reset(),this._decorators.forEach(t=>{t.decorate(this.graph)})}getProgramConfig(){return this._needRebuildShader&&(this.build(),this._programConfigCache=this.graph.compile(),this.afterShaderCompiled.notifyObservers(this._programConfigCache),this._needRebuildShader=!1),this._programConfigCache}getProgram(t){this._needRebuildShader&&this.disposeProgram(t);let e=t.getProgram(this);return void 0===e&&(e=t.createProgram(this)),e}disposeProgram(t){t.deleteProgram(this)}}function _i(){return(t,e)=>{void 0===t.notifyNeedRedecorate&&(t.notifyNeedRedecorate=new jr);let r=t[e];const s=()=>{return r},i=e=>{const s=r;r=e,s!==e&&t.notifyNeedRedecorate.notifyObservers(t)};Object.defineProperty(t,e,{get:s,set:i,enumerable:!0,configurable:!0})}}function bi(t){return(e,r)=>{void 0===e.uniforms&&(e.uniforms=new Map),void 0===e.propertyUniformNameMap&&(e.propertyUniformNameMap=new Map);let s=e[r];const i=()=>{return s},n=r=>{e.uniforms.set(t,r),e.hasAnyUniformChanged=!0,s=r};e.propertyUniformNameMap.set(r,t),Object.defineProperty(e,r,{get:i,set:n,enumerable:!0,configurable:!0})}}class Mi{constructor(){this.hasAnyUniformChanged=!0,void 0===this.uniforms&&(this.uniforms=new Map),void 0===this.propertyUniformNameMap&&(this.propertyUniformNameMap=new Map),void 0===this.notifyNeedRedecorate&&(this.notifyNeedRedecorate=new jr)}foreachProvider(t){return t(this)}getPropertyUniform(t){const e=this.propertyUniformNameMap.get(t),r=this[t];if(void 0===r)throw"uniform value not given";return li(e,r)}}class Ci extends Mi{decorate(t){t.setVertexRoot(mi()).declareFragUV().setFragmentRoot(hi("copySource").fetch(t.getVary(gi)))}}const Si=new ce,Ei=new ce;class Ti{constructor(t){this.enabled=!0,this.mouseButton=-1,this.prev=new ce,this.controllers=[],this.onMouseMove=t=>{this.enabled&&(Si.set(t.clientX,t.clientY),Ei.copy(this.prev).sub(Si),0===this.mouseButton&&this.groupEmit(this.leftMouseMoveCallBacks,Ei),2===this.mouseButton&&this.groupEmit(this.rightMouseMoveCallBacks,Ei),this.prev.copy(Si))},this.onMouseDown=t=>{this.enabled&&(this.prev.set(t.clientX,t.clientY),this.mouseButton=t.button,t.preventDefault())},this.onMouseUp=t=>{this.enabled&&(this.groupEmit(this.mouseUpCallBacks),this.mouseButton=-1)},this.onMouseWheel=t=>{if(!this.enabled)return;let e=0;void 0!==t.wheelDelta?e=t.wheelDelta:void 0!==t.deltaY&&(e=-t.deltaY),e=e>0?1.1:.9,this.groupEmit(this.mouseWheelCallBacks,e)},this.leftMouseMoveCallBacks=[],this.rightMouseMoveCallBacks=[],this.mouseWheelCallBacks=[],this.mouseDownCallBacks=[],this.mouseUpCallBacks=[],this.inputElement=t,this.bind()}bind(){const t=this.inputElement;this.mouseButton=-1,t.addEventListener("mousemove",this.onMouseMove,!1),t.addEventListener("mousedown",this.onMouseDown,!1),t.addEventListener("mouseup",this.onMouseUp,!1),t.addEventListener("wheel",this.onMouseWheel,!1),t.addEventListener("contextmenu",this.preventContentMenu,!1)}unbind(){const t=this.inputElement;this.mouseButton=-1,t.removeEventListener("mousemove",this.onMouseMove),t.removeEventListener("mousedown",this.onMouseDown),t.removeEventListener("mouseup",this.onMouseUp),t.removeEventListener("wheel",this.onMouseWheel),t.removeEventListener("contextmenu",this.preventContentMenu,!1)}preventContentMenu(t){t.preventDefault(),t.stopPropagation()}groupEmit(t,...e){t.forEach(t=>{t.callback(...e)})}removeController(t,e){e=e.filter(e=>{return e.controller===t})}bindLeftMouseMove(t,e){this.leftMouseMoveCallBacks.push({controller:t,callback:e})}bindRightMouseMove(t,e){this.rightMouseMoveCallBacks.push({controller:t,callback:e})}bindMouseWheel(t,e){this.mouseWheelCallBacks.push({controller:t,callback:e})}bindMouseDown(t,e){this.mouseDownCallBacks.push({controller:t,callback:e})}bindMouseUp(t,e){this.mouseUpCallBacks.push({controller:t,callback:e})}unbindControllerAllListener(t){this.removeController(t,this.mouseUpCallBacks),this.removeController(t,this.rightMouseMoveCallBacks),this.removeController(t,this.mouseWheelCallBacks),this.removeController(t,this.mouseDownCallBacks),this.removeController(t,this.mouseUpCallBacks)}dispose(){this.unbind(),this.leftMouseMoveCallBacks=[],this.rightMouseMoveCallBacks=[],this.mouseWheelCallBacks=[],this.mouseDownCallBacks=[],this.mouseUpCallBacks=[]}}function Ai(t,e){t.updateSource(),t.resetSource();let r=null;do{r=t.nextRenderable(),null!==r&&e(r)}while(null!==r)}const Ri=(new yi).decorate(new Ci),Pi=new ls;class zi{constructor(t,e){this._preferVAO=!0,this._vaoEnabled=!1,this.resizeObservable=new jr,this.overrideShading=null,this.defaultTechnique=(new yi).decorate(new Wi),this._camera=new kr,this.isCameraChanged=!0,this.cameraMatrixReverse=new te,this.ProjectionMatrix=new te,this.VPMatrix=new te,this.LastVPMatrix=new te,this.jitterPMatrix=new te,this.jitterVPMatrix=new te,this.globalUniforms=new Map,this.lastUploadedShaderUniformProvider=new Set,this.programShadingMap=new Map,this.renderer=new Nr(t,e),void 0!==t&&(this.camera.aspect=t.width/t.height),this.interactor=new Ti(t),je.forEach((t,e)=>{this.globalUniforms.set(e,new Br(t.default))}),this.preferVAO=!0}get vaoEnabled(){return this._vaoEnabled}get preferVAO(){return this._preferVAO}set preferVAO(t){this._preferVAO=t,t?(this.renderer.vaoManager.isSupported||console.warn("prefer vao is set to true, but your environment cant support vao, vaoEnabled is false"),this._vaoEnabled=!0):(this.renderer.vaoManager.releaseGL(),this._vaoEnabled=!1)}setSize(t,e){this.renderer.setSize(t,e)&&this.resizeObservable.notifyObservers({width:t,height:e})}setActualSize(t,e){this.renderer.setRawRenderSize(t,e)&&this.resizeObservable.notifyObservers({width:t,height:e})}get camera(){return this._camera}set camera(t){this._camera=t,this.isCameraChanged=!0}jitterProjectionMatrix(){this.jitterPMatrix.copy(this.ProjectionMatrix),this.jitterPMatrix.elements[8]+=(2*Math.random()-1)/this.renderer.width,this.jitterPMatrix.elements[9]+=(2*Math.random()-1)/this.renderer.height,this.jitterVPMatrix.multiplyMatrices(this.jitterPMatrix,this.cameraMatrixReverse),this.getGlobalUniform(Ge.VPMatrix).setValue(this.jitterVPMatrix)}unJit(){this.getGlobalUniform(Ge.VPMatrix).setValue(this.VPMatrix)}connectCamera(){let t=!1;this.camera.projectionMatrixNeedUpdate&&(this.camera.updateProjectionMatrix(),this.ProjectionMatrix.copy(this.camera.projectionMatrix),t=!0),this.camera.transform.transformFrameChanged&&(this.camera.transform.matrix,this.camera.updateWorldMatrix(!0),this.cameraMatrixReverse.getInverse(this.camera.worldMatrix,!0),t=!0),this.LastVPMatrix.copy(this.VPMatrix),this.getGlobalUniform(Ge.LastVPMatrix).setValue(this.LastVPMatrix),t?(this.VPMatrix.multiplyMatrices(this.ProjectionMatrix,this.cameraMatrixReverse),this.getGlobalUniform(Ge.VPMatrix).setValue(this.VPMatrix),t=!1,this.isCameraChanged=!0):this.isCameraChanged=!1}render(t){Ai(t,t=>{this.renderObject(t)})}renderObject(t){const e=this.connectShading(t);this.connectMaterial(t.material,e),this.connectGeometry(t.geometry,e),this.connectRange(t.range,e,t.geometry),t.state.syncGL(this.renderer),this.renderer.draw(t.drawMode)}renderFrameBuffer(t,e){this.renderer.setRenderTargetScreen(),this.renderer.state.setViewport(e.x,e.y,e.z,e.w),this.overrideShading=Ri,this.overrideShading.getProgram(this).defineFrameBufferTextureDep(t.name,"copySource"),this.render(Pi),this.overrideShading=null}getGlobalUniform(t){return this.globalUniforms.get(t)}connectShading(t){let e;e=null!==this.overrideShading?this.overrideShading:void 0!==t.shading?t.shading:this.defaultTechnique;const r=e.getProgram(this);return this.lastProgramRendered!==r&&this.lastUploadedShaderUniformProvider.clear(),this.renderer.useProgram(r),this.getGlobalUniform(Ge.MMatrix).setValue(t.worldMatrix),r.updateInnerGlobalUniforms(this),e._decorators.forEach(t=>{t.foreachProvider(t=>{this.lastUploadedShaderUniformProvider.has(t)&&!t.hasAnyUniformChanged||(t.uniforms.forEach((t,e)=>{r.setUniformIfExist(e,t)}),t.hasAnyUniformChanged=!1,this.lastUploadedShaderUniformProvider.add(t))})}),r}connectMaterial(t,e){e.forTextures(r=>{let s;if(void 0!==t){if(void 0===r.channel)throw"use texture in material / use material to render should set texture uniform channel type";const e=t.getChannelTexture(r.channel);s=e.getGLTexture(this)}if(void 0===s){const t=e.framebufferTextureMap[r.name];if(void 0===t)throw`cant find framebuffer for tex ${r.name}, please define before use`;s=this.renderer.framebufferManager.getFramebufferTexture(t)}if(void 0===s)throw"texture bind failed";r.useTexture(s)})}connectGeometry(t,e){if(e.useIndexDraw){if(null===t.indexBuffer)throw"indexBuffer not found for index draw";const r=t.indexBuffer;r.data instanceof Uint32Array?e.indexUINT=!0:e.indexUINT=!1}let r;if(this._vaoEnabled){const e=this.renderer.vaoManager,s=e.getVAO(t);if(void 0!==s||!t.checkBufferArrayChange())return void e.useVAO(s);e.deleteVAO(t),r=e.createVAO(t)}if(e.forAttributes(e=>{const r=t.getBuffer(e.name);if(void 0===r)throw`program needs an attribute named ${e.name}, but cant find in geometry data`;let s=this.getGLAttributeBuffer(r);void 0===s&&r.dataChanged&&(s=this.createOrUpdateAttributeBuffer(r,!1),r.dataChanged=!1),e.useBuffer(s)}),e.useIndexDraw){const r=t.indexBuffer;let s=this.getGLAttributeBuffer(r);void 0===s&&(s=this.createOrUpdateAttributeBuffer(r,!0)),e.useIndexBuffer(s)}this._vaoEnabled&&void 0!==r&&(r.unbind(),t._markBufferArrayHasUpload(),this.renderer.vaoManager.useVAO(r.vao))}connectRange(t,e,r){let s=0,i=0;if(void 0===t){if(null===r.indexBuffer)throw"range should be set if use none index geometry";i=r.indexBuffer.data.length}else s=t.start,i=t.count;e.drawFrom=s,e.drawCount=i}getProgram(t){return this.programShadingMap.get(t)}createProgram(t){const e=this.renderer.createProgram(t.getProgramConfig());return this.programShadingMap.set(t,e),e}deleteProgram(t){const e=this.programShadingMap.get(t);void 0!==e&&(e.dispose(),this.programShadingMap.delete(t))}getGLAttributeBuffer(t){return this.renderer.attributeBufferManager.getGLBuffer(t.data.buffer)}createOrUpdateAttributeBuffer(t,e){return this.renderer.attributeBufferManager.updateOrCreateBuffer(t.data.buffer,e)}downloadCurrentRender(){ds(this.renderer.el,"artgl-renderscreenshot")}releaseGL(){this.renderer.releaseGL()}dispose(){this.resizeObservable.clear(),this.releaseGL(),this.interactor.dispose()}}class Ni{constructor(t){this.size=10,this.count=0,this.records=[],this.all=0,this.size=void 0===t?10:t,this.reset()}get average(){return this.count>=this.size?this.all/this.size:this.all/this.count}get last(){return Math.max(0,this.count-this.size)%this.size}push(t){this.count++;const e=this.count%this.size;this.all-=this.records[this.last],this.all+=t,this.records[e]=t}reset(){this.count=0,this.all=0,this.records=[];for(let t=0;t<this.size;t++)this.records.push(0)}resetWithNewSize(t){this.size=t,this.reset()}}class Oi{constructor(){this.avgRenderFrameTimeLast120Frame=new Ni(120),this.userRenderFrame=null,this.renderFrame=t=>{this.frameStart(t),null!==this.userRenderFrame&&this.userRenderFrame(t),this.frameEnd(performance.now()),this.active&&(this.tickId=window.requestAnimationFrame(this.renderFrame))},this.active=!1,this.frameStartTime=0}setFrame(t){this.userRenderFrame=t}run(){this.active=!0,this.tickId=window.requestAnimationFrame(this.renderFrame)}step(){this.active||this.renderFrame(performance.now())}stop(){this.active=!1,void 0!==this.tickId&&window.cancelAnimationFrame(this.tickId)}frameStart(t){this.frameStartTime=t}frameEnd(t){this.avgRenderFrameTimeLast120Frame.push(t-this.frameStartTime)}}class Fi extends Wr{constructor(){super(),this.drawMode=He.LINES}}class Di extends Wr{constructor(){super(),this.drawMode=He.POINTS}}var Ii,Li,Vi;(function(t){t["diffuse"]="diffuse",t["roughness"]="roughness",t["metallic"]="metallic",t["ao"]="ao"})(Ii||(Ii={}));class Ui{constructor(){this.list=[],this.realLength=0,this.renderListCursor=0}addRenderItem(t){this.realLength<this.list.length?this.list[this.realLength]=t:this.list.push(t),this.realLength++}forEach(t){for(let e=0;e<this.realLength;e++)t(this.list[e])}next(){if(this.renderListCursor>=this.list.length)return null;const t=this.list[this.renderListCursor];return this.renderListCursor++,t}reset(){this.realLength=0}resetCursor(){this.renderListCursor=0}clear(){this.list=[]}sort(){}}class ki{constructor(){this.root=new Lr,this.objectList=new Ui,this.isFrameStructureChange=!0,this.isFrameTransformChange=!0,this.isFrameVisibleChange=!0,this.onRemoveList=new Set,this.onAddList=new Set}get isFrameChange(){return this.isFrameStructureChange||this.isFrameTransformChange||this.isFrameVisibleChange}addNode(t){this.onRemoveList.delete(t),this.onAddList.add(t),this.isFrameStructureChange=!0}removeNode(t){this.onAddList.delete(t),this.onRemoveList.add(t),this.isFrameStructureChange=!0}updateSource(){this.isFrameStructureChange&&this.updateObjectList()}resetSource(){this.objectList.resetCursor()}nextRenderable(){return this.objectList.next()}updateObjectList(){this.objectList.reset(),this.onRemoveList.clear(),this.onAddList.clear(),this.root.traverse(t=>{t.scene=this,(this.isFrameStructureChange||this.isFrameTransformChange)&&(null!==t.parent?t._worldMatrix.multiplyMatrices(t.parent._worldMatrix,t.transform.matrix):t._worldMatrix.copy(t.transform.matrix)),t instanceof Wr&&this.objectList.addRenderItem(t)}),this.isFrameStructureChange=!1,this.isFrameTransformChange=!1,this.isFrameVisibleChange=!1}updateWorldMatrix(){this.root.updateWorldMatrix(!0)}setRootNode(t){if(t.scene)throw"node has set to scene, abort";this.root=t,this.isFrameStructureChange=!0}disposeRootNode(){if(!this.root)throw"scene hasn't root";this.root.traverse(t=>{t.scene=null}),this.root=null}registGeometryLoader(t){}}(function(t){t[t["bindRenderSize"]=0]="bindRenderSize",t[t["fixed"]=1]="fixed"})(Li||(Li={})),function(t){t[t["DisableColorWrite"]=0]="DisableColorWrite",t[t["DisableAlphaWrite"]=1]="DisableAlphaWrite"}(Vi||(Vi={}));class Bi{constructor(t){if(this.enableDepthClear=!0,this.enableColorClear=!0,this.overrideShading=null,this.inputTarget=new Map,this.isOutputScreen=!0,this.define=t,this.name=t.name,void 0!==t.shading){const e=t.shading;if(void 0===e)throw`technique '${t.shading}' not defined`;this.overrideShading=e}this.clearColor=t.clearColor,this.enableColorClear=void 0===t.enableColorClear||t.enableColorClear,this.enableDepthClear=void 0===t.enableDepthClear||t.enableDepthClear,this.beforePassExecute=t.beforePassExecute,this.afterPassExecute=t.afterPassExecute}updateInputTargets(t){this.inputTarget.clear(),Object.keys(t).forEach(e=>{const r=t[e];this.inputTarget.set(e,r)})}setOutPutTarget(t,e){e.name===ji.screenRoot?(this.outputTarget=void 0,this.isOutputScreen=!0):(this.outputTarget=e.getOrCreateFrameBuffer(t),this.isOutputScreen=!1)}renderDebugResult(t,e){const r=e.renderTargetNodes.get(this.outputTarget.name).debugViewPort;t.renderFrameBuffer(this.outputTarget,r),this.inputTarget.forEach((r,s)=>{const i=t.renderer.framebufferManager.getFramebuffer(r),n=e.renderTargetNodes.get(i.name).debugViewPort;t.renderFrameBuffer(i,n)})}execute(t,e){if(this.isOutputScreen)if(t.renderer.setRenderTargetScreen(),e.enableDebuggingView){const r=e.screenNode.debugViewPort;t.renderer.state.setViewport(r.x,r.y,r.z,r.w)}else t.renderer.state.setFullScreenViewPort();else t.renderer.setRenderTarget(this.outputTarget),t.renderer.state.setViewport(0,0,this.outputTarget.width,this.outputTarget.height);null!==this.overrideShading&&(t.overrideShading=this.overrideShading,this.inputTarget.forEach((e,r)=>{t.overrideShading.getProgram(t).defineFrameBufferTextureDep(e,r)})),this.enableColorClear&&(void 0!==this.clearColor&&t.renderer.state.colorbuffer.setClearColor(this.clearColor),t.renderer.state.colorbuffer.clear()),this.enableDepthClear&&!this.isOutputScreen&&this.outputTarget.enableDepth&&t.renderer.state.depthbuffer.clear(),void 0!==this.beforePassExecute&&this.beforePassExecute(),this.define.source.forEach(e=>{t.render(e)}),void 0!==this.afterPassExecute&&this.afterPassExecute(),t.overrideShading=null,t.renderer.state.colorbuffer.resetDefaultClearColor(),e.enableDebuggingView&&!this.isOutputScreen&&this.renderDebugResult(t,e)}checkIsValid(){if(this.isOutputScreen)return;const t=this.outputTarget.name;this.inputTarget.forEach(e=>{if(e===t)throw`you cant output to the render target which is depend on: \nDuplicate target: ${this.outputTarget.name};`})}}class Gi{constructor(){this.passes=[],this.nodeMap=new Map}render(t,e){this.passes.forEach(r=>{r.execute(t,e)})}reset(){this.passes=[]}addPass(t){this.passes.push(t)}registerNode(t,e){const r=new Bi(e);this.nodeMap.set(t,r)}clear(){this.passes=[],this.nodeMap.clear()}getPass(t){return this.nodeMap.get(t)}}class ji{constructor(){this.enableDebuggingView=!1,this.renderTargetNodes=new Map,this.passNodes=new Map}get nodes(){const t=[];return this.passNodes.forEach(e=>{t.push(e)}),this.renderTargetNodes.forEach(e=>{t.push(e)}),t}reset(){this.renderTargetNodes.clear(),this.passNodes.clear()}defineGraph(t,e){this.reset(),this.allocateRenderTargetNodes(e.renderTargets),this.constructPassGraph(e.passes,t)}update(t,e){this.passNodes.forEach(t=>{t.updateDependNode(this)}),this.renderTargetNodes.forEach(t=>{t.updateDependNode(this)});const r=this.screenNode.generateDependencyOrderList();e.reset(),r.forEach(e=>{e instanceof $i&&e.updateSize(t)}),r.forEach(s=>{if(s instanceof qi){const i=e.getPass(s);if(void 0===i)throw"err";s.updatePass(t,i,r),e.addPass(i)}})}constructPassGraph(t,e){t.forEach(t=>{if(this.passNodes.has(t.name))throw"duplicate pass define found";{const r=new qi(this,t);this.passNodes.set(t.name,r),e.registerNode(r,t)}})}getRenderTargetDependence(t){return this.renderTargetNodes.get(t)}getRenderPassDependence(t){return this.passNodes.get(t)}getRootScreenTargetNode(){let t;return this.renderTargetNodes.forEach(e=>{e.isScreenNode&&(t=e)}),t}allocateRenderTargetNodes(t){if(t.forEach(t=>{if(this.renderTargetNodes.has(t.name))throw"render graph build error, duplicate texture key name found ";const e=new $i(t);if(t.name===ji.screenRoot){if(void 0!==this.screenNode)throw"duplicate screen root node";this.screenNode=e}this.renderTargetNodes.set(t.name,e)}),void 0===this.screenNode)throw"screen root not found"}}ji.screenRoot="artgl-rendergraph-screen-rt",ji.quadSource=new ls;class $i extends bs{constructor(t){super(),this.debugViewPort=new Ht(0,0,200,200),this.autoWidthRatio=0,this.autoHeightRatio=0,this.enableDepth=!0,this.widthAbs=0,this.heightAbs=0,this.from=null,this.name=t.name,this.define=t,this.fromGetter=t.from,this.isScreenNode=t.name===ji.screenRoot,this.isScreenNode||(void 0===t.format&&(t.format={pixelFormat:cr.RGBA,dimensionType:Li.bindRenderSize}),t.format.dimensionType===Li.bindRenderSize&&(this.autoWidthRatio=void 0!==t.format.width?ee.clamp(t.format.width,0,1):1,this.autoHeightRatio=void 0!==t.format.height?ee.clamp(t.format.height,0,1):1),this.enableDepth=void 0===t.format.disableDepthBuffer||t.format.disableDepthBuffer)}getOrCreateFrameBuffer(t){const e=t.renderer.framebufferManager.getFramebuffer(this.name);return e||t.renderer.framebufferManager.createFrameBuffer(t,this.name,this.widthAbs,this.heightAbs,this.enableDepth)}updateSize(t){if(this.isScreenNode)return;const e=this.define;let r,s;e.format.dimensionType===Li.fixed?(r=void 0!==e.format.width?e.format.width:t.renderer.width,s=void 0!==e.format.height?e.format.height:t.renderer.height):(r=Math.max(5,t.renderer.width*this.autoWidthRatio),s=Math.max(5,t.renderer.height*this.autoHeightRatio)),this.widthAbs=Math.max(5,r),this.heightAbs=Math.max(5,s),this.getOrCreateFrameBuffer(t).resize(t,r,s)}updateDependNode(t){if(this.clearAllFrom(),this.from=this.fromGetter(),null!==this.from){const e=t.getRenderPassDependence(this.from);e.connectTo(this)}}}class qi extends bs{constructor(t,e){super(),this.inputsGetter=null,this.inputs={},this.name=e.name,void 0!==e.inputs&&(this.inputsGetter=e.inputs)}updateDependNode(t){this.clearAllFrom(),null!==this.inputsGetter&&(this.inputs=this.inputsGetter());const e=this.inputs;Object.keys(e).forEach(r=>{const s=e[r],i=t.getRenderTargetDependence(s);if(void 0===i)throw`render graph updating error, renderTarget depend node ${s} cant found`;i.connectTo(this)})}updatePass(t,e,r){e.updateInputTargets(this.inputs);let s=null;if(0===this.toNodes.size)throw"cant found render target node for a render pass";this.toNodes.forEach(i=>{if(i instanceof $i)for(let n=0;n<r.length;n++)if(r[n]===i){if(null!==s)throw`RenderGraph update error: one target node should only has one pass targeted;\nprevious found target pass: ${s.name};\nnew found target pass: ${r[n].name};\n              `;s=i,e.setOutPutTarget(t,i)}}),e.checkIsValid()}}const Xi=new Ks({source:"vec4 normalShading(vec3 normal){\n      return vec4(normal * 0.5 + 0.5, 1.0);\n    }"});class Wi extends Mi{decorate(t){t.setFragmentRoot(Xi.make().input("normal",t.getVary(vi)))}}const Hi=new Ks({description:"pack depth to RGBA output",source:"\n    vec4 depthPack(float frag_depth){\n      vec4 bitSh = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n      vec4 bitMsk = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n      vec4 enc = fract(frag_depth * bitSh);\n      enc -= enc.xxyz * bitMsk;\n      return enc;\n    }\n  "}),Yi=new Ks({description:"unpack depth from RGBA channel",source:"\n  float UnpackDepth( vec4 enc ) {\n    const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );\n    return dot( enc, bit_shift );\n}"}),Zi=new Ks({source:"float rand(float n) {return fract(sin(n) * 43758.5453123);}"}),Qi=(new Ks({source:"\n  float rand(vec2 cood){\n    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\n}\n  "}),new Ks({source:"\n  float rand(vec2 cood, float t){\n    vec2 co = cood;\n    co.x = sin(t) + co.x;\n    co.y = cos(t) + co.y;\n    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\n}\n  "})),Ki=new Ks({source:"\n  vec3 newPosition(vec3 positionOld, float distance, vec3 dir, float rand){\n    return distance * rand * dir + positionOld;\n  }\n  "}),Ji=new Ks({source:"\n  vec3 depthFromWorldPositionAndVPMatrix(vec3 position, mat4 matrix){\n    vec4 ndc = matrix * vec4(position, 1.0);\n    ndc = ndc / ndc.w;\n    return ndc.xyz;\n  }\n  "}),tn=new Ks({source:"\n  vec3 sampleAO(float depth, float newDepth){\n    if (depth >0.999){\n      return vec3(0.5);\n    }\n    float rate =  depth > newDepth ? 0.0 : 1.0;\n    return vec3(rate);\n  }\n  "}),en=new Ks({source:"\n  vec4 tssaoMix(vec3 oldColor, vec3 newColor, float sampleCount){\n    return vec4((oldColor * sampleCount + newColor) / (sampleCount + 1.0), 1.0);\n  }\n  "});class rn extends Mi{constructor(){super(...arguments),this.sampleCount=0,this.VPMatrixInverse=new te,this.aoRadius=1}decorate(t){const e=ui(Ge.VPMatrix),r=this.getPropertyUniform("sampleCount"),s=hi("depthResult");t.setVertexRoot(mi()).declareFragUV();const i=t.getVary(gi),n=Yi.make().input("enc",s.fetch(i)),a=ri.make().input("uv",i).input("depth",n).input("VPMatrix",e).input("VPMatrixInverse",this.getPropertyUniform("VPMatrixInverse")),o=Qi.make().input("cood",i).input("t",r),h=Zi.make().input("n",o),c=ai.make().input("x",o).input("y",h),l=Ki.make().input("positionOld",a.swizzling("xyz")).input("distance",this.getPropertyUniform("aoRadius")).input("dir",c).input("rand",o),u=Yi.make().input("enc",s.fetch(si.make().input("ndc",Ji.make().input("position",l).input("matrix",e))));t.setFragmentRoot(en.make().input("oldColor",hi("AOAcc").fetch(i).swizzling("xyz")).input("newColor",tn.make().input("depth",n).input("newDepth",u)).input("sampleCount",r))}}us["b"]([bi("u_sampleCount")],rn.prototype,"sampleCount",void 0),us["b"]([bi("VPMatrixInverse")],rn.prototype,"VPMatrixInverse",void 0),us["b"]([bi("u_aoRadius")],rn.prototype,"aoRadius",void 0);const sn=new Ks({source:"\n  vec4 tssaoBlend(\n    sampler2D colorMap, \n    sampler2D aoMap, \n    vec2 uvInput,\n    float sampleCount, \n    float tssaoComposeRate,\n    float tssaoShowThreshold,\n    float tssaoComposeThreshold\n    ) {\n      vec3 color = texture2D(colorMap, uvInput).xyz;\n      vec3 aoColor = texture2D(aoMap, uvInput).xyz;\n      vec3 aoModify = vec3(1.0) - tssaoComposeRate * (vec3(1.0) - aoColor) * vec3(min(sampleCount / tssaoShowThreshold, 1.0));\n      aoModify = clamp(aoModify + vec3(tssaoComposeThreshold), vec3(0.0), vec3(1.0));\n      return vec4(color * aoModify, 1.0);\n  }\n  "});class nn extends Mi{constructor(){super(...arguments),this.sampleCount=0,this.tssaoComposeRate=1,this.tssaoShowThreshold=200,this.tssaoComposeThreshold=.5}decorate(t){t.setVertexRoot(mi()).declareFragUV().setFragmentRoot(sn.make().input("colorMap",hi("basic")).input("aoMap",hi("tssao")).input("uvInput",t.getVary(gi)).input("sampleCount",this.getPropertyUniform("sampleCount")).input("tssaoComposeRate",this.getPropertyUniform("tssaoComposeRate")).input("tssaoShowThreshold",this.getPropertyUniform("tssaoShowThreshold")).input("tssaoComposeThreshold",this.getPropertyUniform("tssaoComposeThreshold")))}}us["b"]([bi("u_sampleCount")],nn.prototype,"sampleCount",void 0),us["b"]([bi("u_tssaoComposeRate")],nn.prototype,"tssaoComposeRate",void 0),us["b"]([bi("u_tssaoShowThreshold")],nn.prototype,"tssaoShowThreshold",void 0),us["b"]([bi("u_tssaoComposeThreshold")],nn.prototype,"tssaoComposeThreshold",void 0);const an=new Ks({source:"\n    float depthVary(vec4 worldPosition){\n      return worldPosition.z / worldPosition.w;\n    }\n    "});class on extends Mi{decorate(t){const e=fi();t.setVertexRoot(e).setVary("depth",an.make().input("worldPosition",e)).setFragmentRoot(Hi.make().input("frag_depth",t.getVary("depth")))}}const hn=new Ks({source:"\n  vec4 TAAMix (vec3 oldColor, vec3 newColor, float sampleCount){\n    float rate = 0.05;\n    // return vec4(newColor * rate + (1.0 - rate) * oldColor, 1.0);\n    \n    return vec4((oldColor * sampleCount + newColor) / (sampleCount + 1.0), 1.0);\n\n    // need figure out how to clamp color\n    // if(sampleCount < 0.1){\n    //   // vec3 clampedOldColor = getClampColor(v_uv, oldColor);\n    //   // return vec4(newColor * rate + (1.0 - rate) * clampedOldColor, 1.0);\n    //   return vec4(newColor * rate + (1.0 - rate) * oldColor, 1.0);\n    // } else{\n    //   return vec4((oldColor * sampleCount + newColor) / (sampleCount + 1.0), 1.0);\n    // }\n\n  }\n    "});class cn extends Mi{constructor(){super(...arguments),this.VPMatrixInverse=new te,this.sampleCount=0}decorate(t){t.setVertexRoot(mi()).declareFragUV();const e=t.getVary(gi),r=Yi.make().input("enc",hi("depthResult").fetch(e)),s=hi("TAAHistoryOld").fetch(si.make().input("ndc",ni.make().input("ndc",ii.make().input("depth",r).input("uv",t.getVary(gi))).input("VPMatrixInverse",this.getPropertyUniform("VPMatrixInverse")).input("LastVPMatrix",ui(Ge.LastVPMatrix))));t.setFragmentRoot(hn.make().input("oldColor",s.swizzling("xyz")).input("newColor",hi("sceneResult").fetch(e).swizzling("xyz")).input("sampleCount",this.getPropertyUniform("sampleCount")))}}us["b"]([bi("VPMatrixInverse")],cn.prototype,"VPMatrixInverse",void 0),us["b"]([bi("u_sampleCount")],cn.prototype,"sampleCount",void 0);class ln extends Lr{constructor(){super(),this.notifyNeedRedecorate=new jr,void 0===this.uniforms&&(this.uniforms=new Map),void 0===this.propertyUniformNameMap&&(this.propertyUniformNameMap=new Map)}decorate(t){t.setFragmentRoot(un.make().input("base",t.getFragRoot()).input("light",this.produceLightFragEffect(t)))}foreachProvider(t){return t(this)}produceLightFragEffect(t){throw new Error("Method not implemented.")}getPropertyUniform(t){const e=this.propertyUniformNameMap.get(t),r=this[t];if(void 0===r)throw"uniform value not given";return li(e,r)}}const un=new Ks({source:"\n  vec4 add(\n    vec4 base,\n    vec4 light){\n      return base + light;\n  }\n  "}),dn=new Ks({source:"\n    vec4 ambientLight(\n      vec3 color\n      ){\n        return vec4(color, 1.0);\n    }\n  "});class pn extends ln{constructor(){super(...arguments),this.color=new Wt(1,1,1)}produceLightFragEffect(t){return dn.make().input("color",this.getPropertyUniform("color"))}}us["b"]([bi("color")],pn.prototype,"color",void 0);const fn=new Ks({source:"\n    vec4 dirLight(\n      vec3 fragPosition,\n      vec3 fragNormal,\n      vec3 lightDirection, \n      vec3 color\n      ){\n        float light = max(0.0, dot(fragNormal, lightDirection));\n        return vec4(light * color, 1.0);\n    }\n  "});class mn extends ln{constructor(){super(...arguments),this.color=new Wt(1,1,1),this.direction=new Wt(1,1,1).normalize()}produceLightFragEffect(t){return fn.make().input("fragPosition",t.getVary(xi)).input("fragNormal",t.getVary(vi)).input("lightDirection",this.getPropertyUniform("direction")).input("color",this.getPropertyUniform("color"))}}us["b"]([bi("u_directionalLight_color")],mn.prototype,"color",void 0),us["b"]([bi("u_directionalLight_direction")],mn.prototype,"direction",void 0);const gn=new Ks({source:"\n    vec4 pointLight(\n      vec3 fragPosition,\n      vec3 fragNormal,\n      vec3 lightPosition, \n      vec3 color,\n      float radius ){\n        float distance = length(fragPosition - lightPosition);\n        if( distance < radius){\n          return vec4(color * (1.0 - distance / radius), 0.0);\n        }\n        return vec4(0.0);\n    }\n  "});class vn extends ln{constructor(){super(...arguments),this.color=new Wt(1,1,1),this.position=new Wt(0,0,0),this.radius=3}produceLightFragEffect(t){return gn.make().input("fragPosition",t.getVary(xi)).input("fragNormal",t.getVary(vi)).input("lightPosition",this.getPropertyUniform("position")).input("color",this.getPropertyUniform("color")).input("radius",this.getPropertyUniform("radius"))}}us["b"]([bi("u_pointLight_color")],vn.prototype,"color",void 0),us["b"]([bi("u_pointLight_lightPosition")],vn.prototype,"position",void 0),us["b"]([bi("u_pointLight_lightRadius")],vn.prototype,"radius",void 0);class xn extends as{constructor(t,e,r,s,i,n,a){super(),this.name="SphereGeometry",this.radius=1,this.widthSegments=10,this.heightSegments=10,this.phiStart=0,this.phiLength=2*Math.PI,this.thetaStart=0,this.thetaLength=2*Math.PI,this.radius=void 0!==t?t:1,this.widthSegments=Math.max(3,Math.floor(e)||8),this.heightSegments=Math.max(2,Math.floor(r)||6),this.phiStart=void 0!==s?s:0,this.phiLength=void 0!==i?i:2*Math.PI,this.thetaStart=void 0!==n?n:0,this.thetaLength=void 0!==a?a:Math.PI,this.thetaEnd=this.thetaStart+this.thetaLength,this.buildShape()}shape(){let t,e,r=0,s=[],i=new Wt(0,0,0),n=new Wt(0,0,0),a=[],o=[],h=[],c=[];for(e=0;e<=this.heightSegments;e++){let a=[],l=e/this.heightSegments;for(t=0;t<=this.widthSegments;t++){let e=t/this.widthSegments;i.x=-this.radius*Math.cos(this.phiStart+e*this.phiLength)*Math.sin(this.thetaStart+l*this.thetaLength),i.y=this.radius*Math.cos(this.thetaStart+l*this.thetaLength),i.z=this.radius*Math.sin(this.phiStart+e*this.phiLength)*Math.sin(this.thetaStart+l*this.thetaLength),o.push(i.x,i.y,i.z),n.set(i.x,i.y,i.z).normalize(),h.push(n.x,n.y,n.z),c.push(e,1-l),a.push(r++)}s.push(a)}for(e=0;e<this.heightSegments;e++)for(t=0;t<this.widthSegments;t++){let r=s[e][t+1],i=s[e][t],n=s[e+1][t],o=s[e+1][t+1];(0!==e||this.thetaStart>0)&&a.push(r,i,o),(e!==this.heightSegments-1||this.thetaEnd<Math.PI)&&a.push(i,n,o)}this.create(a,o,h,c)}}class wn extends as{constructor(t,e,r,s,i,n){super(),this.width=1,this.height=1,this.depth=1,this.widthSegments=1,this.heightSegments=1,this.depthSegments=1,void 0!==t&&(this.width=t),void 0!==e&&(this.height=e),void 0!==r&&(this.depth=r),void 0!==s&&(this.widthSegments=s),void 0!==i&&(this.heightSegments=i),void 0!==n&&(this.depthSegments=n),this.buildShape()}shape(){const t=[],e=[],r=[],s=[];let i=0;function n(n,a,o,h,c,l,u,d,p,f){const m=l/p,g=u/f,v=l/2,x=u/2,w=d/2,y=p+1,_=f+1;let b,M;const C=new Wt;let S=0;for(M=0;M<_;M++){var E=M*g-x;for(b=0;b<y;b++){var T=b*m-v;C[n]=T*h,C[a]=E*c,C[o]=w,e.push(C.x,C.y,C.z),C[n]=0,C[a]=0,C[o]=d>0?1:-1,r.push(C.x,C.y,C.z),s.push(b/p),s.push(1-M/f),S+=1}}for(M=0;M<f;M++)for(b=0;b<p;b++){var A=i+b+y*M,R=i+b+y*(M+1),P=i+(b+1)+y*(M+1),z=i+(b+1)+y*M;t.push(A,R,z),t.push(R,P,z)}i+=S}n("z","y","x",-1,-1,this.depth,this.height,this.width,this.depthSegments,this.heightSegments),n("z","y","x",1,-1,this.depth,this.height,-this.width,this.depthSegments,this.heightSegments),n("x","z","y",1,1,this.width,this.depth,this.height,this.widthSegments,this.depthSegments),n("x","z","y",1,-1,this.width,this.depth,-this.height,this.widthSegments,this.depthSegments),n("x","y","z",1,-1,this.width,this.height,this.depth,this.widthSegments,this.heightSegments),n("x","y","z",-1,-1,this.width,this.height,-this.depth,this.widthSegments,this.heightSegments),this.create(t,e,r,s)}}class yn{constructor(){}}class _n{constructor(t,e,r){this.center=new Wt,this.radius=void 0!==t?t:1,this.polar=void 0!==e?e:0,this.azim=void 0!==r?r:0}set(t,e,r){return this.radius=t,this.polar=e,this.azim=r,this}copy(t){return this.set(t.radius,t.polar,t.azim)}clone(){return new _n(this.radius,this.polar,this.azim)}setFromVector(t){return this.radius=t.length(),0===this.radius?(this.polar=0,this.azim=0):(this.polar=Math.acos(ee.clamp(t.y/this.radius,-1,1)),this.azim=Math.atan2(t.x,t.z)),this}}const bn=new Wt;class Mn extends yn{constructor(t){super(),this.camera=t,this.spherical=new _n,this.rotateAngleFactor=.2,this.panFactor=2e-4,this.zoomFactor=.3,this.maxPolarAngle=179/180*Math.PI,this.minPolarAngle=.1,this.sphericalDelta=new _n(0,0,0),this.zooming=1,this.panOffset=new Wt,this.enableDamping=!0,this.zoomingDampingFactor=.1,this.rotateDampingFactor=.1,this.panDampingFactor=.1,this.rotate=t=>{const e=5e3*this.camera.width,r=5e3*this.camera.height;this.sphericalDelta.polar+=t.y/r*Math.PI*this.rotateAngleFactor,this.sphericalDelta.azim+=t.x/e*Math.PI*this.rotateAngleFactor,this.needUpdate=!0},this.zoom=t=>{this.zooming=1+(t-1)*this.zoomFactor,this.needUpdate=!0},this.move=t=>{t.rotate(-this.spherical.azim).multiplyScalar(this.spherical.radius*this.panFactor),this.panOffset.x+=t.x,this.panOffset.z+=t.y,this.needUpdate=!0},this.needUpdate=!0,this.camera=t;const e=new Wt;e.copy(t.transform.position).sub(this.spherical.center),this.spherical.setFromVector(e)}registerInteractor(t){void 0!==this.interactor&&this.interactor.unbindControllerAllListener(this),this.interactor=t,this.interactor.bindLeftMouseMove(this,this.rotate),this.interactor.bindRightMouseMove(this,this.move),this.interactor.bindMouseWheel(this,this.zoom)}update(){(Math.abs(this.sphericalDelta.azim)>1e-4||Math.abs(this.sphericalDelta.polar)>1e-4||Math.abs(this.sphericalDelta.radius)>1e-4||Math.abs(this.zooming-1)>1e-4||this.panOffset.mag()>1e-4)&&(this.needUpdate=!0),this.needUpdate&&(this.spherical.radius*=this.zooming,this.spherical.azim+=this.sphericalDelta.azim,this.spherical.polar=ee.clamp(this.spherical.polar+this.sphericalDelta.polar,this.minPolarAngle,this.maxPolarAngle),this.spherical.center.add(this.panOffset),bn.setFromSpherical(this.spherical).add(this.spherical.center),this.camera.transform.position.copy(bn),this.camera.lookAt(this.spherical.center)),this.needUpdate=!1,!0===this.enableDamping?(this.sphericalDelta.azim*=1-this.rotateDampingFactor,this.sphericalDelta.polar*=1-this.rotateDampingFactor,this.zooming=this.zooming+(1-this.zooming)*this.zoomingDampingFactor,this.panOffset.multiplyScalar(1-this.panDampingFactor)):(this.sphericalDelta.set(0,0,0),this.zooming=1,this.panOffset.set(0,0,0))}}const Cn=new Wt,Sn=new Wt,En=new Wt,Tn=new Wt,An=new Wt,Rn=new Wt;function Pn(t){const e=t.length,r=9,s=new Float32Array(e);for(let i=0;i<e;i+=r)Cn.set(t[i+0],t[i+1],t[i+2]),Sn.set(t[i+3],t[i+4],t[i+5]),En.set(t[i+6],t[i+7],t[i+8]),Tn.copy(Sn).sub(Cn),An.copy(En).sub(Cn),Rn.crossVectors(Tn,An),Rn.normalize(),s[i+0]=Rn.x,s[i+1]=Rn.y,s[i+2]=Rn.z,s[i+3]=Rn.x,s[i+4]=Rn.y,s[i+5]=Rn.z,s[i+6]=Rn.x,s[i+7]=Rn.y,s[i+8]=Rn.z;return s}class zn{constructor(){this.name="unnamed loader"}}class Nn extends zn{}class On extends Nn{constructor(){super(...arguments),this.vertexPattern=/v( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,this.normalPattern=/vn( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,this.uvPattern=/vt( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,this.facePattern1=/f\s+(([\d]{1,}[\s]?){3,})+/,this.facePattern2=/f\s+((([\d]{1,}\/[\d]{1,}[\s]?){3,})+)/,this.facePattern3=/f\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){3,})+)/,this.facePattern4=/f\s+((([\d]{1,}\/\/[\d]{1,}[\s]?){3,})+)/,this.positions=[],this.normals=[],this.uvs=[],this.indicesForArtgl=[],this.wrappedPositionForArtgl=[],this.wrappedUvsForArtgl=[],this.wrappedNormalsForArtgl=[],this.tuplePosNorm=[],this.curPositionInIndices=0,this.setDataForCurrentFaceWithPattern4=t=>{const e=this.collectTriangle(t);for(var r=0;r<e.length;r++){var s=e[r].split("//"),i=parseInt(s[0])-1,n=parseInt(s[1])-1;this.setData(i,1,n,this.positions[i],new ce(0,0),this.normals[n])}}}collectTriangle(t){const e=[];return this.getTriangles(t,1,e),e}getTriangles(t,e,r){e+1<t.length&&(r.push(t[0],t[e],t[e+1]),e+=1,this.getTriangles(t,e,r))}reset(){this.positions=[],this.normals=[],this.uvs=[],this.indicesForArtgl=[],this.wrappedPositionForArtgl=[],this.wrappedUvsForArtgl=[],this.wrappedNormalsForArtgl=[],this.tuplePosNorm=[],this.curPositionInIndices=0}isInArray(t,e){this.tuplePosNorm[t]||(this.tuplePosNorm[t]={normals:[],idx:[]});const r=this.tuplePosNorm[t].normals.indexOf(e);return-1===r?-1:this.tuplePosNorm[t].idx[r]}setData(t,e,r,s,i,n){const a=-1;-1===a?(this.indicesForArtgl.push(this.wrappedPositionForArtgl.length),this.wrappedPositionForArtgl.push(s),this.wrappedUvsForArtgl.push(i),this.wrappedNormalsForArtgl.push(n),this.curPositionInIndices++):this.indicesForArtgl.push(a)}setDataForCurrentFaceWithPattern1(t){const e=this.collectTriangle(t);for(var r=0;r<e.length;r++){var s=parseInt(e[r])-1;this.setData(s,0,0,this.positions[s],new ce,new Wt(0,1,0))}}setDataForCurrentFaceWithPattern2(t){const e=this.collectTriangle(t);for(var r=0;r<e.length;r++){var s=e[r].split("/"),i=parseInt(s[0])-1,n=parseInt(s[1])-1;this.setData(i,n,0,this.positions[i],this.uvs[n],new Wt(0,1,0))}}setDataForCurrentFaceWithPattern3(t){const e=this.collectTriangle(t);for(var r=0;r<e.length;r++){var s=e[r].split("/"),i=parseInt(s[0])-1,n=parseInt(s[1])-1,a=parseInt(s[2])-1;this.setData(i,n,a,this.positions[i],this.uvs[n],this.normals[a])}}parse(t,e){this.reset();const r=t.split("\n");for(let h=0;h<r.length;h++){const t=r[h].trim();let e;0!==t.length&&"#"!==t.charAt(0)&&(null!==(e=this.vertexPattern.exec(t))?this.positions.push(new Wt(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]))):null!==(e=this.normalPattern.exec(t))?this.normals.push(new Wt(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]))):null!==(e=this.uvPattern.exec(t))?this.uvs.push(new ce(parseFloat(e[1]),parseFloat(e[2]))):null!==(e=this.facePattern3.exec(t))?this.setDataForCurrentFaceWithPattern3(e[1].trim().split(" ")):null!==(e=this.facePattern4.exec(t))?this.setDataForCurrentFaceWithPattern4(e[1].trim().split(" ")):null!==(e=this.facePattern2.exec(t))?this.setDataForCurrentFaceWithPattern2(e[1].trim().split(" ")):null!==(e=this.facePattern1.exec(t))?this.setDataForCurrentFaceWithPattern1(e[1].trim().split(" ")):console.log("Unhandled expression at line : "+t))}const s=[];this.wrappedPositionForArtgl.forEach(t=>{s.push(t.x),s.push(t.y),s.push(t.z)});const i=[];this.wrappedUvsForArtgl.forEach(t=>{i.push(t.x),i.push(t.y)});let n=[];const a=!1;a?n=Array.from(Pn(new Float32Array(s))):(n=[],this.wrappedNormalsForArtgl.forEach(t=>{n.push(t.x),n.push(t.y),n.push(t.z)}));const o=as.create(this.indicesForArtgl,s,n,i);return o.name=e?"ObjFile-"+e:"ObjFile-unnamed",o}}const Fn=new Ks({source:"vec3 LinearToneMapping(vec3 intensity, float toneMappingExposure){\n      return toneMappingExposure * intensity;\n    }"}),Dn=new Ks({source:"\n    vec3 Uncharted2Helper(vec3 x){\n      return max(((x * (0.15 * x + 0.10 * 0.50 ) + 0.20 * 0.02) / (x * (0.15 * x + 0.50) + 0.20 * 0.30)) - 0.02/0.30, vec3(0.0));\n    }\n    "}),In=new Ks({source:"\n    vec3 Uncharted2ToneMapping(\n      vec3 intensity, \n      float toneMappingExposure,\n      float toneMappingWhitePoint\n      ) {\n        intensity *= toneMappingExposure;\n        return Uncharted2Helper(intensity) / Uncharted2Helper(vec3(toneMappingWhitePoint));\n    }\n    ",description:"John Hable's filmic operator from Uncharted 2 video game",dependFunction:[Dn]});var Ln;(function(t){t["Linear"]="Linear",t["Uncharted2ToneMapping"]="Uncharted2ToneMapping"})(Ln||(Ln={})),console.log(Ln);class Vn extends Mi{constructor(){super(...arguments),this.toneMappingExposure=1,this.toneMappingWhitePoint=1,this.toneMapType=Ln.Uncharted2ToneMapping}getToneMapFunction(){switch(this.toneMapType){case Ln.Linear:return Fn.make().input("toneMappingExposure",this.getPropertyUniform("toneMappingExposure"));case Ln.Uncharted2ToneMapping:return In.make().input("toneMappingExposure",this.getPropertyUniform("toneMappingExposure")).input("toneMappingWhitePoint",this.getPropertyUniform("toneMappingWhitePoint"))}}decorate(t){t.setFragmentRoot(di(this.getToneMapFunction().input("intensity",t.getFragRoot().swizzling("xyz")),pi(1)))}}us["b"]([bi("toneMappingExposure")],Vn.prototype,"toneMappingExposure",void 0),us["b"]([bi("toneMappingWhitePoint")],Vn.prototype,"toneMappingWhitePoint",void 0),us["b"]([_i()],Vn.prototype,"toneMapType",void 0);var Un=function(t,e){const r=new xn(1,40,40),s=new os(10,10,10,10),i=new wn(5,3,4),n=new vn;n.position=new Wt(0,3,0),n.color=new Wt(.9,.8,.5),n.radius=10;const a=new pn;a.color=new Wt(.3,.3,.4);const o=new mn;o.color=new Wt(.3,.6,.4),o.direction=new Wt(1,1,-1).normalize();const h=new Vn;let c=(new yi).decorate(n).decorate(a).decorate(o).decorate(h);console.log(h),c.afterShaderCompiled.add(t=>{console.log(t)});const l=(new Qr).g(s).s(c);t.addChild(l);const u=(new Qr).g(s).s(c);u.transform.position.y=-2,u.transform.rotation.x=-Math.PI/4,u.transform.rotation.y=-Math.PI/4,t.addChild(u);const d=(new Qr).g(i).s(c);d.transform.position.y=-2,t.addChild(d);const p=5,f=1;for(let m=0;m<p;m++){const e=new Lr;e.transform.position.x=m*f,t.addChild(e);for(let t=0;t<p;t++){const s=new Lr;s.transform.position.y=t*f,e.addChild(s);for(let t=0;t<p;t++){const e=(new Qr).g(r).s(c);e.transform.position.z=t*f,e.transform.scale.setAll(.3),s.addChild(e)}}}return{name:"exposureControl",value:[{name:"exposureMax",value:1/h.toneMappingExposure,onChange:t=>{h.toneMappingExposure=1/t,e.pipeline.resetSample()},editors:[{type:"slider",min:0,max:5,step:.1}]},{name:"exposureWhitePoint",value:h.toneMappingWhitePoint,onChange:t=>{h.toneMappingWhitePoint=t,e.pipeline.resetSample()},editors:[{type:"slider",min:0,max:5,step:.1}]},{name:"exposureToneMapType",value:h.toneMapType,valueConfig:{type:"select",selectItem:Object.keys(Ln)},onChange:t=>{h.toneMapType=t,e.pipeline.resetSample()}}]}};function kn(t,e){return{name:"root",type:"folder",value:[{name:"canvas",value:[{name:"renderSize",value:[{name:"width",value:t.renderer.width,onChange:r=>{e.resetSample(),t.setActualSize(r,t.renderer.height)},editors:[{type:"slider",min:10,max:500,step:1}]},{name:"height",value:t.renderer.height,onChange:r=>{e.resetSample(),t.setActualSize(t.renderer.width,r)},editors:[{type:"slider",min:10,max:500,step:1}]}]}]},{name:"engine",value:[{name:"preferUseVAO",value:t.preferVAO,onChange:e=>{t.preferVAO=e}},{name:"enableUniformDiffUpload",value:t.renderer.enableUniformDiff,onChange:e=>{t.renderer.enableUniformDiff=e},description:"this is a demo description"},{name:"TAA",value:[{name:"enable",value:e.enableTAA,onChange:t=>{e.enableTAA=t,t||e.resetSample()}}]},{name:"TSSAO",value:[{name:"enable",value:e.enableTSSAO,onChange:t=>{e.enableTSSAO=t,e.composeShading.tssaoComposeRate=t?1:0}},{name:"composeRate",value:e.composeShading.tssaoComposeRate,onChange:t=>{e.composeShading.tssaoComposeRate=t},editors:[{type:"slider",min:0,max:4,step:.1}]},{name:"composeThreshold",value:e.composeShading.tssaoComposeThreshold,onChange:t=>{e.composeShading.tssaoComposeThreshold=t},editors:[{type:"slider",min:0,max:4,step:.1}]},{name:"radius",value:e.tssaoShading.aoRadius,onChange:t=>{e.tssaoShading.aoRadius=t,e.resetSample()},editors:[{type:"slider",min:.1,max:10,step:.1}]},{name:"sample_count_to_show",value:e.composeShading.tssaoShowThreshold,onChange:t=>{e.composeShading.tssaoShowThreshold=t},editors:[{type:"slider",min:1,max:1e3,step:20}]}]}]}]}}class Bn{constructor(){this.graph=new ji,this.composer=new Gi,this.enableTAA=!0,this.taaShading=new cn,this.taaShader=(new yi).decorate(this.taaShading),this.enableTSSAO=!0,this.tssaoShading=new rn,this.tssaoShader=(new yi).decorate(this.tssaoShading),this.composeShading=new nn,this.composeShader=(new yi).decorate(this.composeShading),this.depthShader=(new yi).decorate(new on),this.sampleCount=0,this.tickNum=0}resetSample(){this.sampleCount=0}get isEvenTick(){return this.tickNum%2===0}render(t,e){this.tickNum++,t.connectCamera(),t.isCameraChanged||e.isFrameChange?this.sampleCount=0:this.enableTAA&&t.jitterProjectionMatrix(),this.graph.update(t,this.composer),this.composer.render(t,this.graph)}build(t,e){this.config=kn(t,this),this.graph.defineGraph(this.composer,{renderTargets:[{name:ji.screenRoot,from:()=>"CopyToScreen"},{name:"sceneResult",from:()=>"SceneOrigin"},{name:"depthResult",from:()=>"Depth"},{name:"TAAHistoryA",from:()=>this.isEvenTick?null:"TAA"},{name:"TAAHistoryB",from:()=>this.isEvenTick?"TAA":null},{name:"TSSAOHistoryA",from:()=>this.isEvenTick?null:"TSSAO"},{name:"TSSAOHistoryB",from:()=>this.isEvenTick?"TSSAO":null}],passes:[{name:"SceneOrigin",source:[e]},{name:"Depth",shading:this.depthShader,source:[e]},{name:"TAA",inputs:()=>{return{sceneResult:"sceneResult",depthResult:"depthResult",TAAHistoryOld:this.isEvenTick?"TAAHistoryA":"TAAHistoryB"}},shading:this.taaShader,source:[ji.quadSource],enableColorClear:!1,beforePassExecute:()=>{t.unJit();const e=t.getGlobalUniform(Ge.VPMatrix).value;this.taaShading.VPMatrixInverse=this.taaShading.VPMatrixInverse.getInverse(e,!0),this.taaShading.sampleCount=this.sampleCount}},{name:"TSSAO",inputs:()=>{return{depthResult:"depthResult",AOAcc:this.isEvenTick?"TSSAOHistoryA":"TSSAOHistoryB"}},shading:this.tssaoShader,source:[ji.quadSource],enableColorClear:!1,beforePassExecute:()=>{const e=t.getGlobalUniform(Ge.VPMatrix).value;this.tssaoShading.VPMatrixInverse=this.tssaoShading.VPMatrixInverse.getInverse(e,!0),this.tssaoShading.sampleCount=this.sampleCount}},{name:"CopyToScreen",enableColorClear:!1,inputs:()=>{let t,e;return t=this.enableTAA?this.isEvenTick?"TAAHistoryB":"TAAHistoryA":"sceneResult",e=this.enableTSSAO?this.isEvenTick?"TSSAOHistoryB":"TSSAOHistoryA":"sceneResult",{basic:t,tssao:e}},beforePassExecute:()=>{this.composeShading.sampleCount=this.sampleCount},afterPassExecute:()=>{this.sampleCount++},shading:this.composeShader,source:[ji.quadSource]}]})}}const Gn=new Wt,jn=new Wt,$n=new Wt,qn=new Wt,Xn=new Wt;class Wn{constructor(t,e){this.origin=void 0!==t?t:new Wt,this.direction=void 0!==e?e:new Wt(0,0,1)}clone(){return(new Wn).copy(this)}copy(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this}lookAt(t){return this.direction.copy(t).sub(this.origin).normalize(),this}at(t,e){return e.copy(this.direction).multiplyScalar(t).add(this.origin)}intersectTriangle(t,e,r,s,i){jn.subVectors(e,t),$n.subVectors(r,t),qn.crossVectors(jn,$n);var n,a=this.direction.dot(qn);if(a>0){if(s)return null;n=1}else{if(!(a<0))return null;n=-1,a=-a}Gn.subVectors(this.origin,t);var o=n*this.direction.dot($n.crossVectors(Gn,$n));if(o<0)return null;var h=n*this.direction.dot(jn.cross(Gn));if(h<0)return null;if(o+h>a)return null;var c=-n*Gn.dot(qn);return c<0?null:this.at(c/a,i)}ifIntersectSphere(t){return this.distanceSqToPoint(t.center)<=t.radius*t.radius}distanceToPoint(t){return Math.sqrt(this.distanceSqToPoint(t))}distanceSqToPoint(t){var e=Xn.subVectors(t,this.origin).dot(this.direction);return e<0?this.origin.distanceToSquared(t):(Xn.copy(this.direction).multiplyScalar(e).add(this.origin),Xn.distanceToSquared(t))}applyMatrix4(t){return this.origin.applyMatrix4(t),this.direction.transformDirection(t),this}}class Hn{constructor(){this.near=0,this.far=1,this.worldRay=new Wn,this.localRay=new Wn}update(t,e,r){t.updateRaycaster(this,e,r)}getLocalRay(t){return this.localRay.copy(this.worldRay).applyMatrix4(t)}pick(t,e){const r=[];return Ai(t,t=>{!0===t.raycasterable&&(void 0===e||e(t))&&t.raycast(this,r)}),r}pickFirst(t,e){}}const Yn="http://localhost:3000/";class Zn{constructor(){this.framer=new Oi,this.hasInitialized=!1,this.scene=new ki,this.raycaster=new Hn,this.backgroundColor=new Ht,this.onContainerResize=()=>{const t=this.el.offsetWidth,e=this.el.offsetHeight;this.engine.setSize(t,e),this.engine.camera.aspect=t/e},this.sampleCount=0,this.beforeRender=new jr,this.afterRender=new jr,this.render=()=>{this.beforeRender.notifyObservers(this.engine),this.orbitController.update(),this.engine.renderer.state.colorbuffer.setClearColor(this.backgroundColor),this.pipeline.render(this.engine,this.scene),this.afterRender.notifyObservers(this.engine),this.engine.renderer.stat.reset()}}initialize(t){this.el=t,this.engine=new zi(t),this.pipeline=new Bn,this.pipeline.build(this.engine,this.scene),this.engine.camera.transform.position.set(20,10,10),this.orbitController=new Mn(this.engine.camera),this.orbitController.registerInteractor(this.engine.interactor),this.hasInitialized=!0,this.createScene(this.scene),window.addEventListener("resize",this.onContainerResize),this.onContainerResize(),this.framer.setFrame(this.render)}unintialize(){window.removeEventListener("resize",this.onContainerResize),this.engine=null,this.pipeline=null,this.framer.stop(),this.framer.setFrame(null),this.el=null}notifyResize(){this.onContainerResize()}pickColor(t,e){const r=this.engine.renderer.framebufferManager.getFramebuffer("sceneResult"),s=new Uint8Array(10);r.readPixels(t*this.engine.renderer.width,e*this.engine.renderer.height,1,1,s),console.log(`${s[0]}`),this.raycaster.update(this.engine.camera,2*t-1,2*e-1);const i=this.raycaster.pick(this.scene);console.log(i)}run(){this.engine.interactor.enabled=!0,this.framer.run()}stop(){this.engine.interactor.enabled=!1,this.framer.stop()}step(){this.framer.step()}createScene(t){const e=Un(t.root,this);return this.pipeline.config.value.push(e),t}loadOBJFromURL(){return a["a"](this,void 0,void 0,function*(){const t=new On,e=yield fetch(Yn+"obj/chair.obj"),r=yield e.text(),s=t.parse(r),i=new Qr;i.geometry=s,this.scene.root.addChild(i)})}}let Qn=new Zn,Kn=class extends o["e"]{hide(){return a["a"](this,void 0,void 0,function*(){this.$store.state.showConfigPanel=!1,yield this.$nextTick(),Qn.notifyResize()})}};a["b"]([Object(o["c"])()],Kn.prototype,"appConfig",void 0),Kn=a["b"]([Object(o["a"])({components:{Config:Ft}})],Kn);var Jn=Kn,ta=Jn,ea=(r("11c9"),Object(p["a"])(ta,R,P,!1,null,"035897bd",null)),ra=ea.exports,sa=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"scene-panel"},[t._e(),r("div",{staticClass:"panel-title"},[t._v("Scene explorer\n    "),r("button",{on:{click:t.sync}},[t._v("sync")]),r("button",{on:{click:t.hide}},[t._v("hide")])]),r("nav",{staticClass:"scene-nav"},t._l(t.nav,function(e){return r("div",{key:e,class:{"current-nav":e===t.currentNav},on:{click:function(r){t.currentNav=e}}},[t._v(t._s(e))])}),0),t.sceneView?r("div",{staticClass:"view-wrap"},["hierarchy"===t.currentNav?r("NodeView",{attrs:{view:t.sceneView.root},on:{nodeChange:t.catchChange}}):t._e(),"geometry"===t.currentNav?r("GeometryViewPanel",{attrs:{view:t.sceneView}}):t._e(),"material"===t.currentNav?r("MaterialViewPanel",{attrs:{view:t.sceneView}}):t._e()],1):t._e(),r("div",{staticClass:"render-info"},[r("div",{staticClass:"panel-title"},[t._v("RenderInfo")]),t.renderView?r("div",{staticClass:"render-info-group"},[r("div",[t._v("\n        activeProgramCount: "+t._s(t.renderView.compiledPrograms)+"\n      ")]),r("div",[t._v("\n        programswitch: "+t._s(t.renderView.programSwitchCount)+"\n      ")]),r("div",[t._v("\n        drawcall: "+t._s(t.renderView.drawcall)+"\n      ")]),r("div",[t._v("\n        uniformUpload: "+t._s(t.renderView.uniformUpload)+"\n      ")]),r("div",[t._v("\n        faceDraw: "+t._s(t.renderView.faceDraw)+"\n      ")]),r("div",[t._v("\n        vertexDraw: "+t._s(t.renderView.vertexDraw)+"\n      ")])]):r("div",{staticClass:"render-info-group"},[t._v("\n      sync scene to get synced render info stat\n    ")])])],1)},ia=[];const na=new On;class aa{static create(t){const e=new aa;e.uuid=t.uuid,e.name=void 0===t.name?"unnamed":t.name,e.buffers=[];for(const r in t._bufferDatum)if(t._bufferDatum.hasOwnProperty(r)){const s=t._bufferDatum[r];e.buffers.push({name:r,type:"bufferdata",dataByteSize:s.getDataSizeByte()})}return t.indexBuffer&&e.buffers.push({name:"index",type:"indexbuffer",dataByteSize:t.indexBuffer.getDataSizeByte()}),e}}class oa{static create(t){const e=new oa;return e.uuid=t.uuid,e}}class ha{constructor(){this.geometries=new Map,this.materials=new Map}collectEntity(t){if(t instanceof Qr){const e=t.geometry,r=t.material;void 0!==e&&(this.geometries.has(e.uuid)||this.geometries.set(e.uuid,aa.create(e))),void 0!==r&&(this.geometries.has(r.uuid)||this.materials.set(r.uuid,oa.create(r)))}}static create(t){const e=new ha;return e.root=t.root.map(t=>{return e.collectEntity(t),ca.create(t)}),e}static deleteNode(t,e){const r=e.root.findSubNode(t);void 0!==r&&(r.parent?r.parent.removeChild(r):e.setRootNode(new Lr))}static loadObj(t,e){return a["a"](this,void 0,void 0,function*(){const r=e.root.findSubNode(t);if(void 0===r)return;const s=yield ms();if(!s&&0===s.length)return;const i=na.parse(s),n=new Qr;n.geometry=i,n.shading=(new yi).decorate(new Wi),r.addChild(n)})}}class ca{constructor(){this.position=new Wt,this.type="node",this.children=[]}static create(t){const e=new ca;return e.position.copy(t.transform.position),e.uuid=t.uuid,t instanceof Qr&&(e.type="mesh"),e}}class la{constructor(){this.faceDraw=0,this.vertexDraw=0}static create(t){const e=t.renderer,r=new la;return r.compiledPrograms=e.programManager.compiledProgramsCount,r.updateFrameInfo(t),r}updateFrameInfo(t){this.programSwitchCount=t.renderer.stat.programSwitch,this.uniformUpload=t.renderer.stat.uniformUpload,this.drawcall=t.renderer.stat.drawcall,this.faceDraw=t.renderer.stat.faceDraw,this.vertexDraw=t.renderer.stat.vertexDraw}}var ua=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"geometry-view"},t._l(t.geometrylist,function(e){return r("div",{key:e.uuid},[r("span",[t._v("\n    "+t._s(e.name)+"-"+t._s(e.uuid.slice(0,6))+"\n  ")]),t.expandDetail?r("div",{staticClass:"buffer-detail"},t._l(e.buffers,function(e){return r("div",{key:e.name},[t._v("\n      "+t._s(e.name)+" - "+t._s(Math.ceil(e.dataByteSize/1024*10)/10)+"KB\n      ")])}),0):t._e()])}),0)},da=[];let pa=class extends o["e"]{constructor(){super(...arguments),this.expandDetail=!0}get geometrylist(){const t=[];return this.view.geometries.forEach(e=>{t.push(e)}),t}};a["b"]([Object(o["c"])()],pa.prototype,"view",void 0),pa=a["b"]([Object(o["a"])({components:{}})],pa);var fa=pa,ma=fa,ga=(r("4e23"),Object(p["a"])(ma,ua,da,!1,null,"6d5074e5",null)),va=ga.exports,xa=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"material-view"},[0===t.materiallist.length?r("div",[t._v("\n    no material found\n  ")]):t._e(),t._l(t.materiallist,function(e){return r("div",{key:e.uuid},[r("span",[t._v("\n      "+t._s(e.name)+"-"+t._s(e.uuid.slice(0,6))+"\n    ")]),t.expandDetail?r("div",{staticClass:"channel-detail"}):t._e()])})],2)},wa=[],ya=function(){var t=this,e=t.$createElement;t._self._c;return t._m(0)},_a=[function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",[r("button",[t._v("upload")])])}];class ba extends o["e"]{}var Ma=ba,Ca=Object(p["a"])(Ma,ya,_a,!1,null,null,null),Sa=Ca.exports;let Ea=class extends o["e"]{constructor(){super(...arguments),this.expandDetail=!0}get materiallist(){const t=[];return this.view.materials.forEach(e=>{t.push(e)}),t}};a["b"]([Object(o["c"])()],Ea.prototype,"view",void 0),Ea=a["b"]([Object(o["a"])({components:{ChannelEditor:Sa}})],Ea);var Ta=Ea,Aa=Ta,Ra=Object(p["a"])(Aa,xa,wa,!1,null,"2b822b43",null),Pa=Ra.exports,za=function(){var t=this,e=t.$createElement;t._self._c;return t._m(0)},Na=[function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"object-panel"},[r("button",[t._v("X")])])}];let Oa=class extends o["e"]{};Oa=a["b"]([Object(o["a"])({components:{}})],Oa);var Fa=Oa,Da=Fa,Ia=(r("a1ed"),Object(p["a"])(Da,za,Na,!1,null,"1d29f434",null)),La=Ia.exports,Va=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"node-view"},[r("div",{staticClass:"title"},[r("div",{class:{expandable:t.hasChildren},on:{click:function(e){t.isExpand=!t.isExpand}}},[t.hasChildren&&!t.isExpand?r("span",[t._v(" + ")]):t._e(),t.hasChildren&&t.isExpand?r("span",[t._v(" = ")]):t._e(),t._v("\n\n      "+t._s(t.view.type)+" - "+t._s(t.clampId)+"\n    ")]),r("button",{on:{click:function(e){t.showMenu=!0}}},[t._v("*")])]),t.showMenu?r("div",{staticClass:"menu"},[r("button",{on:{click:t.emitDelete}},[t._v("delete")]),r("button",{on:{click:t.emitLoadObj}},[t._v("loadobj")])]):t._e(),t.showMenu?r("div",{staticClass:"mask",on:{click:function(e){t.showMenu=!1}}}):t._e(),t.isExpand?r("div",{staticClass:"children"},t._l(t.view.children,function(e){return r("scene-node-view",{key:e.uuid,attrs:{view:e},on:{nodeChange:t.emitChange}})}),1):t._e()])},Ua=[],ka=function(t,e,r,s){var i,n=arguments.length,a=n<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,r):s;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)a=Reflect.decorate(t,e,r,s);else for(var o=t.length-1;o>=0;o--)(i=t[o])&&(a=(n<3?i(a):n>3?i(e,r,a):i(e,r))||a);return n>3&&a&&Object.defineProperty(e,r,a),a};let Ba=class extends o["e"]{constructor(){super(...arguments),this.showMenu=!1,this.isExpand=!0}get clampId(){return this.view.uuid.slice(0,6)}get hasChildren(){return this.view.children.length}emitLoadObj(){this.emitChange({type:"load",id:this.view.uuid})}emitDelete(){this.emitChange({type:"delete",id:this.view.uuid})}emitChange(t){this.$emit("nodeChange",t),this.showMenu=!1}};ka([Object(o["c"])()],Ba.prototype,"view",void 0),Ba=ka([Object(o["a"])({name:"scene-node-view"})],Ba);var Ga=Ba,ja=Ga,$a=(r("0ae1"),Object(p["a"])(ja,Va,Ua,!1,null,"85464e1a",null)),qa=$a.exports;let Xa=class extends o["e"]{constructor(){super(...arguments),this.sceneView=null,this.renderView=null,this.nav=["hierarchy","technique","geometry","material"],this.currentNav="hierarchy"}sync(){this.sceneView=ha.create(Qn.scene),this.renderView=la.create(Qn.engine),this.afterObs&&Qn.afterRender.remove(this.afterObs),this.afterObs=Qn.afterRender.add(t=>{this.renderView.updateFrameInfo(t)})}hide(){return a["a"](this,void 0,void 0,function*(){this.$store.state.showScenePanel=!1,yield this.$nextTick(),Qn.notifyResize()})}beforeDestroy(){this.afterObs&&Qn.afterRender.remove(this.afterObs)}catchChange(t){return a["a"](this,void 0,void 0,function*(){"delete"===t.type?ha.deleteNode(t.id,Qn.scene):"load"===t.type?yield ha.loadObj(t.id,Qn.scene):(console.log("unkown change"),console.log(t)),this.sync()})}};Xa=a["b"]([Object(o["a"])({components:{NodeView:qa,ObjectPanel:La,GeometryViewPanel:va,MaterialViewPanel:Pa}})],Xa);var Wa=Xa,Ha=Wa,Ya=(r("a656"),Object(p["a"])(Ha,sa,ia,!1,null,"2e8def07",null)),Za=Ya.exports,Qa=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"canvas-wrap"},[r("canvas",{attrs:{id:"viewer-canvas"},on:{click:t.pick}}),t.isRunning?t._e():r("div",{staticClass:"stop-notation"},[t._v("STOPPED")]),t.showGraphViewer?r("div",{staticClass:"graph-viewer-wrap"},[r("div",{staticStyle:{position:"absolute",bottom:"0px","pointer-events":"auto"}},[r("button",{on:{click:t.layout}},[t._v("layout")])]),r("GraphView",{attrs:{board:t.board},on:{updateAllViewport:t.updateAllViewport}},t._l(t.nodes,function(e){return r("DAGNodeView",{key:e.node.uuid,ref:"vueNodes",refInFor:!0,attrs:{node:e.node,layout:e.layout,boardInfo:t.board},on:{updateViewport:t.updateViewport,updateLine:t.updateLine}},[t.isRenderTargetNode(e.node)?r("RenderTargetNodeView",{attrs:{node:e.node,layout:e.layout},on:{updateSize:t.updateViewport}}):t._e()],1)}),1),r("LineHUDCanvas",{attrs:{lines:t.lines,boardInfo:t.board}})],1):t._e(),r("div",{staticClass:"command-bar"},[t.isRunning?t._e():r("button",{on:{click:t.run}},[t._v("run")]),t.isRunning?r("button",{on:{click:t.stop}},[t._v("stop")]):t._e(),t.isRunning?t._e():r("button",{on:{click:t.step}},[t._v("step next frame")]),t.isRunning?t._e():r("button",{attrs:{disabled:""},on:{click:t.screenshot}},[t._v("download screenshot")]),t.showGraphViewer?t._e():r("button",{on:{click:t.inspectGraph}},[t._v("inspectGraph")]),t.showGraphViewer?r("button",{on:{click:t.closeGraphInspector}},[t._v("closeGraphViewer")]):t._e(),r("button",{on:{click:t.showScenePanel}},[t._v("show scene panel")]),r("button",{on:{click:t.showConfigPanel}},[t._v("show config panel")])])])},Ka=[],Ja=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"graph-viewer",attrs:{tabindex:"-1"}},[r("div",{style:{transform:t.transform}},[t._t("default")],2),t.showMove?r("div",{staticClass:"mask",on:{mousedown:t.startDrag}}):t._e(),r("div",{staticClass:"ops"},[t.showMove?t._e():r("button",{on:{click:function(e){t.showMove=!0}}},[t._v("move")]),t.showMove?r("button",{on:{click:function(e){t.showMove=!1}}},[t._v("unmove")]):t._e()])])},to=[];let eo=class extends o["e"]{constructor(){super(...arguments),this.showMove=!1,this.isDragging=!1}get transform(){return`translate(${this.board.transformX}px, ${this.board.transformY}px)`}startDrag(t){this.isDragging=!0,this.screenOriginX=t.screenX,this.screenOriginY=t.screenY,this.originTransformX=this.board.transformX,this.originTransformY=this.board.transformY,window.addEventListener("mousemove",this.dragging),window.addEventListener("mouseup",t=>{this.isDragging=!1,window.removeEventListener("mousemove",this.dragging)})}dragging(t){this.board.transformX=this.originTransformX+t.screenX-this.screenOriginX,this.board.transformY=this.originTransformY+t.screenY-this.screenOriginY,this.$emit("updateAllViewport")}mounted(){this.updateBoard(),window.addEventListener("resize",this.updateBoard)}beforeDestroy(){window.removeEventListener("resize",this.updateBoard)}updateBoard(){this.board.width=this.$el.clientWidth,this.board.height=this.$el.clientHeight,this.$emit("updateAllViewport")}};a["b"]([Object(o["c"])({required:!0})],eo.prototype,"board",void 0),eo=a["b"]([Object(o["a"])({components:{}})],eo);var ro=eo,so=ro,io=(r("5763"),Object(p["a"])(so,Ja,to,!1,null,"20b4d88e",null)),no=io.exports,ao=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"dag-node",style:{left:t.viewPositionX,top:t.viewPositionY,width:t.viewWidth}},[r("div",{staticClass:"node-title",style:{cursor:this.isDragging?"grabbing":""},on:{mousedown:t.startDrag}},[r("span",[t._v(t._s(t.node.constructor.name)+": "+t._s(t.node.uuid.slice(0,4)))])]),t._t("default")],2)},oo=[];function ho(t){return{x:t.absX+t.width,y:t.absY+10}}function co(t,e,r=300){const s=[];function i(t){s.forEach(e=>{const r=e.indexOf(t);-1!==r&&e.splice(r,1)})}function n(t,e){let r=s[e];void 0===r&&(s[e]=[],r=s[e]),i(t),r.push(t),t.fromNodes.forEach(t=>{n(t,e+1)})}n(t,0),s.reverse().forEach((t,s)=>{t.forEach((t,i)=>{const n=e[t.uuid];if(void 0===n)throw"cant find nodes layout";n.absX=s*r,n.absY=i*r})})}class lo{constructor(){this.startX=0,this.startY=0,this.endX=0,this.endY=0}draw(t,e){const r=t.ctx;r.beginPath(),r.moveTo(this.startX+e.transformX,this.startY+e.transformY),r.lineTo(this.endX+e.transformX,this.endY+e.transformY),r.stroke()}}class uo{constructor(t){this.width=0,this.height=0,this.el=t,this.ctx=t.getContext("2d")}clear(){this.ctx.clearRect(0,0,this.width,this.height)}draw(t,e){this.clear(),t.forEach(t=>t.draw(this,e))}}let po=class extends o["e"]{constructor(){super(...arguments),this.selfLines=[],this.isDragging=!1,this.originX=0,this.originY=0,this.screenOriginX=0,this.screenOriginY=0}getNodesLayout(t){return gs(this.nodes,e=>{return e.node===t}).layout}getLines(){return this.inputs.map(t=>{const e=ho(this.getNodesLayout(t)),r=new lo;return r.startX=e.x,r.startY=e.y,r.endX=this.layout.absX,r.endY=this.layout.absY,r})}updateLine(){this.selfLines.forEach(t=>{const e=this.lines.indexOf(t);-1!==e&&this.lines.splice(e,1)}),this.selfLines=this.getLines(),this.selfLines.forEach(t=>{this.lines.push(t)})}mounted(){this.updateLine()}get inputs(){const t=[];return this.node.fromNodes.forEach(e=>{t.push(e)}),t}get viewPositionX(){return this.layout.absX+"px"}get viewPositionY(){return this.layout.absY+"px"}get viewWidth(){return this.layout.width+"px"}get viewHeight(){return this.layout.height+"px"}startDrag(t){this.isDragging=!0,this.originX=this.layout.absX,this.originY=this.layout.absY,this.screenOriginX=t.screenX,this.screenOriginY=t.screenY,window.addEventListener("mousemove",this.dragging),window.addEventListener("mouseup",t=>{this.isDragging=!1,window.removeEventListener("mousemove",this.dragging)})}dragging(t){this.layout.absX=this.originX+t.screenX-this.screenOriginX,this.layout.absY=this.originY+t.screenY-this.screenOriginY,this.$emit("updateViewport",{node:this.node,layout:this.layout}),this.$emit("updateLine",this.node)}};a["b"]([Object(o["b"])()],po.prototype,"nodes",void 0),a["b"]([Object(o["b"])()],po.prototype,"lines",void 0),a["b"]([Object(o["c"])({required:!0})],po.prototype,"node",void 0),a["b"]([Object(o["c"])({required:!0})],po.prototype,"layout",void 0),a["b"]([Object(o["c"])({required:!0})],po.prototype,"boardInfo",void 0),a["b"]([Object(o["c"])({required:!1,default:!0})],po.prototype,"editable",void 0),po=a["b"]([Object(o["a"])({components:{}})],po);var fo=po,mo=fo,go=(r("d0d3"),Object(p["a"])(mo,ao,oo,!1,null,"f08e55ee",null)),vo=go.exports,xo=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("canvas",{staticClass:"lines-hud"})},wo=[];let yo=class extends o["e"]{constructor(){super(...arguments),this.isRunning=!0}mounted(){this.HUD=new uo(this.$el),window.addEventListener("resize",this.updateSize),window.requestAnimationFrame(this.draw),this.updateSize()}beforeDestroy(){this.isRunning=!1}updateSize(){const t=this.$el;this.HUD.width=t.clientWidth,this.HUD.height=t.clientHeight,t.width=t.clientWidth,t.height=t.clientHeight}draw(){this.HUD.draw(this.lines,this.boardInfo),this.isRunning&&window.requestAnimationFrame(this.draw)}};a["b"]([Object(o["c"])({required:!0})],yo.prototype,"lines",void 0),a["b"]([Object(o["c"])({required:!0})],yo.prototype,"boardInfo",void 0),yo=a["b"]([Object(o["a"])({components:{}})],yo);var _o=yo,bo=_o,Mo=(r("6def"),Object(p["a"])(bo,xo,wo,!1,null,"4cfbac3a",null)),Co=Mo.exports,So=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",[t._v("\n  "+t._s(t.node.name)+"\n  "),r("button",{on:{click:t.actualSize}},[t._v("actual size")]),r("button",{on:{click:t.defaultSize}},[t._v("default size")])])},Eo=[];let To=class extends o["e"]{actualSize(){this.layout.width=this.node.widthAbs/2/window.devicePixelRatio,this.layout.height=this.node.heightAbs/2/window.devicePixelRatio,this.$emit("updateSize",{node:this.node,layout:this.layout})}defaultSize(){this.layout.width=200,this.layout.height=200,this.$emit("updateSize",{node:this.node,layout:this.layout})}};a["b"]([Object(o["c"])({required:!0})],To.prototype,"node",void 0),a["b"]([Object(o["c"])({required:!0})],To.prototype,"layout",void 0),To=a["b"]([Object(o["a"])({components:{}})],To);var Ao=To,Ro=Ao,Po=Object(p["a"])(Ro,So,Eo,!1,null,"69d673c4",null),zo=Po.exports;let No=class extends o["e"]{constructor(){super(...arguments),this.isRunning=Qn.framer.active,this.showGraphViewer=!1,this.board={width:0,height:0,transformX:0,transformY:0},this.nodes=[],this.lines=[]}showScenePanel(){return a["a"](this,void 0,void 0,function*(){this.$store.state.showScenePanel=!0,yield this.$nextTick(),Qn.notifyResize()})}showConfigPanel(){return a["a"](this,void 0,void 0,function*(){this.$store.state.showConfigPanel=!0,yield this.$nextTick(),Qn.notifyResize()})}pick(t){const e=this.$el.querySelector("canvas");Qn.pickColor(t.offsetX/e.clientWidth,(e.clientHeight-t.offsetY)/e.clientHeight)}updateViewport({node:t,layout:e}){if(t instanceof $i){const r=new Ht,s=e,i=t;r.set(s.absX+this.board.transformX,this.board.height-s.absY-s.height-this.board.transformY,s.width,s.height),r.multiplyScalar(window.devicePixelRatio),i.debugViewPort.copy(r)}}updateLine(t){this.notifyNodeNeedUpdateLine(t),t.toNodes.forEach(t=>{this.notifyNodeNeedUpdateLine(t)})}notifyNodeNeedUpdateLine(t){if(this.$refs.vueNodes)for(let e=0;e<this.$refs.vueNodes.length;e++){const r=this.$refs.vueNodes[e];r.node===t&&r.updateLine()}}updateAllViewport(){this.nodes.forEach(t=>{this.updateViewport(t)})}layout(){const t={};this.nodes.forEach(e=>{t[e.node.uuid]=e.layout}),co(Qn.pipeline.graph.screenNode,t),this.updateAllViewport(),this.nodes.forEach(t=>this.updateLine(t.node))}isRenderTargetNode(t){return t instanceof $i}inspectGraph(){Qn.pipeline.graph.enableDebuggingView=!0;const t=Qn.pipeline.graph.nodes;this.nodes=t.map(t=>{return{node:t,layout:{absX:0,absY:0,width:200,height:200}}}),this.showGraphViewer=!0,this.layout()}closeGraphInspector(){Qn.pipeline.graph.enableDebuggingView=!1,this.showGraphViewer=!1}run(){Qn.run(),this.isRunning=!0}stop(){Qn.stop(),this.isRunning=!1}step(){Qn.step()}screenshot(){Qn.engine.downloadCurrentRender()}};a["b"]([Object(o["d"])()],No.prototype,"nodes",void 0),a["b"]([Object(o["d"])()],No.prototype,"lines",void 0),No=a["b"]([Object(o["a"])({components:{GraphView:no,DAGNodeView:vo,RenderTargetNodeView:zo,LineHUDCanvas:Co}})],No);var Oo=No,Fo=Oo,Do=(r("b720"),Object(p["a"])(Fo,Qa,Ka,!1,null,"0bf133fc",null)),Io=Do.exports;let Lo=class extends o["e"]{constructor(){super(...arguments),this.appConf={name:"root",type:"folder",value:[]}}mounted(){const t=this.$el.querySelector("#viewer-canvas");Qn.initialize(t),this.appConf=Qn.pipeline.config}beforeDestroy(){Qn.unintialize()}};Lo=a["b"]([Object(o["a"])({components:{ConfigPanel:ra,ScenePanel:Za,ViewerCanvas:Io,ObjectPanel:La}})],Lo);var Vo=Lo,Uo=Vo,ko=(r("c3a5"),Object(p["a"])(Uo,T,A,!1,null,"5760c40d",null)),Bo=ko.exports,Go=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"shader-graph"},[r("div",{staticClass:"editor"},[r("button",{on:{click:t.layout}},[t._v("relayout")]),r("div",[r("button",{on:{click:t.addUniform}},[t._v("uniform")]),r("button",[t._v("attribute")])]),r("div",{staticStyle:{position:"absolute",top:"0px",width:"100%",height:"100%"}},[r("LineHUDCanvas",{attrs:{lines:t.lines,boardInfo:t.board}}),r("GraphView",{attrs:{board:t.board}},t._l(t.nodes,function(e){return r("DAGNodeView",{key:e.node.uuid,ref:"vueNodes",refInFor:!0,attrs:{node:e.node,layout:e.layout,boardInfo:t.board},on:{updateViewport:function(r){return t.updateViewport(e)},updateLine:t.updateLine}},[t.isShaderFunctionNode(e.node)?r("ShaderFunctionNodeView",{attrs:{node:e.node,layout:e.layout},on:{updateSize:t.updateViewport}}):t._e()],1)}),1)],1)]),r("div",{staticClass:"viewer"},[r("h1",[t._v("viewer")]),t.showCode?r("button",{on:{click:function(e){t.showCode=!1}}},[t._v("canvas")]):r("button",{on:{click:t.codeGen}},[t._v("view generated code")]),r("button",{on:{click:t.updateTechnique}},[t._v("updateTechnique")]),r("div",{directives:[{name:"show",rawName:"v-show",value:t.showCode,expression:"showCode"}],staticClass:"code-result"},[r("pre",[t._v(t._s(t.codeGenResult))])]),r("div",{directives:[{name:"show",rawName:"v-show",value:!t.showCode,expression:"!showCode"}],staticClass:"canvas-wrap",on:{mouseenter:t.start,mouseleave:t.end}},[r("canvas",{attrs:{id:"shader-editor-canvas"}})])])])},jo=[];class $o{constructor(){this.graph=new wi,this.scene=new ki,this.canvasRun=!1,this.tick=()=>{this.canvasRun&&this.render(),window.requestAnimationFrame(this.tick)},this.onContainerResize=()=>{const t=this.canvas.offsetWidth,e=this.canvas.offsetHeight;this.engine.setSize(t,e),this.engine.camera.aspect=t/e}}init(t){this.canvas=t,this.engine=new zi(t),this.engine.camera.transform.position.set(20,10,10),this.orbitController=new Mn(this.engine.camera),this.orbitController.registerInteractor(this.engine.interactor),this.shader=(new yi).decorate(new Wi),this.loadScene(),this.tick(),this.start(),window.addEventListener("resize",this.onContainerResize),this.onContainerResize()}updateShader(){}loadScene(){let t=new xn(1,40,40);const e=new Qr;e.geometry=t,e.shading=this.shader,this.mesh=e,this.scene.root.addChild(e)}start(){this.canvasRun=!0}render(){this.orbitController.update(),this.engine.connectCamera(),this.engine.render(this.scene)}uninit(){this.canvas=null,this.engine=null}}let qo=new $o;var Xo=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",[t._v("\n  "+t._s(t.node.factory.name)+"\n")])},Wo=[],Ho=function(t,e,r,s){var i,n=arguments.length,a=n<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,r):s;if("object"===typeof Reflect&&"function"===typeof Reflect.decorate)a=Reflect.decorate(t,e,r,s);else for(var o=t.length-1;o>=0;o--)(i=t[o])&&(a=(n<3?i(a):n>3?i(e,r,a):i(e,r))||a);return n>3&&a&&Object.defineProperty(e,r,a),a};let Yo=class extends o["e"]{};Ho([Object(o["c"])({required:!0})],Yo.prototype,"node",void 0),Ho([Object(o["c"])({required:!0})],Yo.prototype,"layout",void 0),Yo=Ho([Object(o["a"])({components:{}})],Yo);var Zo=Yo,Qo=Zo,Ko=Object(p["a"])(Qo,Xo,Wo,!1,null,"0f053584",null),Jo=Ko.exports;let th=class extends o["e"]{constructor(){super(...arguments),this.showCode=!1,this.graph=null,this.codeGenResult="",this.board={width:0,height:0,transformX:0,transformY:0},this.nodes=[],this.lines=[]}mounted(){const t=this.$el.querySelector("#shader-editor-canvas");qo.init(t),this.graph=qo.shader.graph,this.board.width=t.clientWidth,this.board.height=t.clientHeight;const e=new rn,r=(new yi).decorate(e);r.getProgramConfig(),this.nodes=r.graph.nodes.map(t=>{return{node:t,layout:{absX:0,absY:0,width:200,height:200}}}),this.layout(r),console.log(this.graph)}layout(t){const e={};this.nodes.forEach(t=>{e[t.node.uuid]=t.layout}),co(t.graph.fragmentRoot,e)}updateViewport(t){console.log("upd")}isShaderFunctionNode(t){return t instanceof Cs}codeGen(){this.showCode=!0}updateLine(t){console.log("l"),this.notifyNodeNeedUpdateLine(t),t.toNodes.forEach(t=>{this.notifyNodeNeedUpdateLine(t)})}notifyNodeNeedUpdateLine(t){if(this.$refs.vueNodes)for(let e=0;e<this.$refs.vueNodes.length;e++){const r=this.$refs.vueNodes[e];r.node===t&&r.updateLine()}}addUniform(){this.nodes.push({node:ci("unnamed",de.float),layout:{absX:0,absY:0,width:100,height:100}})}updateTechnique(){qo.updateShader()}start(){qo.start()}end(){qo.canvasRun=!1}};a["b"]([Object(o["d"])()],th.prototype,"nodes",void 0),a["b"]([Object(o["d"])()],th.prototype,"lines",void 0),th=a["b"]([Object(o["a"])({components:{DAGNodeView:vo,GraphView:no,LineHUDCanvas:Co,ShaderFunctionNodeView:Jo}})],th);var eh=th,rh=eh,sh=(r("5fb1"),Object(p["a"])(rh,Go,jo,!1,null,"71476dfb",null)),ih=sh.exports,nh=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div")},ah=[];let oh=class extends o["e"]{mounted(){console.log("debug");const t=new rn,e=(new yi).decorate(t);console.log(e),console.log(e.getProgramConfig())}};oh=a["b"]([Object(o["a"])({})],oh);var hh=oh,ch=hh,lh=Object(p["a"])(ch,nh,ah,!1,null,null,null),uh=lh.exports,dh=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",[r("h1",[t._v("Examples")]),t._l(t.examples,function(e){return r("div",{key:e.name,staticClass:"example-entry",on:{click:function(r){return t.gotoExample(e.name)}}},[t._v(t._s(e.name))])})],2)},ph=[];let fh=class extends o["e"]{get examples(){return this.$store.state.examples}mounted(){}gotoExample(t){console.log("goto"),this.$store.state.viewExample=t,this.$router.push({name:"example",params:{name:t}})}};fh=a["b"]([Object(o["a"])({components:{}})],fh);var mh=fh,gh=mh,vh=(r("61ae"),Object(p["a"])(gh,dh,ph,!1,null,"049970b3",null)),xh=vh.exports,wh=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",[r("h1",[t._v(t._s(t.example.name))]),r("div"),t._m(0),t.exampleHasBuild?r("div",[t.isRunning?t._e():r("button",{on:{click:t.start}},[t._v("start")]),t.isRunning?t._e():r("button",{on:{click:t.step}},[t._v("step")]),t.isRunning?r("button",{on:{click:t.stop}},[t._v("stop")]):t._e()]):r("div",[t._v("example is in building")]),t.config?r("div",[r("Config",{attrs:{config:t.config}})],1):t._e()])},yh=[function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",[r("canvas")])}],_h=function(t,e,r,s){return new(r||(r=Promise))(function(i,n){function a(t){try{h(s.next(t))}catch(e){n(e)}}function o(t){try{h(s["throw"](t))}catch(e){n(e)}}function h(t){t.done?i(t.value):new r(function(e){e(t.value)}).then(a,o)}h((s=s.apply(t,e||[])).next())})};class bh{constructor(){this.framer=new Oi}screenShotCompareElement(t,e){return _h(this,void 0,void 0,function*(){})}reset(){this.framer=new Oi,this.testConfig=void 0}}class Mh{constructor(){this.framer=new Oi}screenShotCompareElement(t,e){return _h(this,void 0,void 0,function*(){yield window.screenShotCompareElement(t,e)})}}window.HeadlessTestBridge=Mh;const Ch=new bh;let Sh=class extends o["e"]{constructor(){super(...arguments),this.config={name:"example config",type:"folder",value:[]},this.exampleHasBuild=!1,this.isRunning=!1}get example(){this.$store.state.viewExample=this.$route.params.name;for(let t=0;t<this.$store.state.examples.length;t++){const e=this.$store.state.examples[t];if(e.name===this.$store.state.viewExample)return e}throw"cant find example"}start(){Ch.framer.run(),this.isRunning=!0}stop(){Ch.framer.stop(),this.isRunning=!1}step(){Ch.framer.step()}mounted(){return a["a"](this,void 0,void 0,function*(){Ch.reset(),yield this.example.build(Ch),void 0!==Ch.testConfig&&this.config.value.push(Ch.testConfig),this.exampleHasBuild=!0})}};Sh=a["b"]([Object(o["a"])({components:{Config:Ft}})],Sh);var Eh=Sh,Th=Eh,Ah=(r("f4be"),Object(p["a"])(Th,wh,yh,!1,null,"3b7292a6",null)),Rh=Ah.exports;s["a"].use(_["a"]);var Ph=new _["a"]({routes:[{path:"/",name:"home",component:E},{path:"/debug",name:"debug",component:uh},{path:"/viewer",name:"viewer",component:Bo},{path:"/shader",name:"shader-editor",component:ih},{path:"/examples",name:"examples",component:xh},{path:"/example/:name",name:"example",component:Rh},{path:"/about",name:"about",component:()=>r.e("about").then(r.bind(null,"f820"))}]}),zh=r("2f62"),Nh=r("0745");function Oh(t){return Nh["a"](this,void 0,void 0,function*(){let e=document.querySelector("canvas");const r=new zi(e),s=new ki,i=new Qr,n=new xn;i.geometry=n;const a=qr.fromStandardGeometry(n);i.range=a,i.state.cullSide=Ye.CullFaceNone,s.root.addChild(i);const o=r.camera;function h(){r.connectCamera(),r.renderer.state.colorbuffer.setClearColor(new Ht(.9,.9,.9,1)),r.renderer.state.colorbuffer.clear(),r.render(s)}o.transform.position.set(0,0,5),o.lookAt(new Wt(0,0,0)),h(),yield t.screenShotCompareElement(e,"test");const c=new Mn(o);c.registerInteractor(r.interactor);let l=a.count;t.testConfig={name:"width",value:a.count,onChange:t=>{a.count=t},editors:[{type:"slider",min:0,max:l,step:1}]},t.framer.setFrame(()=>{c.update(),h()})})}var Fh=function(t,e,r,s){return new(r||(r=Promise))(function(i,n){function a(t){try{h(s.next(t))}catch(e){n(e)}}function o(t){try{h(s["throw"](t))}catch(e){n(e)}}function h(t){t.done?i(t.value):new r(function(e){e(t.value)}).then(a,o)}h((s=s.apply(t,e||[])).next())})};function Dh(t){return Fh(this,void 0,void 0,function*(){let e=document.querySelector("canvas");const r=new zi(e),s=new ki,i=new xn,n=new Qr,a=new Fi,o=new Di;n.geometry=i,a.geometry=i,o.geometry=i,a.transform.position.x=-5,o.transform.position.x=5,s.root.addChild(n),s.root.addChild(a),s.root.addChild(o);const h=r.camera;function c(){r.connectCamera(),r.renderer.state.colorbuffer.setClearColor(new Ht(.9,.9,.9,1)),r.renderer.state.colorbuffer.clear(),r.render(s)}h.transform.position.set(0,0,15),h.lookAt(new Wt(0,0,0)),c(),yield t.screenShotCompareElement(e,"test");const l=new Mn(h);l.registerInteractor(r.interactor),t.framer.setFrame(()=>{l.update(),c()})})}const Ih=[{name:"primitive",build:Dh},{name:"render range",build:Oh}];window.artglExamples=Ih,window.HeadlessTestBridge=Mh,s["a"].use(zh["a"]);var Lh=new zh["a"].Store({state:{showConfigPanel:!1,showScenePanel:!1,examples:Ih,viewExample:""},mutations:{},actions:{}});s["a"].config.productionTip=!1,new s["a"]({router:Ph,store:Lh,render:t=>t(y)}).$mount("#app")},d0d3:function(t,e,r){"use strict";var s=r("96a7"),i=r.n(s);i.a},dbd8:function(t,e,r){},e67b:function(t,e,r){},f4be:function(t,e,r){"use strict";var s=r("2ffb"),i=r.n(s);i.a},f942:function(t,e,r){},ff4f:function(t,e,r){}});
//# sourceMappingURL=app.19c58ac2.js.map