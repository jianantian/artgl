(function(t){function e(e){for(var r,a,o=e[0],h=e[1],c=e[2],l=0,d=[];l<o.length;l++)a=o[l],i[a]&&d.push(i[a][0]),i[a]=0;for(r in h)Object.prototype.hasOwnProperty.call(h,r)&&(t[r]=h[r]);u&&u(e);while(d.length)d.shift()();return n.push.apply(n,c||[]),s()}function s(){for(var t,e=0;e<n.length;e++){for(var s=n[e],r=!0,a=1;a<s.length;a++){var h=s[a];0!==i[h]&&(r=!1)}r&&(n.splice(e--,1),t=o(o.s=s[0]))}return t}var r={},i={app:0},n=[];function a(t){return o.p+"js/"+({about:"about"}[t]||t)+"."+{about:"cbdfe239"}[t]+".js"}function o(e){if(r[e])return r[e].exports;var s=r[e]={i:e,l:!1,exports:{}};return t[e].call(s.exports,s,s.exports,o),s.l=!0,s.exports}o.e=function(t){var e=[],s=i[t];if(0!==s)if(s)e.push(s[2]);else{var r=new Promise(function(e,r){s=i[t]=[e,r]});e.push(s[2]=r);var n,h=document.createElement("script");h.charset="utf-8",h.timeout=120,o.nc&&h.setAttribute("nonce",o.nc),h.src=a(t),n=function(e){h.onerror=h.onload=null,clearTimeout(c);var s=i[t];if(0!==s){if(s){var r=e&&("load"===e.type?"missing":e.type),n=e&&e.target&&e.target.src,a=new Error("Loading chunk "+t+" failed.\n("+r+": "+n+")");a.type=r,a.request=n,s[1](a)}i[t]=void 0}};var c=setTimeout(function(){n({type:"timeout",target:h})},12e4);h.onerror=h.onload=n,document.head.appendChild(h)}return Promise.all(e)},o.m=t,o.c=r,o.d=function(t,e,s){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},o.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(o.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)o.d(s,r,function(e){return t[e]}.bind(null,r));return s},o.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="/",o.oe=function(t){throw console.error(t),t};var h=window["webpackJsonp"]=window["webpackJsonp"]||[],c=h.push.bind(h);h.push=e,h=h.slice();for(var l=0;l<h.length;l++)e(h[l]);var u=c;n.push([0,"chunk-vendors"]),s()})({0:function(t,e,s){t.exports=s("cd49")},"0223":function(t,e,s){},"0857":function(t,e,s){"use strict";var r=s("790c"),i=s.n(r);i.a},"092b":function(t,e,s){"use strict";var r=s("6e10"),i=s.n(r);i.a},2338:function(t,e,s){},"277c":function(t,e,s){"use strict";var r=s("bbb7"),i=s.n(r);i.a},2979:function(t,e,s){},"2a56":function(t,e,s){"use strict";var r=s("960c"),i=s.n(r);i.a},"2ac3":function(t,e,s){"use strict";var r=s("4395"),i=s.n(r);i.a},"2bc0":function(t,e,s){t.exports=s.p+"img/artgl.7059ff1a.svg"},"332e":function(t,e,s){"use strict";var r=s("f596"),i=s.n(r);i.a},"36e4":function(t,e,s){"use strict";var r=s("2338"),i=s.n(r);i.a},3938:function(t,e,s){"use strict";var r=s("2979"),i=s.n(r);i.a},"39be":function(t,e,s){},"3aba":function(t,e,s){"use strict";var r=s("d235"),i=s.n(r);i.a},4395:function(t,e,s){},"5c0b":function(t,e,s){"use strict";var r=s("5e27"),i=s.n(r);i.a},"5e27":function(t,e,s){},6258:function(t,e,s){},"644f":function(t,e,s){"use strict";var r=s("7d60"),i=s.n(r);i.a},"6e10":function(t,e,s){},"790c":function(t,e,s){},"7d60":function(t,e,s){},"7feb":function(t,e,s){"use strict";var r=s("6258"),i=s.n(r);i.a},"81f7":function(t,e,s){"use strict";var r=s("94c7"),i=s.n(r);i.a},"82bf":function(t,e,s){"use strict";var r=s("d078"),i=s.n(r);i.a},9479:function(t,e,s){"use strict";var r=s("d97a"),i=s.n(r);i.a},"94c7":function(t,e,s){},"94f3":function(t,e,s){"use strict";var r=s("e88d"),i=s.n(r);i.a},"960c":function(t,e,s){},"9c93":function(t,e,s){},a638:function(t,e,s){"use strict";var r=s("39be"),i=s.n(r);i.a},bbb7:function(t,e,s){},c1b2:function(t,e,s){t.exports=s.p+"img/art.208123ee.svg"},cd49:function(t,e,s){"use strict";s.r(e);var r=s("2b0e"),i=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{attrs:{id:"app"}},[t.showTopNav?s("TopNav"):t._e(),s("router-view")],1)},n=[],a=s("9ab4"),o=s("60a3"),h=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{staticClass:"top-nav"},[r("img",{attrs:{src:s("c1b2"),alt:""},on:{click:t.gotoHome}}),r("div",{staticClass:"current-project"},[r("router-link",{attrs:{"active-class":"current",to:"/viewer"}},[t._v("Viewer")]),r("router-link",{attrs:{"active-class":"current",to:"/shader"}},[t._v("Composer")]),r("router-link",{attrs:{"active-class":"current",to:"/examples"}},[t._v("Examples")])],1)])},c=[];let l=class extends o["e"]{gotoHome(){this.$router.push({name:"home"})}};l=a["b"]([o["a"]],l);var u=l,d=u,p=(s("d781"),s("2877")),f=Object(p["a"])(d,h,c,!1,null,"f17af42a",null);f.options.__file="top-nav.vue";var m=f.exports;let g=class extends o["e"]{get showTopNav(){return"home"!==this.$route.name}};g=a["b"]([Object(o["a"])({components:{TopNav:m}})],g);var v=g,w=v,x=(s("5c0b"),Object(p["a"])(w,i,n,!1,null,null,null));x.options.__file="App.vue";var b=x.exports,y=s("8c4f"),_=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"home-page"},[t._m(0),s("ul",[s("router-link",{attrs:{"active-class":"current",to:"/viewer"}},[t._v("Scene Viewer")]),s("router-link",{attrs:{"active-class":"current",to:"/shader"}},[t._v("Shader Composer")]),s("router-link",{attrs:{"active-class":"current",to:"/examples"}},[t._v("Simple Examples")])],1)])},M=[function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",[r("img",{attrs:{src:s("2bc0"),alt:""}})])}],S=(s("644f"),{}),C=Object(p["a"])(S,_,M,!1,null,"4ae3c20a",null);C.options.__file="home.vue";var E=C.exports,T=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"viewer"},[this.$store.state.showScenePanel?s("ScenePanel"):t._e(),s("ViewerCanvas"),this.$store.state.showConfigPanel?s("ConfigPanel",{attrs:{appConfig:t.appConf}}):t._e()],1)},A=[],R=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"config-panel"},[s("div",{staticClass:"panel-title"},[t._v("\n    Render configuration\n    "),s("button",{on:{click:t.hide}},[t._v("hide")])]),s("div",{staticClass:"config-wrap"},[s("Config",{attrs:{config:t.appConfig}})],1)])},P=[],z=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"conf"},[s("Folder",{attrs:{config:t.config}})],1)},O=[],F=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"folder"},[s("div",{staticClass:"title",on:{click:t.toggle}},[t.expand?s("span",[t._v("=")]):s("span",[t._v(">")]),t._v("\n    "+t._s(t.config.name)+"\n    "),t.isEmptyList?s("span",{staticClass:"empty-hint"},[t._v(" empty ")]):t._e()]),t.expand?s("div",{staticClass:"subitem"},t._l(t.config.value,function(e){return s("div",{key:e.name},[Array.isArray(e.value)?s("config-folder",{attrs:{config:e}}):s("ConfigItem",{attrs:{config:e},model:{value:e.value,callback:function(s){t.$set(e,"value",s)},expression:"subConfig.value"}})],1)}),0):t._e()])},N=[],D=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"item"},[s("div",{staticClass:"item-head"},[s("div",{staticClass:"item-name"},[t._v("\n    "+t._s(t.config.name)+" \n    ")]),s("div",{staticClass:"inline-editor"},["number"===typeof t.config.value?s("NumberEditor",{model:{value:t.configValue,callback:function(e){t.configValue=e},expression:"configValue"}}):t._e(),"boolean"===typeof t.config.value?s("BooleanEditor",{model:{value:t.configValue,callback:function(e){t.configValue=e},expression:"configValue"}}):t._e(),t.shouldHaveCustomEditor?s("button",{staticClass:"expand-editor",on:{click:function(e){t.expandEditor=!t.expandEditor}}},[t._v("&")]):t._e()],1)]),t.shouldHaveCustomEditor&&t.expandEditor?s("Editors",{attrs:{editorConfig:t.config.editors},model:{value:t.configValue,callback:function(e){t.configValue=e},expression:"configValue"}}):t._e()],1)},L=[],V=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"editor"},[t.isMultiEditor?s("div",{staticClass:"editor-list"},t._l(t.editorConfig,function(e,r){return s("div",{key:e.type,staticClass:"editor-nav",class:{"active-editor-nav":r===t.currentEditor},on:{click:function(e){return t.useEditor(r)}}},[t._v("\n    "+t._s(e.type)+"\n    ")])}),0):"slider"===t.editor.type?s("NumberSliderEditor",{attrs:{config:t.editor},model:{value:t._value,callback:function(e){t._value=e},expression:"_value"}}):t._e()],1)},I=[],U=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",[s("input",{directives:[{name:"model",rawName:"v-model",value:t._value,expression:"_value"}],attrs:{type:"range",max:t.config.max,min:t.config.min,step:t.config.step},domProps:{value:t._value},on:{__r:function(e){t._value=e.target.value}}})])},k=[];let B=class extends o["e"]{get _value(){return this.value}set _value(t){this.$emit("input",t-0)}};a["b"]([Object(o["c"])()],B.prototype,"value",void 0),a["b"]([Object(o["c"])()],B.prototype,"config",void 0),B=a["b"]([o["a"]],B);var G=B,j=G,$=Object(p["a"])(j,U,k,!1,null,null,null);$.options.__file="number-slider.vue";var X=$.exports;let q=class extends o["e"]{constructor(){super(...arguments),this.currentEditor=0}get isMultiEditor(){return 1!==this.editorConfig.length}get editor(){return this.editorConfig[this.currentEditor]}get _value(){return this.value}set _value(t){this.$emit("input",t)}useEditor(t){this.currentEditor=t}};a["b"]([Object(o["c"])()],q.prototype,"editorConfig",void 0),a["b"]([Object(o["c"])()],q.prototype,"value",void 0),q=a["b"]([Object(o["a"])({components:{NumberSliderEditor:X}})],q);var Y=q,H=Y,W=(s("2ac3"),Object(p["a"])(H,V,I,!1,null,"5d23d6f4",null));W.options.__file="editors.vue";var Z=W.exports,Q=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"number-editor"},[s("input",{directives:[{name:"model",rawName:"v-model",value:t._value,expression:"_value"}],attrs:{type:"number"},domProps:{value:t._value},on:{input:function(e){e.target.composing||(t._value=e.target.value)}}})])},K=[];let J=class extends o["e"]{get _value(){return this.value}set _value(t){this.$emit("input",t-0)}};a["b"]([Object(o["c"])()],J.prototype,"value",void 0),J=a["b"]([o["a"]],J);var tt=J,et=tt,st=(s("332e"),Object(p["a"])(et,Q,K,!1,null,"41fd1826",null));st.options.__file="number.vue";var rt=st.exports,it=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",[s("input",{directives:[{name:"model",rawName:"v-model",value:t._value,expression:"_value"}],attrs:{type:"checkbox"},domProps:{checked:Array.isArray(t._value)?t._i(t._value,null)>-1:t._value},on:{change:function(e){var s=t._value,r=e.target,i=!!r.checked;if(Array.isArray(s)){var n=null,a=t._i(s,n);r.checked?a<0&&(t._value=s.concat([n])):a>-1&&(t._value=s.slice(0,a).concat(s.slice(a+1)))}else t._value=i}}})])},nt=[];let at=class extends o["e"]{get _value(){return this.value}set _value(t){this.$emit("input",t)}};a["b"]([Object(o["c"])()],at.prototype,"value",void 0),at=a["b"]([o["a"]],at);var ot=at,ht=ot,ct=Object(p["a"])(ht,it,nt,!1,null,null,null);ct.options.__file="boolean.vue";var lt=ct.exports;let ut=class extends o["e"]{constructor(){super(...arguments),this.expandEditor=!1}get configValue(){return this.config.value}set configValue(t){void 0!==this.config.onChange&&this.config.onChange(t),this.config.value=t}get shouldHaveCustomEditor(){return void 0!==this.config.editors}};a["b"]([Object(o["c"])()],ut.prototype,"config",void 0),ut=a["b"]([Object(o["a"])({components:{Editors:Z,NumberEditor:rt,BooleanEditor:lt}})],ut);var dt=ut,pt=dt,ft=(s("f078"),Object(p["a"])(pt,D,L,!1,null,"1e529480",null));ft.options.__file="item.vue";var mt=ft.exports;let gt=class extends o["e"]{constructor(){super(...arguments),this.expand=!0}get isEmptyList(){return 0===this.config.value.length}toggle(){this.isEmptyList||(this.expand=!this.expand)}};a["b"]([Object(o["c"])()],gt.prototype,"config",void 0),gt=a["b"]([Object(o["a"])({name:"config-folder",components:{ConfigItem:mt}})],gt);var vt=gt,wt=vt,xt=(s("0857"),Object(p["a"])(wt,F,N,!1,null,"b2989a74",null));xt.options.__file="folder.vue";var bt=xt.exports;let yt=class extends o["e"]{};a["b"]([Object(o["c"])()],yt.prototype,"config",void 0),yt=a["b"]([Object(o["a"])({components:{Folder:bt}})],yt);var _t=yt,Mt=_t,St=(s("3938"),Object(p["a"])(Mt,z,O,!1,null,"5bb907a0",null));St.options.__file="config.vue";var Ct,Et,Tt=St.exports;(function(t){t["OES_texture_float"]="OES_texture_float",t["OES_texture_half_float"]="OES_texture_half_float",t["OES_texture_float_linear"]="OES_texture_float_linear",t["OES_texture_half_float_linear"]="OES_texture_half_float_linear",t["OES_standard_derivatives"]="OES_standard_derivatives",t["OES_vertex_array_object"]="OES_vertex_array_object",t["OES_element_index_uint"]="OES_element_index_uint",t["WEBGL_compressed_texture_s3tc"]="WEBGL_compressed_texture_s3tc",t["WEBGL_depth_texture"]="WEBGL_depth_texture",t["EXT_texture_filter_anisotropic"]="EXT_texture_filter_anisotropic",t["EXT_shader_texture_lod"]="EXT_shader_texture_lod",t["WEBGL_draw_buffers"]="WEBGL_draw_buffers",t["EXT_frag_depth"]="EXT_frag_depth",t["EXT_sRGB"]="EXT_sRGB"})(Ct||(Ct={})),function(t){t["MAX_TEXTURE_SIZE"]="MAX_TEXTURE_SIZE",t["MAX_CUBE_MAP_TEXTURE_SIZE"]="MAX_CUBE_MAP_TEXTURE_SIZE"}(Et||(Et={}));const At=Object.keys(Ct),Rt=Object.keys(Et);class Pt{constructor(t){this.extensions={},this.parameters={},this.gl=t,this.createAllExtension(),this.getAllParams()}createExtension(t){const e=this.gl;var s=e.getExtension(t);s||(s=e.getExtension("MOZ_"+t)),s||(s=e.getExtension("WEBKIT_"+t)),this.extensions[t]=s}getExtension(t){return t in this.extensions||this.createExtension(t),this.extensions[t]}getParameter(t){return this.parameters[t]}createAllExtension(){for(var t=0;t<At.length;t++){var e=At[t];this.createExtension(e)}}getAllParams(){for(var t=0;t<Rt.length;t++){var e=Rt[t];this.parameters[e]=this.gl.getParameter(this.gl[e])}}}var zt;(function(t){t[t["vertex"]=0]="vertex",t[t["fragment"]=1]="fragment"})(zt||(zt={}));class Ot{constructor(t,e){this.renderer=t;const s=this.renderer.gl;this.type=e;var r=s.createShader(e===zt.vertex?s.VERTEX_SHADER:s.FRAGMENT_SHADER);if(null===r)throw"webgl shader create failed";this.shader=r}compileShader(t){const e=this.renderer.gl;if(e.shaderSource(this.shader,t),e.compileShader(this.shader),!e.getShaderParameter(this.shader,e.COMPILE_STATUS)){let s=e.getShaderInfoLog(this.shader);if(s)throw Ft(t),new Error(s)}if(!this.shader)throw"Something went wrong while compile the shader.";return this.shader}dispose(){this.renderer.gl.deleteShader(this.shader)}}function Ft(t){console.warn(Nt(t))}function Nt(t){for(var e=t.split("\n"),s=0;s<e.length;s++)e[s]=s+1+": "+e[s];return e.join("\n")}var Dt,Lt="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),Vt=new Array(36),It=0;function Ut(){for(var t=0;t<36;t++)8===t||13===t||18===t||23===t?Vt[t]="-":14===t?Vt[t]="4":(It<=2&&(It=33554432+16777216*Math.random()|0),Dt=15&It,It>>=4,Vt[t]=Lt[19===t?3&Dt|8:Dt]);return Vt.join("")}class kt{constructor(t,e,s){this.buffer=new Float32Array(3),this.x=t||0,this.y=e||0,this.z=s||0}set(t,e,s){return this.x=t,this.y=e,this.z=s,this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}clone(){return new kt(this.x,this.y,this.z)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}mag(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.mag())}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}normalize(){const t=1/this.length();return this.multiplyScalar(t)}lengthManhattan(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}crossVectors(t,e){const s=t.x,r=t.y,i=t.z,n=e.x,a=e.y,o=e.z;return this.x=r*o-i*a,this.y=i*n-s*o,this.z=s*a-r*n,this}cross(t){return this.crossVectors(this,t)}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}setFromQuaternion(t){const e=this.x,s=this.y,r=this.z,i=t.x,n=t.y,a=t.z,o=t.w,h=o*e+n*r-a*s,c=o*s+a*e-i*r,l=o*r+i*s-n*e,u=-i*e-n*s-a*r;return this.x=h*o+u*-i+c*-a-l*-n,this.y=c*o+u*-n+l*-i-h*-a,this.z=l*o+u*-a+h*-n-c*-i,this}setFromSpherical(t){const e=Math.sin(t.polar)*t.radius;return this.x=e*Math.sin(t.azim),this.y=Math.cos(t.polar)*t.radius,this.z=e*Math.cos(t.azim),this}applyMatrix4(t){const e=this.x,s=this.y,r=this.z,i=t.elements,n=1/(i[3]*e+i[7]*s+i[11]*r+i[15]);return this.x=(i[0]*e+i[4]*s+i[8]*r+i[12])*n,this.y=(i[1]*e+i[5]*s+i[9]*r+i[13])*n,this.z=(i[2]*e+i[6]*s+i[10]*r+i[14])*n,this}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){var e=this.x-t.x,s=this.y-t.y,r=this.z-t.z;return e*e+s*s+r*r}getBuffer(){return void 0===this.buffer?this.buffer=new Float32Array([this.x,this.y,this.z]):(this.buffer[0]=this.x,this.buffer[1]=this.y,this.buffer[2]=this.z),this.buffer}fromArray(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}static flatten(t,e){return t.toArray(e,0)}}class Bt{constructor(t,e,s,r){this.isVector4=!0,this.x=t||0,this.y=e||0,this.z=s||0,this.w=void 0!==r?r:1}clone(){return new Bt(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=void 0!==t.w?t.w:1,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}set(t,e,s,r){return this.x=t,this.y=e,this.z=s,this.w=r,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this.w=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setW(t){return this.w=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;case 3:this.w=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+t)}}setAxisAngleFromQuaternion(t){this.w=2*Math.acos(t.w);var e=Math.sqrt(1-t.w*t.w);return e<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}applyMatrix4(t){var e=this.x,s=this.y,r=this.z,i=this.w,n=t.elements;return this.x=n[0]*e+n[4]*s+n[8]*r+n[12]*i,this.y=n[1]*e+n[5]*s+n[9]*r+n[13]*i,this.z=n[2]*e+n[6]*s+n[10]*r+n[14]*i,this.w=n[3]*e+n[7]*s+n[11]*r+n[15]*i,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this.w=Math.max(t.w,Math.min(e.w,this.w)),this}clampScalar(t,e){return Gt.set(t,t,t,t),jt.set(e,e,e,e),this.clamp(Gt,jt)}clampLength(t,e){var s=this.length();return this.divideScalar(s||1).multiplyScalar(Math.max(t,Math.min(e,s)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthManhattan(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this}lerpVectors(t,e,s){return this.subVectors(e,t).multiplyScalar(s).add(t)}setAxisAngleFromRotationMatrix(t){var e,s,r,i,n=.01,a=.1,o=t.elements,h=o[0],c=o[4],l=o[8],u=o[1],d=o[5],p=o[9],f=o[2],m=o[6],g=o[10];if(Math.abs(c-u)<n&&Math.abs(l-f)<n&&Math.abs(p-m)<n){if(Math.abs(c+u)<a&&Math.abs(l+f)<a&&Math.abs(p+m)<a&&Math.abs(h+d+g-3)<a)return this.set(1,0,0,0),this;e=Math.PI;var v=(h+1)/2,w=(d+1)/2,x=(g+1)/2,b=(c+u)/4,y=(l+f)/4,_=(p+m)/4;return v>w&&v>x?v<n?(s=0,r=.707106781,i=.707106781):(s=Math.sqrt(v),r=b/s,i=y/s):w>x?w<n?(s=.707106781,r=0,i=.707106781):(r=Math.sqrt(w),s=b/r,i=_/r):x<n?(s=.707106781,r=.707106781,i=0):(i=Math.sqrt(x),s=y/i,r=_/i),this.set(s,r,i,e),this}var M=Math.sqrt((m-p)*(m-p)+(l-f)*(l-f)+(u-c)*(u-c));return Math.abs(M)<.001&&(M=1),this.x=(m-p)/M,this.y=(l-f)/M,this.z=(u-c)/M,this.w=Math.acos((h+d+g-1)/2),this}fromArray(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}static flatten(t,e){return t.toArray(e,0)}}const Gt=new Bt,jt=new Bt,$t=new kt,Xt=new kt,qt=new kt;class Yt{constructor(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}copy(t){var e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],e[9]=s[9],e[10]=s[10],e[11]=s[11],e[12]=s[12],e[13]=s[13],e[14]=s[14],e[15]=s[15],this}clone(){return(new Yt).fromArray(this.elements)}equals(t){for(var e=this.elements,s=t.elements,r=0;r<16;r++)if(e[r]!==s[r])return!1;return!0}set(t,e,s,r,i,n,a,o,h,c,l,u,d,p,f,m){const g=this.elements;return g[0]=t,g[4]=e,g[8]=s,g[12]=r,g[1]=i,g[5]=n,g[9]=a,g[13]=o,g[2]=h,g[6]=c,g[10]=l,g[14]=u,g[3]=d,g[7]=p,g[11]=f,g[15]=m,this}compose(t,e,s){return this.makeRotationFromQuaternion(e),this.scale(s.x,s.y,s.z),this.setPostion(t.x,t.y,t.z),this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}makePerspective(t,e,s,r,i,n){const a=this.elements,o=2*i/(e-t),h=2*i/(s-r),c=(e+t)/(e-t),l=(s+r)/(s-r),u=-(n+i)/(n-i),d=-2*n*i/(n-i);return a[0]=o,a[4]=0,a[8]=c,a[12]=0,a[1]=0,a[5]=h,a[9]=l,a[13]=0,a[2]=0,a[6]=0,a[10]=u,a[14]=d,a[3]=0,a[7]=0,a[11]=-1,a[15]=0,this}makeOrthographic(t,e,s,r,i,n){var a=this.elements,o=1/(e-t),h=1/(s-r),c=1/(n-i),l=(e+t)*o,u=(s+r)*h,d=(n+i)*c;return a[0]=2*o,a[4]=0,a[8]=0,a[12]=-l,a[1]=0,a[5]=2*h,a[9]=0,a[13]=-u,a[2]=0,a[6]=0,a[10]=-2*c,a[14]=-d,a[3]=0,a[7]=0,a[11]=0,a[15]=1,this}multiplyMatrices(t,e){var s=t.elements,r=e.elements,i=this.elements,n=s[0],a=s[4],o=s[8],h=s[12],c=s[1],l=s[5],u=s[9],d=s[13],p=s[2],f=s[6],m=s[10],g=s[14],v=s[3],w=s[7],x=s[11],b=s[15],y=r[0],_=r[4],M=r[8],S=r[12],C=r[1],E=r[5],T=r[9],A=r[13],R=r[2],P=r[6],z=r[10],O=r[14],F=r[3],N=r[7],D=r[11],L=r[15];return i[0]=n*y+a*C+o*R+h*F,i[4]=n*_+a*E+o*P+h*N,i[8]=n*M+a*T+o*z+h*D,i[12]=n*S+a*A+o*O+h*L,i[1]=c*y+l*C+u*R+d*F,i[5]=c*_+l*E+u*P+d*N,i[9]=c*M+l*T+u*z+d*D,i[13]=c*S+l*A+u*O+d*L,i[2]=p*y+f*C+m*R+g*F,i[6]=p*_+f*E+m*P+g*N,i[10]=p*M+f*T+m*z+g*D,i[14]=p*S+f*A+m*O+g*L,i[3]=v*y+w*C+x*R+b*F,i[7]=v*_+w*E+x*P+b*N,i[11]=v*M+w*T+x*z+b*D,i[15]=v*S+w*A+x*O+b*L,this}getInverse(t,e){var s=this.elements,r=t.elements,i=r[0],n=r[1],a=r[2],o=r[3],h=r[4],c=r[5],l=r[6],u=r[7],d=r[8],p=r[9],f=r[10],m=r[11],g=r[12],v=r[13],w=r[14],x=r[15],b=p*w*u-v*f*u+v*l*m-c*w*m-p*l*x+c*f*x,y=g*f*u-d*w*u-g*l*m+h*w*m+d*l*x-h*f*x,_=d*v*u-g*p*u+g*c*m-h*v*m-d*c*x+h*p*x,M=g*p*l-d*v*l-g*c*f+h*v*f+d*c*w-h*p*w,S=i*b+n*y+a*_+o*M;if(0===S){var C="Matrix4.getInverse(): can't invert matrix, determinant is 0";if(!0===e)throw new Error(C);return console.warn(C),this.identity()}var E=1/S;return s[0]=b*E,s[1]=(v*f*o-p*w*o-v*a*m+n*w*m+p*a*x-n*f*x)*E,s[2]=(c*w*o-v*l*o+v*a*u-n*w*u-c*a*x+n*l*x)*E,s[3]=(p*l*o-c*f*o-p*a*u+n*f*u+c*a*m-n*l*m)*E,s[4]=y*E,s[5]=(d*w*o-g*f*o+g*a*m-i*w*m-d*a*x+i*f*x)*E,s[6]=(g*l*o-h*w*o-g*a*u+i*w*u+h*a*x-i*l*x)*E,s[7]=(h*f*o-d*l*o+d*a*u-i*f*u-h*a*m+i*l*m)*E,s[8]=_*E,s[9]=(g*p*o-d*v*o-g*n*m+i*v*m+d*n*x-i*p*x)*E,s[10]=(h*v*o-g*c*o+g*n*u-i*v*u-h*n*x+i*c*x)*E,s[11]=(d*c*o-h*p*o-d*n*u+i*p*u+h*n*m-i*c*m)*E,s[12]=M*E,s[13]=(d*v*a-g*p*a+g*n*f-i*v*f-d*n*w+i*p*w)*E,s[14]=(g*c*a-h*v*a-g*n*l+i*v*l+h*n*w-i*c*w)*E,s[15]=(h*p*a-d*c*a+d*n*l-i*p*l-h*n*f+i*c*f)*E,this}lookAt(t,e,s){const r=this.elements;return qt.copy(t).sub(e),0===qt.mag()&&(qt.z=1),qt.normalize(),$t.crossVectors(s,qt),0===$t.mag()&&(1===Math.abs(s.z)?qt.x+=1e-4:qt.z+=1e-4,qt.normalize(),$t.crossVectors(s,qt)),$t.normalize(),Xt.crossVectors(qt,$t),r[0]=$t.x,r[4]=Xt.x,r[8]=qt.x,r[1]=$t.y,r[5]=Xt.y,r[9]=qt.y,r[2]=$t.z,r[6]=Xt.z,r[10]=qt.z,this}scale(t,e,s){const r=this.elements;return r[0]*=t,r[4]*=e,r[8]*=s,r[1]*=t,r[5]*=e,r[9]*=s,r[2]*=t,r[6]*=e,r[10]*=s,r[3]*=t,r[7]*=e,r[11]*=s,this}setPostion(t,e,s){var r=this.elements;return r[12]=t,r[13]=e,r[14]=s,this}makeRotationFromQuaternion(t){var e=this.elements,s=t.x,r=t.y,i=t.z,n=t.w,a=s+s,o=r+r,h=i+i,c=s*a,l=s*o,u=s*h,d=r*o,p=r*h,f=i*h,m=n*a,g=n*o,v=n*h;return e[0]=1-(d+f),e[4]=l-v,e[8]=u+g,e[1]=l+v,e[5]=1-(c+f),e[9]=p-m,e[2]=u-g,e[6]=p+m,e[10]=1-(c+d),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeTranslation(t,e,s){return this.set(1,0,0,t,0,1,0,e,0,0,1,s,0,0,0,1),this}makeRotationX(t){var e=Math.cos(t),s=Math.sin(t);return this.set(1,0,0,0,0,e,-s,0,0,s,e,0,0,0,0,1),this}makeRotationY(t){var e=Math.cos(t),s=Math.sin(t);return this.set(e,0,s,0,0,1,0,0,-s,0,e,0,0,0,0,1),this}makeRotationZ(t){var e=Math.cos(t),s=Math.sin(t);return this.set(e,-s,0,0,s,e,0,0,0,0,1,0,0,0,0,1),this}toArray(t,e){void 0===t&&(t=[]),void 0===e&&(e=0);var s=this.elements;return t[e]=s[0],t[e+1]=s[1],t[e+2]=s[2],t[e+3]=s[3],t[e+4]=s[4],t[e+5]=s[5],t[e+6]=s[6],t[e+7]=s[7],t[e+8]=s[8],t[e+9]=s[9],t[e+10]=s[10],t[e+11]=s[11],t[e+12]=s[12],t[e+13]=s[13],t[e+14]=s[14],t[e+15]=s[15],t}fromArray(t,e){void 0===e&&(e=0);for(var s=0;s<16;s++)this.elements[s]=t[s+e];return this}static flatten(t,e){return t.toArray(e,0)}}const Ht={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,clamp:function(t,e,s){return Math.max(e,Math.min(s,t))},euclideanModulo:function(t,e){return(t%e+e)%e},mapLinear:function(t,e,s,r,i){return r+(t-e)*(i-r)/(s-e)},lerp:function(t,e,s){return(1-s)*t+s*e},smoothstep:function(t,e,s){return t<=e?0:t>=s?1:(t=(t-e)/(s-e),t*t*(3-2*t))},smootherstep:function(t,e,s){return t<=e?0:t>=s?1:(t=(t-e)/(s-e),t*t*t*(t*(6*t-15)+10))},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},randFloat:function(t,e){return t+Math.random()*(e-t)},randFloatSpread:function(t){return t*(.5-Math.random())},degToRad:function(t){return t*Ht.DEG2RAD},radToDeg:function(t){return t*Ht.RAD2DEG},isPowerOfTwo:function(t){return 0===(t&t-1)&&0!==t},nearestPowerOfTwo:function(t){return Math.pow(2,Math.round(Math.log(t)/Math.LN2))},nextPowerOfTwo:function(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,t++,t}};var Wt;(function(t){t[t["XYZ"]=0]="XYZ",t[t["YZX"]=1]="YZX",t[t["ZXY"]=2]="ZXY",t[t["XZY"]=3]="XZY",t[t["YXZ"]=4]="YXZ",t[t["ZYX"]=5]="ZYX"})(Wt||(Wt={}));const Zt=new Yt;class Qt{constructor(t,e,s,r){this._order=Qt.defaultOrder,this.onChangeCallback=(()=>{}),this._x=t||0,this._y=e||0,this._z=s||0,this._order=r||Qt.defaultOrder}get x(){return this._x}get y(){return this._y}get z(){return this._z}set x(t){this._x=t}set y(t){this._y=t}set z(t){this._z=t}get order(){return this._order}set order(t){this._order=t}clone(){return new Qt(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this.onChangeCallback(),this}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}setFromRotationMatrix(t,e,s){var r=Ht.clamp,i=t.elements,n=i[0],a=i[4],o=i[8],h=i[1],c=i[5],l=i[9],u=i[2],d=i[6],p=i[10];return e=e||this._order,e===Wt.XYZ?(this._y=Math.asin(r(o,-1,1)),Math.abs(o)<.99999?(this._x=Math.atan2(-l,p),this._z=Math.atan2(-a,n)):(this._x=Math.atan2(d,c),this._z=0)):e===Wt.YXZ?(this._x=Math.asin(-r(l,-1,1)),Math.abs(l)<.99999?(this._y=Math.atan2(o,p),this._z=Math.atan2(h,c)):(this._y=Math.atan2(-u,n),this._z=0)):e===Wt.ZXY?(this._x=Math.asin(r(d,-1,1)),Math.abs(d)<.99999?(this._y=Math.atan2(-u,p),this._z=Math.atan2(-a,c)):(this._y=0,this._z=Math.atan2(h,n))):e===Wt.ZYX?(this._y=Math.asin(-r(u,-1,1)),Math.abs(u)<.99999?(this._x=Math.atan2(d,p),this._z=Math.atan2(h,n)):(this._x=0,this._z=Math.atan2(-a,c))):e===Wt.YZX?(this._z=Math.asin(r(h,-1,1)),Math.abs(h)<.99999?(this._x=Math.atan2(-l,c),this._y=Math.atan2(-u,n)):(this._x=0,this._y=Math.atan2(o,p))):e===Wt.XZY&&(this._z=Math.asin(-r(a,-1,1)),Math.abs(a)<.99999?(this._x=Math.atan2(d,c),this._y=Math.atan2(o,n)):(this._x=Math.atan2(-l,p),this._y=0)),this._order=e,!1!==s&&this.onChangeCallback(),this}setFromQuaternion(t,e,s){return Zt.makeRotationFromQuaternion(t),this.setFromRotationMatrix(Zt,e,s)}set(t,e,s,r){return this._x=t,this._y=e,this._z=s,this._order=r||this._order,this.onChangeCallback(),this}setFromVector3(t,e){return this.set(t.x,t.y,t.z,e||this._order)}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this.onChangeCallback(),this}toArray(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}toVector3(t){return t?t.set(this._x,this._y,this._z):new kt(this._x,this._y,this._z)}}Qt.defaultOrder=Wt.XYZ;const Kt=new kt;let Jt=0;const te=1e-6;class ee{constructor(t,e,s,r){this.x=t||0,this.y=t||0,this.z=s||0,this.w=r||1}set(t,e,s,r){return this.x=t,this.y=e,this.z=s,this.w=r,this}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}clone(){return new ee(this.x,this.y,this.z,this.w)}inverse(){return this.x*=-1,this.y*=-1,this.z*=-1,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}normalize(){let t=this.length();return 0===t?(this.x=0,this.y=0,this.z=0,this.w=1):(t=1/t,this.x=this.x*t,this.y=this.y*t,this.z=this.z*t,this.w=this.w*t),this}setFromAxisAngle(t,e){const s=e/2,r=Math.sin(s);return this.x=t.x*r,this.y=t.y*r,this.z=t.z*r,this.w=Math.cos(s),this}setFromUnitVectors(t,e){return Jt=t.dot(e)+1,Jt<te?(Jt=0,Math.abs(t.x)>Math.abs(t.z)?Kt.set(-t.y,t.x,0):Kt.set(0,-t.z,t.y)):Kt.crossVectors(t,e),this.x=Kt.x,this.y=Kt.y,this.z=Kt.z,this.w=Jt,this.normalize()}setFromRotationMatrix(t){const e=t.elements,s=e[0],r=e[4],i=e[8],n=e[1],a=e[5],o=e[9],h=e[2],c=e[6],l=e[10],u=s+a+l;let d;return u>0?(d=.5/Math.sqrt(u+1),this.w=.25/d,this.x=(c-o)*d,this.y=(i-h)*d,this.z=(n-r)*d):s>a&&s>l?(d=2*Math.sqrt(1+s-a-l),this.w=(c-o)/d,this.x=.25*d,this.y=(r+n)/d,this.z=(i+h)/d):a>l?(d=2*Math.sqrt(1+a-s-l),this.w=(i-h)/d,this.x=(r+n)/d,this.y=.25*d,this.z=(o+c)/d):(d=2*Math.sqrt(1+l-s-a),this.w=(n-r)/d,this.x=(i+h)/d,this.y=(o+c)/d,this.z=.25*d),this}}class se{constructor(t,e){this.x=t||0,this.y=e||0}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}clone(){return new se(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}equals(t){return t.x===this.x&&t.y===this.y}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}sub(t){return this.x-=t.x,this.y-=t.y,this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthManhattan(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}clampScalar(t,e){return re.set(t,t),ie.set(e,e),this.clamp(re,ie)}clampLength(t,e){var s=this.length();return this.divideScalar(s||1).multiplyScalar(Math.max(t,Math.min(e,s)))}rotate(t,e){e=e||new se;const s=e.sub(this).multiplyScalar(-1),r=s.x,i=s.y,n=Math.cos(t),a=Math.sin(t);return this.x=r*n-i*a,this.y=r*a+i*n,this}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}lengthSq(){return this.x*this.x+this.y*this.y}angle(){var t=Math.atan2(this.y,this.x);return t<0&&(t+=2*Math.PI),t}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){var e=this.x-t.x,s=this.y-t.y;return e*e+s*s}distanceToManhattan(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,s){return this.subVectors(e,t).multiplyScalar(s).add(t)}rotateAround(t,e){var s=Math.cos(e),r=Math.sin(e),i=this.x-t.x,n=this.y-t.y;return this.x=i*s-n*r+t.x,this.y=i*r+n*s+t.y,this}fromArray(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this}toArray(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t}static flatten(t,e){return t.toArray(e,0)}}const re=new se,ie=new se;var ne;(function(t){t[t["float"]=0]="float",t[t["floatVec2"]=1]="floatVec2",t[t["floatVec3"]=2]="floatVec3",t[t["floatVec4"]=3]="floatVec4",t[t["int"]=4]="int",t[t["intVec2"]=5]="intVec2",t[t["intVec3"]=6]="intVec3",t[t["intVec4"]=7]="intVec4",t[t["Mat2"]=8]="Mat2",t[t["Mat3"]=9]="Mat3",t[t["Mat4"]=10]="Mat4",t[t["boolean"]=11]="boolean"})(ne||(ne={}));const ae={float:ne.float,vec2:ne.floatVec2,vec3:ne.floatVec3,vec4:ne.floatVec4,mat2:ne.Mat2,mat3:ne.Mat3,mat4:ne.Mat4};let oe={};Object.keys(ae).forEach(t=>{oe[ae[t]]=t});const he={float:{type:ne.float,stride:1,default:0},vec2:{type:ne.floatVec2,stride:2,default:new se},vec3:{type:ne.floatVec3,stride:3,default:new kt},vec4:{type:ne.floatVec4,stride:4,default:new Bt}};let ce={};function le(t){return oe[t]}function ue(t){return ce[t].stride}function de(t){return ce[t].name}function pe(t,e){let s="";return s+=ge(t),s+=ve(t),s+=we(t),s+e}function fe(t,e){let s="";return s+="precision highp float;\n",s+=ve(t),s+=we(t),s+=me(t),s+e}function me(t){let e="";return void 0!==t.textures&&t.textures.forEach(t=>{e=e+"uniform sampler2D "+t.name+";\n"}),e}function ge(t){let e="";return void 0!==t.attributes&&t.attributes.forEach(t=>{const s=de(t.type);e=e+"attribute "+s+" "+t.name+";\n"}),e}function ve(t){let e="";if(void 0!==t.uniforms)for(const s in t.uniforms){const r=t.uniforms[s],i=le(r.type);e=e+"uniform "+i+" "+r.name+";\n"}return e}function we(t){let e="";return void 0!==t.varyings&&t.varyings.forEach(t=>{const s=le(t.type);e=e+"varying "+s+" "+t.name+";\n"}),e}function xe(t){switch(t){case ne.float:return be;case ne.floatVec2:return ye;case ne.floatVec3:return _e;case ne.floatVec4:return Me;case ne.Mat2:return Ce;case ne.Mat3:return Ee;case ne.Mat4:return Te;case ne.int:case ne.boolean:return Se}throw"uniform setter not found"}function be(t,e,s){t.uniform1f(e,s)}function ye(t,e,s){t.uniform2fv(e,s)}function _e(t,e,s){t.uniform3fv(e,s)}function Me(t,e,s){t.uniform4fv(e,s)}function Se(t,e,s){t.uniform1i(e,s)}function Ce(t,e,s){t.uniformMatrix4fv(e,!1,s)}function Ee(t,e,s){t.uniformMatrix4fv(e,!1,s)}function Te(t,e,s){t.uniformMatrix4fv(e,!1,s)}function Ae(t,e){return t!==e}function Re(t,e){if(t.length!==e.length)return!0;for(let s=0;s<t.length;s++)if(t[s]!==e[s])return!0;return!1}function Pe(t,e){return t}function ze(t,e){let s=e;void 0!==e&&t.length===e.length||(s=[]);for(let r=0;r<t.length;r++)s[r]=t[r];return s}function Oe(t){return t===ne.float||t===ne.int?Ae:Re}function Fe(t){return t===ne.float||t===ne.int?Pe:ze}function Ne(t){switch(t){case ne.float:return t=>t;case ne.floatVec2:return se.flatten;case ne.floatVec3:return kt.flatten;case ne.floatVec4:return Bt.flatten;case ne.Mat2:throw"not support yet";case ne.Mat3:throw"not support yet";case ne.Mat4:return Yt.flatten}throw"uniform flattener not found"}var De;Object.keys(he).forEach(t=>{ce[he[t].type]={name:t,stride:he[t].stride,default:he[t].default}}),function(t){t[t["MMatrix"]=0]="MMatrix",t[t["VPMatrix"]=1]="VPMatrix",t[t["LastVPMatrix"]=2]="LastVPMatrix"}(De||(De={}));const Le=new Map;function Ve(t){const e=Le.get(t.mapInner),s={name:t.name,type:e.type,default:e.default,_innerGlobalUniform:t.mapInner};return s}Le.set(De.MMatrix,{name:"MMatrix",type:ne.Mat4,default:new Yt}),Le.set(De.VPMatrix,{name:"VPMatrix",type:ne.Mat4,default:new Yt}),Le.set(De.LastVPMatrix,{name:"LastVPMatrix",type:ne.Mat4,default:new Yt});class Ie{constructor(t,e){this.programChangeId=-1,this.name=e.name,this.renderer=t.renderer,this.gl=t.renderer.gl;const s=t.getProgram(),r=this.gl.getUniformLocation(s,e.name);this.isActive=null!==r,this.location=r,this.flattener=void 0!==e.flattener?e.flattener:Ne(e.type),this.setter=void 0!==e.setter?e.setter:xe(e.type),this.differ=void 0!==e.differ?e.differ:Oe(e.type),this.copier=void 0!==e.copier?e.copier:Fe(e.type),this.innerGlobal=e._innerGlobalUniform}set(t){if(!this.isActive)return;if(this.receiveData=this.flattener(t,this.receiveData),void 0===this.lastReceiveData)return this.lastReceiveData=this.flattener(t,this.lastReceiveData),this.setter(this.gl,this.location,this.receiveData),void this.renderer.stat.uniformUpload++;let e=!1;this.programChangeId!==this.renderer._programChangeId&&(e=!0,this.programChangeId=this.renderer._programChangeId),this.renderer.enableUniformDiff&&!e?this.differ(this.receiveData,this.lastReceiveData)&&(this.setter(this.gl,this.location,this.receiveData),this.renderer.stat.uniformUpload++,this.lastReceiveData=this.copier(this.receiveData,this.lastReceiveData)):(this.setter(this.gl,this.location,this.receiveData),this.renderer.stat.uniformUpload++)}}var Ue,ke,Be,Ge,je,$e,Xe,qe,Ye;(function(t){t[t["position"]=0]="position",t[t["normal"]=1]="normal",t[t["color"]=2]="color",t[t["uv"]=3]="uv",t[t["unset"]=4]="unset"})(Ue||(Ue={}));class He{constructor(t,e){this.count=0,this.name=e.name,this.gl=t.renderer.gl,this.location=this.gl.getAttribLocation(t.getProgram(),e.name),this.type=e.type,this.isActive=-1!==this.location}useBuffer(t){if(!this.isActive)return;const e=this.gl;e.bindBuffer(e.ARRAY_BUFFER,t),e.vertexAttribPointer(this.location,ue(this.type),e.FLOAT,!1,0,0),e.enableVertexAttribArray(this.location)}}(function(t){t[t["texture2D"]=0]="texture2D"})(ke||(ke={}));class We{constructor(t,e){this.webglTexture=null,this.renderer=t.renderer,this.slotManager=t.renderer.state.textureSlot,this.gl=t.renderer.gl,this.name=e.name,this.channel=e.channelType;const s=t.getProgram(),r=this.gl.getUniformLocation(s,e.name);this.isActive=null!==r,this.location=r,this.currentActiveSlot=-1}useTexture(t){if(!this.isActive)return;const e=this.slotManager.updateSlotTexture(t);this.currentActiveSlot!==e&&(this.renderer.stat.uniformUpload++,this.currentActiveSlot=e,this.gl.uniform1i(this.location,e))}}function Ze(t){return void 0===t.useIndex&&(t.useIndex=!0),void 0===t.uniforms&&(t.uniforms=[]),void 0!==t.uniformsIncludes&&!0!==t._hasUniformIncludesExpand&&(t.uniformsIncludes.forEach(e=>{t.uniforms.push(Ve(e))}),t._hasUniformIncludesExpand=!0),t}class Qe{constructor(t,e){this.name="any",this.program=null,this.attributes={},this.attributeUsageMap={},this.uniforms={},this.globalUniforms=[],this.textures={},this.framebufferTextureMap={},this.drawFrom=0,this.drawCount=0,this.useIndexDraw=!1,this.indexUINT=!1,Ze(e),this.renderer=t,this.id=Ut(),this.vertexShader=new Ot(this.renderer,zt.vertex),this.fragmentShader=new Ot(this.renderer,zt.fragment),this.compileShaders(e),this.createProgram(this.vertexShader,this.fragmentShader),this.createGLResource(e),void 0!==e.uniformsIncludes&&e.uniformsIncludes.forEach(t=>{this.globalUniforms.push(this.uniforms[t.name])}),this.config=e,void 0!==e.useIndex&&(this.useIndexDraw=e.useIndex),t.programManager.addNewProgram(this),e.attributes.forEach(t=>{void 0!==t.usage&&(this.attributeUsageMap[t.usage]=this.attributes[t.name])})}getProgram(){if(null===this.program)throw"program is broken";return this.program}getConfig(){return this.config}defineFrameBufferTextureDep(t,e){this.framebufferTextureMap[e]=t}forUniforms(t){for(const e in this.textures)t(this.uniforms[e])}forTextures(t){for(const e in this.textures)t(this.textures[e])}forAttributes(t){for(const e in this.attributes)t(this.attributes[e])}compileShaders(t){let e=t.vertexShaderString,s=t.fragmentShaderString;t.autoInjectHeader&&(e=pe(t,t.vertexShaderString),s=fe(t,t.fragmentShaderString)),this.vertexShader.compileShader(e),this.fragmentShader.compileShader(s)}createProgram(t,e){const s=this.renderer.gl,r=s.createProgram();if(null===r)throw"webgl program create failed";if(this.program=r,s.attachShader(this.program,t.shader),s.attachShader(this.program,e.shader),s.linkProgram(this.program),!s.getProgramParameter(this.program,s.LINK_STATUS)){let t=s.getProgramInfoLog(this.program);throw"Could not compile WebGL program. \n\n"+t}}createGLResource(t){void 0!==t.attributes&&t.attributes.forEach(t=>{this.attributes[t.name]=new He(this,t)}),void 0!==t.uniforms&&t.uniforms.forEach(t=>{this.uniforms[t.name]=new Ie(this,t)}),void 0!==t.textures&&t.textures.forEach(t=>{this.textures[t.name]=new We(this,t)})}updateAttribute(t,e){const s=this.attributes[t];if(void 0===s)throw"try to set a none exist attribute";s.useBuffer(e)}getAttributeByUsage(t){return this.attributeUsageMap[t]}setTexture(t,e){this.textures[t].useTexture(e)}setDrawRange(t,e){this.drawFrom=t,this.drawCount=e}setUniform(t,e){this.uniforms[t].set(e)}updateInnerGlobalUniforms(t){this.globalUniforms.forEach(e=>{e.set(t.getGlobalUniform(e.innerGlobal).value)})}useIndexBuffer(t){const e=this.renderer.gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t)}dispose(){this.vertexShader.dispose(),this.fragmentShader.dispose(),this.renderer.gl.deleteProgram(this.program)}}class Ke{constructor(){this.programs=new Map}addNewProgram(t){this.programs.set(t.id,t)}getProgram(t){return this.programs.get(t)}get compiledProgramsCount(){return this.programs.size}releaseGL(){this.programs.forEach(t=>{t.dispose()}),this.programs=new Map}}class Je{constructor(t){this.buffers=new WeakMap,this.renderer=t}getGLBuffer(t){return this.buffers.get(t)}createBuffer(t,e){const s=this.renderer.gl,r=s.createBuffer();if(null===r)throw"webgl buffer create fail";return e?(s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,r),s.bufferData(s.ELEMENT_ARRAY_BUFFER,t,s.STATIC_DRAW)):(s.bindBuffer(s.ARRAY_BUFFER,r),s.bufferData(s.ARRAY_BUFFER,t,s.STATIC_DRAW)),this.buffers.set(t,r),r}disposeBuffer(t){if(!this.buffers.has(t))throw"cant find buffer to dispose";const e=this.renderer.gl,s=this.buffers.get(t);e.deleteBuffer(s),this.buffers.delete(t)}updateOrCreateBuffer(t,e){if(!this.buffers.has(t))return this.createBuffer(t,e);this.disposeBuffer(t),this.createBuffer(t,e)}releaseGL(){this.buffers=new WeakMap}}(function(t){t[t["POINTS"]=0]="POINTS",t[t["LINES"]=1]="LINES",t[t["LINES_LOOP"]=2]="LINES_LOOP",t[t["LINES_STRIP"]=2]="LINES_STRIP",t[t["TRIANGLES"]=4]="TRIANGLES",t[t["TRIANGLE_STRIP"]=5]="TRIANGLE_STRIP",t[t["TRIANGLE_FAN"]=6]="TRIANGLE_FAN"})(Be||(Be={})),function(t){t[t["CullFaceNone"]=0]="CullFaceNone",t[t["CullFaceBack"]=1]="CullFaceBack",t[t["CullFaceFront"]=2]="CullFaceFront",t[t["CullFaceFrontBack"]=3]="CullFaceFrontBack"}(Ge||(Ge={})),function(t){t[t["NeverDepth"]=99]="NeverDepth",t[t["AlwaysDepth"]=1]="AlwaysDepth",t[t["LessDepth"]=2]="LessDepth",t[t["LessEqualDepth"]=3]="LessEqualDepth",t[t["EqualDepth"]=4]="EqualDepth",t[t["GreaterEqualDepth"]=5]="GreaterEqualDepth",t[t["GreaterDepth"]=6]="GreaterDepth",t[t["NotEqualDepth"]=7]="NotEqualDepth"}(je||(je={})),function(t){t[t["NoBlending"]=0]="NoBlending",t[t["NormalBlending"]=1]="NormalBlending",t[t["AdditiveBlending"]=2]="AdditiveBlending",t[t["SubtractiveBlending"]=3]="SubtractiveBlending",t[t["MultiplyBlending"]=4]="MultiplyBlending",t[t["CustomBlending"]=5]="CustomBlending"}($e||($e={})),function(t){t[t["texture2D"]=3553]="texture2D",t[t["textureCubeMap"]=34067]="textureCubeMap"}(Xe||(Xe={})),function(t){t[t["nearest"]=9728]="nearest",t[t["linear"]=9729]="linear",t[t["NEAREST_MIPMAP_NEAREST"]=9984]="NEAREST_MIPMAP_NEAREST",t[t["LINEAR_MIPMAP_NEAREST"]=9985]="LINEAR_MIPMAP_NEAREST",t[t["NEAREST_MIPMAP_LINEAR"]=9986]="NEAREST_MIPMAP_LINEAR",t[t["LINEAR_MIPMAP_LINEAR"]=9987]="LINEAR_MIPMAP_LINEAR"}(qe||(qe={})),function(t){t[t["repeat"]=10497]="repeat",t[t["clampToEdge"]=33071]="clampToEdge",t[t["mirroredRepeat"]=33648]="mirroredRepeat"}(Ye||(Ye={}));var ts,es;(function(t){t[t["FUNC_ADD"]=32774]="FUNC_ADD",t[t["FUNC_SUBTRACT"]=32778]="FUNC_SUBTRACT",t[t["FUNC_REVERSE_SUBTRACT"]=32779]="FUNC_REVERSE_SUBTRACT"})(ts||(ts={})),function(t){t[t["ZERO"]=0]="ZERO",t[t["ONE"]=1]="ONE",t[t["SRC_COLOR"]=768]="SRC_COLOR",t[t["ONE_MINUS_SRC_COLOR"]=769]="ONE_MINUS_SRC_COLOR",t[t["SRC_ALPHA"]=770]="SRC_ALPHA",t[t["ONE_MINUS_SRC_ALPHA"]=771]="ONE_MINUS_SRC_ALPHA",t[t["DST_ALPHA"]=772]="DST_ALPHA",t[t["ONE_MINUS_DST_ALPHA"]=773]="ONE_MINUS_DST_ALPHA",t[t["DST_COLOR"]=774]="DST_COLOR",t[t["ONE_MINUS_DST_COLOR"]=775]="ONE_MINUS_DST_COLOR",t[t["SRC_ALPHA_SATURATE"]=776]="SRC_ALPHA_SATURATE",t[t["CONSTANT_COLOR"]=32769]="CONSTANT_COLOR",t[t["ONE_MINUS_CONSTANT_COLOR"]=32770]="ONE_MINUS_CONSTANT_COLOR",t[t["CONSTANT_ALPHA"]=32771]="CONSTANT_ALPHA",t[t["ONE_MINUS_CONSTANT_ALPHA"]=32772]="ONE_MINUS_CONSTANT_ALPHA"}(es||(es={}));var ss,rs,is=204,ns=205;(function(t){t[t["Alpha"]=6406]="Alpha",t[t["RGB"]=6407]="RGB",t[t["RGBA"]=6408]="RGBA"})(ss||(ss={})),function(t){t[t["UNSIGNED_BYTE"]=5121]="UNSIGNED_BYTE",t[t["UNSIGNED_SHORT_5_6_5"]=32819]="UNSIGNED_SHORT_5_6_5",t[t["UNSIGNED_SHORT_4_4_4_4"]=32820]="UNSIGNED_SHORT_4_4_4_4",t[t["UNSIGNED_SHORT_5_5_5_1"]=33635]="UNSIGNED_SHORT_5_5_5_1",t[t["FLOAT"]=33636]="FLOAT"}(rs||(rs={}));class as{constructor(t){this.redMaskEnabled=!1,this.greenMaskEnabled=!1,this.blueMaskEnabled=!1,this.alphaMaskEnabled=!1,this.currentClearColor=new Bt,this.gl=t.gl,this.resetDefaultClearColor()}setColorMask(t,e,s,r){this.redMaskEnabled===t&&this.greenMaskEnabled===e&&this.blueMaskEnabled===s&&this.alphaMaskEnabled===r||(this.gl.colorMask(t,e,s,r),this.redMaskEnabled=t,this.greenMaskEnabled=e,this.blueMaskEnabled=s,this.alphaMaskEnabled=r)}setClearColor(t,e){t.equals(this.currentClearColor)||(this.currentClearColor.copy(t),this.gl.clearColor(t.x,t.y,t.z,t.w))}resetDefaultClearColor(){this.setClearColor(as.defaultClearColor)}clear(){this.gl.clear(this.gl.COLOR_BUFFER_BIT)}}as.defaultClearColor=new Bt(.8,.8,.8,1);class os{constructor(t){this.currentDepthMask=null,this.currentDepthFunc=null,this.currentDepthClear=null,this._enableTest=!1,this.gl=t.gl,this.resetDefault()}set enableTest(t){this._enableTest!==t&&(t?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST))}get enableTest(){return this._enableTest}clear(){this.gl.clear(this.gl.DEPTH_BUFFER_BIT)}resetDefault(){this.enableTest=!0}setMask(t){this.currentDepthMask!==t&&(this.gl.depthMask(t),this.currentDepthMask=t)}setFunc(t){const e=this.gl;if(this.currentDepthFunc!==t){if(t)switch(t){case je.NeverDepth:e.depthFunc(e.NEVER);break;case je.AlwaysDepth:e.depthFunc(e.ALWAYS);break;case je.LessDepth:e.depthFunc(e.LESS);break;case je.LessEqualDepth:e.depthFunc(e.LEQUAL);break;case je.EqualDepth:e.depthFunc(e.EQUAL);break;case je.GreaterEqualDepth:e.depthFunc(e.GEQUAL);break;case je.GreaterDepth:e.depthFunc(e.GREATER);break;case je.NotEqualDepth:e.depthFunc(e.NOTEQUAL);break;default:e.depthFunc(e.LEQUAL)}else e.depthFunc(e.LEQUAL);this.currentDepthFunc=t}}}class hs{constructor(t){this.currentTextureSlot=null,this.currentBindTextures=[],this.slotIndex=0,this.renderer=t,this.gl=t.gl,this.maxSupport=t.glInfo.getParameter(Et.MAX_TEXTURE_SIZE),ls(this.maxSupport,this.gl)}activeTexture(t){this.currentTextureSlot!==t&&(this.gl.activeTexture(t),this.currentTextureSlot=t)}bindTexture(t,e){null===this.currentTextureSlot&&this.activeTexture(this.gl.TEXTURE0);let s=this.currentBindTextures[this.currentTextureSlot];void 0===s&&(s={type:void 0,texture:void 0},this.currentBindTextures[this.currentTextureSlot]=s),s.type===t&&s.texture===e||(this.gl.bindTexture(t,e),s.type=t,s.texture=e)}resetSlotIndex(){this.slotIndex=0}findSlot(t){let e=this.slotIndex;if(this.slotIndex>this.maxSupport)throw"texture use exceed max texture support";return this.slotIndex++,e}updateSlotTexture(t){const e=this.findSlot(t),s=cs[e];return this.activeTexture(s),this.bindTexture(Xe.texture2D,t),e}}const cs=[];function ls(t,e){for(let s=0;s<t;s++){const t=`TEXTURE${s}`;cs[s]=e[t]}}class us{constructor(t){this.currentViewport=new Bt,this.newViewport=new Bt,this.currentScissor=new Bt,this.newScissor=new Bt,this.currentCullFace=Ge.CullFaceNone,this.currentPolygonOffsetFactor=0,this.currentPolygonOffsetUnits=0,this.renderer=t,this.gl=t.gl,this.colorbuffer=new as(t),this.depthbuffer=new os(t),this.textureSlot=new hs(t)}setViewport(t,e,s,r){this.newViewport.set(t,e,s,r),this.newViewport.equals(this.currentViewport)||(this.gl.viewport(t,e,s,r),this.currentViewport.copy(this.newViewport))}setFullScreenViewPort(){this.setViewport(0,0,this.renderer.width,this.renderer.height)}setScissor(t,e,s,r){this.newScissor.set(t,e,s,r),this.newScissor.equals(this.currentScissor)||(this.gl.viewport(t,e,s,r),this.currentScissor.copy(this.newScissor))}setCullFace(t){const e=this.gl;t!==Ge.CullFaceNone?(e.enable(e.CULL_FACE),t!==this.currentCullFace&&(t===Ge.CullFaceBack?e.cullFace(e.BACK):t===Ge.CullFaceFront?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):e.disable(e.CULL_FACE),this.currentCullFace=t}setPolygonOffset(t,e,s){const r=this.gl;t?(r.enable(r.POLYGON_OFFSET_FILL),this.currentPolygonOffsetFactor===e&&this.currentPolygonOffsetUnits===s||(r.polygonOffset(e,s),this.currentPolygonOffsetFactor=e,this.currentPolygonOffsetUnits=s)):r.disable(r.POLYGON_OFFSET_FILL)}}const ds={minFilter:qe.nearest,maxFilter:qe.nearest,sWrap:Ye.clampToEdge,tWrap:Ye.clampToEdge},ps=ds;class fs{constructor(t){this.textures=new Map,this.renderer=t,this.POTResizeCanvas=document.createElement("canvas")}init(){const t=this.renderer.gl;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0)}getGLTexture(t){return this.textures.get(t)}deleteGLTexture(t){const e=this.getGLTexture(t);this.renderer.gl.deleteTexture(e),this.textures.delete(t)}createTextureFromImageElement(t){const e=this.renderer.gl,s=this.createWebGLTexture(ds);return e.bindTexture(e.TEXTURE_2D,s),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t.image),this.textures.set(t,s),s}createTextureForRenderTarget(t){const e=this.renderer.gl,s=this.createWebGLTexture(ps);e.bindTexture(e.TEXTURE_2D,s);const r=e.RGBA,i=0,n=e.RGBA,a=e.UNSIGNED_BYTE,o=null;return e.texImage2D(e.TEXTURE_2D,0,r,t.width,t.height,i,n,a,o),this.textures.set(t,s),s}createWebGLTexture(t){const e=this.renderer.gl,s=e.createTexture();if(null===s)throw"webgl texture create fail";return e.bindTexture(e.TEXTURE_2D,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,t.minFilter),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,t.maxFilter),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,t.sWrap),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,t.tWrap),s}releaseGL(){}}var ms,gs;(function(t){t[t["AlphaFormat"]=1021]="AlphaFormat",t[t["RGBFormat"]=1022]="RGBFormat",t[t["RGBAFormat"]=1023]="RGBAFormat"})(ms||(ms={})),function(t){t[t["UNSIGNED_BYTE"]=0]="UNSIGNED_BYTE",t[t["UNSIGNED_SHORT_5_6_5"]=1]="UNSIGNED_SHORT_5_6_5",t[t["UNSIGNED_SHORT_4_4_4_4"]=2]="UNSIGNED_SHORT_4_4_4_4",t[t["UNSIGNED_SHORT_5_5_5_1"]=3]="UNSIGNED_SHORT_5_5_5_1",t[t["FLOAT"]=4]="FLOAT"}(gs||(gs={}));class vs{constructor(){this.needUpdate=!0,this.format=ms.RGBAFormat,this.dataType=gs.UNSIGNED_BYTE}setNeedUpdate(){this.needUpdate=!0}getGLTexture(t){const e=t.renderer.textureManger.getGLTexture(this);return void 0===e?(this.needUpdate=!1,this.upload(t)):this.needUpdate?(this.needUpdate=!1,this.releaseGraphics(t),this.upload(t)):void 0}releaseGraphics(t){t.renderer.textureManger.deleteGLTexture(this)}}class ws extends vs{constructor(){super(...arguments),this.width=5,this.height=5}upload(t){return t.renderer.textureManger.createTextureForRenderTarget(this)}attach(t,e,s){t.renderer.setRenderTarget(e);const r=e.gl;this.width=e.width,this.height=e.height,this.releaseGraphics(t);const i=this.upload(t),n=xs[s];r.framebufferTexture2D(r.FRAMEBUFFER,n,r.TEXTURE_2D,i,0)}}const xs=[];function bs(t){if(0===xs.length)for(let e=0;e<32;e++)xs[e]=t["COLOR_ATTACHMENT"+e]}class ys{constructor(t,e,s,r){this.enableDepth=!0,this.webglDepthBuffer=null,this.textureAttachedSlot=[],this.name=e,this.renderer=t,this.gl=t.gl,bs(this.gl),this.webglFrameBuffer=this.createGLFramebuffer(),this.width=s,this.height=r}createGLFramebuffer(){const t=this.gl.createFramebuffer();if(null===t)throw"webgl framebuffer create failed";return t}createGLRenderbuffer(){const t=this.gl.createRenderbuffer();if(null===t)throw"webgl renderbuffer create failed";return t}resize(t,e,s){this.width===e&&this.height===s||(this.width=e,this.height=s,this.gl.deleteFramebuffer(this.webglFrameBuffer),this.webglFrameBuffer=this.createGLFramebuffer(),this.renderer.setRenderTarget(this),this.textureAttachedSlot.forEach((e,s)=>{e&&e.attach(t,this,s)}),this.disposeAttachedDepthBuffer(),this.createAttachDepthBuffer())}createAttachTexture(t,e){if(void 0!==this.textureAttachedSlot[e])throw"framebuffer has attached texture";const s=new ws;s.attach(t,this,e),this.textureAttachedSlot[e]=s}createAttachDepthBuffer(){if(this.renderer.setRenderTarget(this),null!==this.webglDepthBuffer)return;const t=this.gl,e=this.createGLRenderbuffer();this.webglDepthBuffer=e,t.bindRenderbuffer(t.RENDERBUFFER,e),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.width,this.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,e)}disposeAttachedDepthBuffer(){this.gl.deleteRenderbuffer(this.webglDepthBuffer),this.webglDepthBuffer=null}attachTexture(t,e){}readPixels(t,e,s,r,i){const n=this.gl;if(this.renderer.setRenderTarget(this),t<0||e<0||t>this.width-s||e>this.height-r)throw"read area exceed frameSize";if(i.length<s*r)throw"readBuffer size not sufficient";n.readPixels(t,e,s,r,ss.RGBA,n.UNSIGNED_BYTE,i)}dispose(){this.textureAttachedSlot=[],this.disposeAttachedDepthBuffer(),this.gl.deleteFramebuffer(this.webglFrameBuffer),this.webglFrameBuffer=null}}class _s{constructor(t){this.framebuffers=new Map,this.renderer=t,this.gl=t.gl}createFrameBuffer(t,e,s,r,i){if(this.framebuffers.has(e))throw"duplicate framebuffer key name";const n=new ys(this.renderer,e,s,r);return n.createAttachTexture(t,0),n.enableDepth=i,i&&n.createAttachDepthBuffer(),this.framebuffers.set(e,n),n}getFramebuffer(t){return this.framebuffers.get(t)}getFramebufferTexture(t){const e=this.framebuffers.get(t);if(void 0===e)throw`cant find framebuffer ${t}`;return this.renderer.textureManger.getGLTexture(e.textureAttachedSlot[0])}releaseGL(){}}class Ms{constructor(){this.drawcall=0,this.programSwitch=0,this.uniformUpload=0,this.framebufferSwitch=0}reset(){this.drawcall=0,this.programSwitch=0,this.uniformUpload=0,this.framebufferSwitch=0}}class Ss{constructor(t){this.vaos=new WeakMap,this.renderer=t,this.gl=t.gl,this.vaoExt=t.glInfo.getExtension(Ct.OES_vertex_array_object),this.isSupported=void 0!==this.vaoExt}getVAO(t){return this.vaos.get(t)}createVAO(t){const e=this.vaoExt.createVertexArrayOES();return this.vaoExt.bindVertexArrayOES(e),this.vaos.set(t,e),{vao:e,unbind:()=>{this.vaoExt.bindVertexArrayOES(null)}}}deleteVAO(t){this.vaos.delete(t)}useVAO(t){this.vaoExt.bindVertexArrayOES(t)}releaseGL(){this.vaoExt.bindVertexArrayOES(null),this.vaos=new WeakMap}}class Cs{constructor(t,e){this.enableRenderErrorCatch=!1,this.enableUniformDiff=!0,this._width=100,this._height=100,this.devicePixelRatio=window.devicePixelRatio,this.stat=new Ms,this.activeProgram=null,this._programChangeId=0,this.programManager=new Ke,this.textureManger=new fs(this),this.attributeBufferManager=new Je(this),this.currentFramebuffer=null,void 0===t&&(t=document.createElement("canvas")),e=Object.assign({},e),e.antialias=!1;const s=t.getContext("webgl",e);if(null===s)throw"webgl context create failed";this.gl=s,this.el=t,this.glInfo=new Pt(s),this.framebufferManager=new _s(this),this.vaoManager=new Ss(this),this.state=new us(this),this.textureManger.init(),this.setSize(this.el.offsetWidth,this.el.offsetHeight)}get width(){return this._width}get height(){return this._height}setSize(t,e){return this.setRawRenderSize(t*this.devicePixelRatio,e*this.devicePixelRatio)}setRawRenderSize(t,e){let s=this._width!==t||this._height!==e;return this._width=t,this._height=e,this.el.width=this._width,this.el.height=this._height,this.state.setViewport(0,0,t,e),s}createProgram(t){const e=new Qe(this,t);return this.programManager.addNewProgram(e),e}getProgram(t){return this.programManager.getProgram(t)}useProgram(t){this.activeProgram!==t&&(this.stat.programSwitch++,this.activeProgram=t,this._programChangeId++,this.gl.useProgram(t.getProgram()))}render(t,e){if(null===this.activeProgram)throw"renderer hasn't active program";if(e?this.gl.drawElements(t,this.activeProgram.drawCount,this.activeProgram.indexUINT?this.gl.UNSIGNED_INT:this.gl.UNSIGNED_SHORT,0):this.gl.drawArrays(t,this.activeProgram.drawFrom,this.activeProgram.drawCount),this.stat.drawcall++,this.enableRenderErrorCatch){const t=this.gl.getError();if(t!==this.gl.NO_ERROR)throw`gl draw error: ${t}`}this.state.textureSlot.resetSlotIndex()}setRenderTarget(t){if(this.currentFramebuffer!==t){this.stat.framebufferSwitch++,this.currentFramebuffer=t;const e=this.gl;null===t?e.bindFramebuffer(e.FRAMEBUFFER,null):e.bindFramebuffer(e.FRAMEBUFFER,t.webglFrameBuffer)}}setRenderTargetScreen(){this.setRenderTarget(null)}releaseGL(){this.attributeBufferManager.releaseGL(),this.programManager.releaseGL(),this.textureManger.releaseGL(),this.framebufferManager.releaseGL(),this.vaoManager.releaseGL()}}class Es extends kt{constructor(t,e,s){super(),this.onChange=(()=>{}),this._x=t||0,this._y=e||0,this._z=s||0}get x(){return this._x}set x(t){this.onChange&&this.onChange(),this._x=t}get y(){return this._y}set y(t){this.onChange&&this.onChange(),this._y=t}get z(){return this._z}set z(t){this.onChange&&this.onChange(),this._z=t}}const Ts=new kt,As=new Yt;class Rs{constructor(){this.transformFrameChanged=!0,this._matrix=new Yt,this.matrixIsDirty=!1,this._position=new Es,this.positionIsDirty=!1,this._scale=new Es(1,1,1),this.scaleIsDirty=!1,this._rotation=new Qt,this.eulerIsDirty=!1,this._quaternion=new ee,this.quaternionIsDirty=!1,this._position.onChange=(()=>{this.matrixIsDirty=!0,this.transformFrameChanged=!0}),this._scale.onChange=(()=>{this.matrixIsDirty=!0,this.transformFrameChanged=!0})}notifyMatrixChange(){this.matrixIsDirty=!1,this.positionIsDirty=!0,this.scaleIsDirty=!0,this.eulerIsDirty=!0,this.quaternionIsDirty=!0}get matrix(){return this.matrixIsDirty&&this._matrix.compose(this._position,this._quaternion,this._scale),this._matrix}get position(){return this.positionIsDirty&&(this._position._x=this._matrix.elements[12],this._position._y=this._matrix.elements[13],this._position._z=this._matrix.elements[14],this.positionIsDirty=!1),this._position}get scale(){return this.scaleIsDirty&&(Ts.set(this._matrix.elements[0],this._matrix.elements[1],this._matrix.elements[2]),this._scale._x=Ts.length(),Ts.set(this._matrix.elements[4],this._matrix.elements[5],this._matrix.elements[6]),this._scale._x=Ts.length(),Ts.set(this._matrix.elements[8],this._matrix.elements[9],this._matrix.elements[10]),this._scale._x=Ts.length(),this.scaleIsDirty=!1),this._scale}get rotation(){return this.eulerIsDirty&&(this._rotation.setFromQuaternion(this.quaternion,Qt.defaultOrder,!1),this.eulerIsDirty=!1),this._rotation}get quaternion(){return this.quaternionIsDirty&&(As.copy(this._matrix),As.scale(1/this.scale.x,1/this.scale.y,1/this.scale.z),this._quaternion.setFromRotationMatrix(As),this.quaternionIsDirty=!1),this._quaternion}}class Ps{constructor(){this.uuid=Ut(),this.scene=null,this.sceneNodeListIndex=-1,this.parent=null,this.children=[],this.transform=new Rs,this._worldMatrix=new Yt,this._worldMatrixUpdateFrameId=0,this._visible=!0,this._visibleNet=!0,this._visibleUpdateFrameId=0}get worldMatrix(){return this._worldMatrix}set visible(t){this._visible=t,null!==this.scene&&(this.scene.isFrameVisibleChange=!0)}get visible(){return this._visible}addChild(t){if(t===this)throw"Cant add a scene node to it self";return null!==this.scene&&(this.scene.isFrameStructureChange=!0,this.scene.addNode(t)),null!==t.parent&&t.parent.removeChild(t),t.parent=this,this.children.push(t),this}removeChild(t){null!==this.scene&&(this.scene.isFrameStructureChange=!0,this.scene.removeNode(t));let e=this.children.indexOf(t);return-1!==e&&(t.parent=null,this.children.splice(e,1)),this}traverse(t){function e(s){if(!1!==t(s))for(let t=0;t<s.children.length;t++)e(s.children[t])}return e(this),this}traversePair(t){function e(s,r){const i=t(s,r);for(let t=0;t<r.children.length;t++)e(r,r.children[t]);return i}return e(this.parent,this)}map(t){const e=new Map,s=this.traversePair((s,r)=>{const i=t(r);if(e.set(r,i),null!==s&&e.has(s)){const t=e.get(s);if(void 0===t)throw"tree map error: cant find mapped parent";t.children.push(i)}return i});return s}findSubNode(t){let e=null;return this.traverse(s=>{if(s.uuid===t)return e=s,!1}),e}updateWorldMatrix(t){(this.transform.transformFrameChanged||t)&&(null===this.parent?this.worldMatrix.copy(this.transform.matrix):this.worldMatrix.multiplyMatrices(this.parent.worldMatrix,this.transform.matrix),this.transform.transformFrameChanged=!1,t=!0);for(var e=this.children,s=0,r=e.length;s<r;s++)e[s].updateWorldMatrix(t);return this}}class zs extends Ps{constructor(){super(),this.projectionMatrix=new Yt,this.projectionMatrixNeedUpdate=!1,this.renderSizeObserver=null}updateProjectionMatrix(){}onRenderResize(t){}bindEngineRenderSize(t){null!==this.renderSizeObserver&&t.resizeObservable.remove(this.renderSizeObserver),this.renderSizeObserver=t.resizeObservable.add(this.onRenderResize)}}const Os=new Yt;class Fs extends zs{constructor(t,e,s,r,i){super(),this.up=new kt(0,1,0),this._fov=void 0!==s?s:50,this._zoom=1,this._near=void 0!==t?t:.1,this._far=void 0!==e?e:2e3,this._aspect=void 0!==r?r:1,this.updateProjectionMatrix()}get near(){return this._near}set near(t){this._near=t,this.projectionMatrixNeedUpdate=!0}get far(){return this._far}set far(t){this._far=t,this.projectionMatrixNeedUpdate=!0}get fov(){return this._fov}set fov(t){this._fov=t,this.projectionMatrixNeedUpdate=!0}get aspect(){return this._aspect}set aspect(t){this._aspect=t,this.projectionMatrixNeedUpdate=!0}get zoom(){return this._zoom}set zoom(t){this._zoom=t,this.projectionMatrixNeedUpdate=!0}get width(){return this._aspect*this.height}get height(){return 2*this._near*Math.tan(.5*Ht.DEG2RAD*this._fov)/this._zoom}updateProjectionMatrix(){const t=this._near*Math.tan(.5*Ht.DEG2RAD*this._fov)/this._zoom,e=2*t,s=this._aspect*e,r=-.5*s;this.projectionMatrix.makePerspective(r,r+s,t,t-e,this._near,this._far),this.projectionMatrixNeedUpdate=!1}lookAt(t){Os.lookAt(this.transform.position,t,this.up),this.transform.quaternion.setFromRotationMatrix(Os)}}class Ns{constructor(t){this._needUpdate=!0,this._value=t}setValue(t){this._value=t,this._needUpdate=!0}setValueNeedUpdate(){this._needUpdate=!0}get value(){return this._value}resetUpdate(){this._needUpdate=!1}}class Ds{constructor(t){this.callback=t,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1}}class Ls{constructor(t){this._observers=new Array,t&&(this._onObserverAdded=t)}add(t,e=!1){if(!t)return null;var s=new Ds(t);return s.unregisterOnNextCall=e,this._observers.push(s),this._onObserverAdded&&this._onObserverAdded(s),s}addOnce(t){return this.add(t,!0)}remove(t){if(!t)return!1;var e=this._observers.indexOf(t);return-1!==e&&(this._deferUnregister(t),!0)}_deferUnregister(t){t.unregisterOnNextCall=!1,t._willBeUnregistered=!0,setTimeout(()=>{this._remove(t)},0)}_remove(t){if(!t)return!1;var e=this._observers.indexOf(t);return-1!==e&&(this._observers.splice(e,1),!0)}notifyObservers(t){if(0===this._observers.length)return!0;for(var e of this._observers)e._willBeUnregistered||(e.callback(t),e.unregisterOnNextCall&&this._deferUnregister(e));return!0}notifyObserver(t,e){t.callback(e)}hasObservers(){return this._observers.length>0}clear(){this._observers=new Array,this._onObserverAdded=null}clone(){var t=new Ls;return t._observers=this._observers.slice(0),t}}class Vs{constructor(){this.cullSide=Ge.CullFaceBack,this.blending=$e.NormalBlending,this.blendSrc=is,this.blendDst=ns,this.blendEquation=ts.FUNC_ADD,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=je.LessEqualDepth,this.depthTest=!0,this.depthWrite=!0,this.colorWriteR=!0,this.colorWriteG=!0,this.colorWriteB=!0,this.colorWriteA=!0,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.alphaTest=0,this.premultipliedAlpha=!1}syncGL(t){t.state.setCullFace(this.cullSide);const e=t.state.depthbuffer;e.enableTest=this.depthTest,e.setFunc(this.depthFunc),e.setMask(this.depthWrite);const s=t.state.colorbuffer;s.setColorMask(this.colorWriteR,this.colorWriteG,this.colorWriteB,this.colorWriteA),t.state.setPolygonOffset(this.polygonOffset,this.polygonOffsetFactor,this.polygonOffsetUnits)}}var Is;(function(t){t[t["triangle"]=0]="triangle",t[t["point"]=1]="point",t[t["lineSegment"]=2]="lineSegment"})(Is||(Is={}));class Us extends Ps{constructor(){super(...arguments),this.state=new Vs,this.drawMode=Be.TRIANGLES,this.primitiveType=Is.triangle}foreachPrimitive(t){throw"not implement"}g(t){return this.geometry=t,this}m(t){return this.material=t,this}s(t){return this.shading=t,this}}class ks extends Us{constructor(){super(),this.raycasterable=!0,this.drawMode=Be.TRIANGLES,this.primitiveType=Is.triangle}foreachPrimitive(t){void 0!==this.geometry&&this.geometry.foreachFace(t,this.range)}raycast(t,e){throw new Error("Method not implemented.")}raycastIfHit(t){throw new Error("Method not implemented.")}raycastFirst(t){throw new Error("Method not implemented.")}}class Bs{constructor(t,e){this.min=new kt,this.max=new kt,void 0!==t&&(this.min.copy(t),this.max.copy(e))}clone(){const t=new Bs;return t.copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}}class Gs{constructor(){}clone(){return(new Gs).copy(this)}copy(t){return this.center.copy(t.center),this.radius=t.radius,this}equals(t){return t.center.equals(this.center)&&t.radius===this.radius}}class js{constructor(){this.uuid=Ut(),this.bufferDatum={},this._AABBBox=new Bs,this._boundingSphere=new Gs}get needUpdate(){for(const t in this.bufferDatum)if(this.bufferDatum[t].shouldUpdate)return!0;return!1}get AABBBox(){return this.needUpdate&&this.updateAABBBox(),this._AABBBox}get boundingSphere(){return this.needUpdate&&this.updateBoundingSphere(),this._boundingSphere}dispose(){}}class $s{}class Xs{constructor(t,e){return this.p1=void 0!==t?t:new kt,this.p2=void 0!==e?e:new kt,this}lengthSq(){return this.p1.distanceToSquared(this.p2)}length(){return this.p1.distanceTo(this.p2)}applyMatrix4(t){return this.p1.applyMatrix4(t),this.p2.applyMatrix4(t),this}clone(){const t=new Xs;return t.copy(this)}copy(t){return this.p1.copy(t.p1),this.p2.copy(t.p2),this}}class qs{constructor(t,e){this.count=1,this.stride=1,this.shouldUpdate=!0,this.data=t,this.count=this.data.length/this.stride,this.stride=e}static f3(t){return new qs(new Float32Array(t),3)}static f2(t){return new qs(new Float32Array(t),2)}static u16Index(t){return new qs(new Uint16Array(t),1)}foreach(t,e,s){const r=Math.max(0,e),i=Math.max(this.count,s);for(let n=r;n<i;n++)t(this.data,n*this.stride,this.stride,n)}setIndex(t,e,s){this.shouldUpdate=!0,this.data[t*this.stride+s===void 0?0:s]=e}getIndex(t,e){return this.shouldUpdate=!0,this.data[t*this.stride+e===void 0?0:e]}setData(t){this.shouldUpdate=!0,this.data=t,this.count=this.data.length/this.stride}getGLAttribute(t){return t.getGLAttributeBuffer(this)}getDataSizeByte(){return this.data.byteLength}}const Ys=new $s,Hs=new Xs,Ws=new kt;class Zs extends js{constructor(){super()}create(t,e,s,r){const i=qs.f3(e);this.bufferDatum.position=i;const n=qs.f3(s);this.bufferDatum.normal=n;const a=qs.f2(r);this.bufferDatum.uv=a;const o=qs.u16Index(t);this.indexBuffer=o}updateBoundingSphere(){const t=this._boundingSphere,e=this.AABBBox,s=e.getCenter(t.center);let r=0;this.foreachVertex(t=>{r=Math.max(r,s.distanceToSquared(t))}),t.radius=r}updateAABBBox(){const t=this._AABBBox;t.makeEmpty(),this.foreachVertex(e=>{t.expandByPoint(e)})}foreachFace(t,e){const s=this.bufferDatum.position,r=(void 0===e?0:e.start)/3,i=(void 0===e?s.count:e.start+e.count)/3;for(let n=r;n<i;n++){const e=3*n,r=3*n+1,i=3*n+2;Ys.p1.set(s.getIndex(e),s.getIndex(e+1),s.getIndex(e+2)),Ys.p2.set(s.getIndex(r),s.getIndex(r+1),s.getIndex(r+2)),Ys.p3.set(s.getIndex(i),s.getIndex(i+1),s.getIndex(i+2)),t(Ys)}}foreachLineSegment(t,e){const s=this.bufferDatum.position,r=(void 0===e?0:e.start)/3,i=(void 0===e?s.count:e.start+e.count)/3;for(let n=r;n<i;n++){const e=3*n,r=3*n+1,i=3*n+2;Ys.p1.set(s.getIndex(e),s.getIndex(e+1),s.getIndex(e+2)),Ys.p2.set(s.getIndex(r),s.getIndex(r+1),s.getIndex(r+2)),Ys.p3.set(s.getIndex(i),s.getIndex(i+1),s.getIndex(i+2)),Hs.p1.copy(Ys.p1),Hs.p2.copy(Ys.p2),t(Hs),Hs.p2.copy(Ys.p3),t(Hs),Hs.p1.copy(Ys.p2),t(Hs)}}foreachVertex(t,e){const s=this.bufferDatum.position,r=void 0===e?0:e.start,i=void 0===e?s.count:e.start+e.count;for(let n=r;n<i;n++)Ws.set(s.getIndex(n),s.getIndex(n+1),s.getIndex(n+2)),t(Ws)}populate(){throw"generate methods not impl"}}class Qs extends Zs{constructor(t,e,s,r){super(),this.name="PlaneGeometry",this.width=void 0!==t?t:1,this.height=void 0!==e?e:1,this.widthSegments=void 0!==s?s:1,this.heightSegments=void 0!==r?r:1,this.populate()}populate(){var t,e,s=this.width/2,r=this.height/2,i=Math.floor(this.widthSegments)||1,n=Math.floor(this.heightSegments)||1,a=i+1,o=n+1,h=this.width/i,c=this.height/n,l=[],u=[],d=[],p=[];for(e=0;e<o;e++){var f=e*c-r;for(t=0;t<a;t++){var m=t*h-s;u.push(m,-f,0),d.push(0,0,1),p.push(t/i),p.push(1-e/n)}}for(e=0;e<n;e++)for(t=0;t<i;t++){const s=t+a*e,r=t+a*(e+1),i=t+1+a*(e+1),n=t+1+a*e;l.push(s,r,n),l.push(r,i,n)}this.create(l,u,d,p)}}const Ks=new ks,Js=new Qs(2,2,1,1);Ks.geometry=Js;class tr{constructor(){this.hasRendered=!1}resetSource(){this.hasRendered=!1}nextRenderable(){return this.hasRendered?null:(this.hasRendered=!0,Ks)}updateSource(){}}var er=s("6dbe");function sr(t,e){const s=document.createElement("a");s.setAttribute("download",e+".png"),s.setAttribute("href",t.toDataURL("image/png").replace("image/png","image/octet-stream")),s.click()}function rr(t){return er["a"](this,void 0,void 0,function*(){const e=new FileReader;return new Promise(function(s,r){e.onload=function(t){const r=e.result;s(r)},e.readAsText(t)})})}function ir(){return new Promise(t=>{const e=document.createElement("input");e.setAttribute("type","file");const s=e=>{t(e.target.files[0])};e.addEventListener("change",s),e.click()})}function nr(){return er["a"](this,void 0,void 0,function*(){const t=yield ir(),e=yield rr(t);return e})}function ar(t,e){for(let s=0;s<t.length;s++)if(e(t[s]))return t[s]}const or=2;let hr="";for(let eh=0;eh<or;eh++)hr+=" ";const cr=[];function lr(t){if(void 0!==cr[t])return cr[t];let e="";for(let s=0;s<t;s++)e+=hr;return cr[t]=e,e}class ur{constructor(){this.currentIndent=0,this.result=""}addIndent(){this.currentIndent++}reduceIndent(){this.currentIndent--}emptyLine(){this.writeLine("")}writeLine(t){this.result+=lr(this.currentIndent)+t+"\n"}writeBlock(t){const e=t.split("\n");e.forEach(t=>{const e=t.trim();e.length>0&&this.writeLine(e)})}writeBlockRaw(t){this.result+=t}writeCommentBlock(t){this.writeLine("/*"),t.split("\n").forEach(t=>{this.writeLine(" * "+t)}),this.writeLine(" */")}reset(){this.currentIndent=0,this.result=""}output(){const t=this.result;return this.reset(),t}}class dr{constructor(){this.uuid=Ut(),this.toNodes=new Set,this.fromNodes=new Set,this.fulfillList=new Map}connectTo(t){this.toNodes.add(t),t._addFromRef(this)}disconnectTo(t){this.toNodes.delete(t),t._removeFromRef(this)}clearAllTo(){this.toNodes.forEach(t=>{t._removeFromRef(this)}),this.toNodes.clear()}clearAllFrom(){this.fromNodes.forEach(t=>{t._removeToRef(this)}),this.fromNodes.clear()}_addFromRef(t){this.fromNodes.add(t)}_removeFromRef(t){this.fromNodes.delete(t)}_addToRef(t){this.toNodes.add(t)}_removeToRef(t){this.toNodes.delete(t)}generateDependencyOrderList(){let t=this.generateAllDependencyList();t.forEach(t=>{t.fulfillList.clear(),t.fromNodes.forEach(e=>{t.fulfillList.set(e.uuid,!1)})});let e=1;const s=[];function r(t){s.push(t),t.toNodes.forEach(e=>{e.fulfillList.delete(t.uuid)})}while(t.length>0)if(t=t.filter(t=>{return 0!==t.fulfillList.size||(r(t),!1)}),e++,e>1e4)throw"generateDependencyOrderList failed, graph may contains loop.";return s}traverseDFS(t){const e=new Set;function s(r){e.has(r)||(e.add(r),t(r),r.fromNodes.forEach(t=>{s(t)}))}s(this)}generateAllDependencyList(){const t=[];return this.traverseDFS(e=>{t.push(e)}),t}}class pr extends dr{constructor(t){super(),this.type=t}swizzling(t){return new Ar(this,t)}}class fr extends pr{constructor(t){super(t.define.returnType),this.inputMap=new Map,this.factory=t}name(t){return this.meaningfulName=t,this}input(t,e){const s=this.factory.define.inputs[t];if(void 0===s)throw`this shader function node has not a input which key is ${t}`;if(s!==e.type)throw console.warn("node:",this),console.warn("inputNode:",e),"constructFragmentGraph failed: type mismatch";return e.connectTo(this),this.inputMap.set(t,e),this}}class mr extends pr{constructor(t,e){super(e),this.name=t,this.type=e}}class gr extends mr{constructor(t){super(t.name,t.type)}default(t){return this.defaultValue=t,this}}class vr extends mr{constructor(t,e){super(t,e)}}class wr extends mr{constructor(t){super(t.name,Le.get(t.mapInner).type),this.mapInner=t.mapInner}}class xr extends mr{constructor(t){super(t.name,t.type),this.attributeUsage=t.usage}}function br(t){let e=t+"";return-1===e.indexOf(".")&&(e+=".0"),e}class yr extends pr{constructor(t){if("number"===typeof t)super(ne.float),this.shaderString=br(t);else if(t instanceof se)super(ne.floatVec2),this.shaderString=`vec2(${br(t.x)}, ${br(t.y)})`;else if(t instanceof kt)super(ne.floatVec3),this.shaderString=`vec2(${br(t.x)}, ${br(t.y)}, ${br(t.z)})`;else{if(!(t instanceof Bt))throw"un support shader const node value";super(ne.floatVec4),this.shaderString=`vec4(${br(t.x)}, ${br(t.y)}, ${br(t.z)}, ${br(t.w)})`}this.value=t}}class _r{constructor(t,e){this.name=t,this.type=e}fetch(t){return new Sr(this,t)}}function Mr(t){switch(t){case ke.texture2D:return ne.floatVec4;default:throw"not support"}}class Sr extends pr{constructor(t,e){super(e.type),this.source=t,this.fetchByNode=e,e.connectTo(this),this.type=Mr(t.type)}}function Cr(t){switch(t){case ne.float:return 1;case ne.floatVec2:return 2;case ne.floatVec3:return 3;case ne.floatVec4:return 4;default:throw"not support combine type"}}class Er extends pr{constructor(t,e){super(e);let s=0;if(t.forEach(t=>{s+=Cr(t.type)}),s!==Cr(e))throw"combine node input not satisfied";this.combineCount=s,this.combines=t,this.combines.forEach(t=>{t.connectTo(this)})}}function Tr(t){switch(t.length){case 1:return ne.float;case 2:return ne.floatVec2;case 3:return ne.floatVec3;case 4:return ne.floatVec4;default:throw"error"}}class Ar extends pr{constructor(t,e){super(t.type),this.swizzleType="";const s=Cr(t.type),r=e.trim().split("");if(r.length>4)throw"swizzle not valid";if(r.length>s)throw"swizzle not valid, swizzle part exceed swizzledSource";this.from=t,t.connectTo(this),this.swizzleType=e,this.type=Tr(e)}}function Rr(t){const e=new ur;e.reset(),e.writeLine("void main(){"),e.addIndent();const s=new Map,r=t.fragmentRoot.generateDependencyOrderList(),i=Nr(r,"gl_FragColor",s);e.writeBlock(i.code),zr(s,i.varList),e.reduceIndent(),e.writeLine("}");const n=e.output(),a=Or(s);return a+n}function Pr(t){const e=new ur;e.reset(),e.writeLine("void main(){"),e.addIndent();const s=new Map,r=t.vertexRoot.generateDependencyOrderList(),i=Nr(r,"gl_Position",s);zr(s,i.varList),e.writeBlock(i.code),e.writeLine("gl_PointSize = 5.0;"),e.emptyLine(),t.varyings.forEach((t,r)=>{const i=t.generateDependencyOrderList(),n=Nr(i,r,s);zr(s,n.varList),e.writeBlock(n.code),e.emptyLine()}),e.reduceIndent(),e.writeLine("}");const n=e.output(),a=Or(s);return a+n}function zr(t,e){e.forEach(e=>{t.has(e.refedNode)||t.set(e.refedNode,e)})}function Or(t){let e="\n";const s=new Set;return t.forEach((t,e)=>{e instanceof fr&&s.add(e.factory)}),s.forEach(t=>{e+=t.genShaderFunctionIncludeCode(),e+="\n"}),e}function Fr(t,e,s){function r(t){let r;return r=s.has(t)?s.get(t):ar(e,e=>{return e.refedNode===t}),r}function i(t){let e="";return e=t.refedNode instanceof mr?t.refedNode.name:t.varKey,e}function n(t){const e=r(t);if(void 0===e)throw"_var_miss";return i(e)}let a=r(t);if(a)return i(a);if(t instanceof fr){const e=t.factory.define;let s="";Object.keys(e.inputs).forEach((r,i)=>{const a=t.inputMap.get(r);if(void 0===a)throw`we have a shader function node but the input <${r}> has no input node`;s+=n(a),i!==Object.keys(e.inputs).length-1&&(s+=", ")});const r=`${e.name}(${s})`;return r}if(t instanceof mr)return t.name;if(t instanceof Sr)return`texture2D(${t.source.name}, ${n(t.fetchByNode)})`;if(t instanceof Er){let e="";t.combines.forEach((s,r)=>{e+=n(s),r!==t.combines.length-1&&(e+=", ")});const s=`vec${t.combineCount}(${e})`;return s}if(t instanceof yr)return t.shaderString;if(t instanceof Ar)return n(t.from)+"."+t.swizzleType;throw"unknown shader node"}function Nr(t,e,s){const r=new ur;r.reset();const i=[];t.forEach(t=>{const e="var"+t.uuid.slice(0,4);i.push({refedNode:t,varKey:e,expression:Fr(t,i,s)})}),i.forEach(t=>{if(t.refedNode instanceof mr)return;if(s.has(t.refedNode))return;const e=le(t.refedNode.type);r.writeLine(`${e} ${t.varKey} = ${t.expression};`)});const n=i[i.length-1];return n.refedNode instanceof mr?r.writeLine(`${e} = ${n.refedNode.name};`):r.writeLine(`${e} = ${n.varKey};`),{code:r.output(),varList:i}}function Dr(t){try{const[s,r]=Lr(t.source,"{"),[i,n]=Lr(s,"("),{name:a,returnType:o}=Br(i),h=Ur(n),c=kr(r);return{name:a,description:t.description,source:c,inputs:h,returnType:o}}catch(e){throw"shader function parsed error"}}function Lr(t,e){for(let s=0;s<t.length;s++){const r=t[s];if(r===e)return[t.substr(0,s),t.substr(s)]}throw"split error"}function Vr(t){switch(t.trim()){case"float":return ne.float;case"vec2":return ne.floatVec2;case"vec3":return ne.floatVec3;case"vec4":return ne.floatVec4;case"mat2":return ne.Mat2;case"mat3":return ne.Mat3;case"mat4":return ne.Mat4;default:throw"parse error"}}function Ir(t){const e=t.trim().split(" ").filter(t=>""!==t);return{name:e[1].trim(),type:Vr(e[0])}}function Ur(t){const e=t.trim();if(")"!==e[e.length-1]||"("!==e[0])throw"err";const s=e.substring(1,e.length-1),r=s.split(",").filter(t=>""!==t.trim()),i={};return r.forEach(t=>{const{name:e,type:s}=Ir(t);i[e]=s}),i}function kr(t){const e=t.trim();if("}"!==e[e.length-1]||"{"!==e[0])throw"err";return e.substring(1,e.length-1)}function Br(t){const e=t.split(" ").filter(t=>""!==t.trim());return{name:e[1].trim(),returnType:Vr(e[0])}}class Gr{constructor(t){this.define=Dr(t)}make(){const t=new fr(this);return t}genShaderFunctionIncludeCode(){const t=new ur;t.reset();const e=this.define,s=le(e.returnType);let r="";const i=Object.keys(e.inputs);return i.forEach((t,s)=>{const n=le(e.inputs[t]),a=`${n} ${t}`;r+=a,s!==i.length-1&&(r+=", ")}),void 0!==e.description&&t.writeCommentBlock(e.description),t.writeLine(`${s} ${e.name}(${r}){`),t.addIndent(),t.writeBlock(e.source),t.reduceIndent(),t.writeLine("}"),t.output()}}const jr=new Gr({source:"\n    vec3 DivW ( vec4 position){\n      return position.xyz / position.w;\n    }\n  "}),$r=new Gr({source:"\n    vec4 MTransform (mat4 MMatrix, vec3 position){\n      return MMatrix * vec4(position, 1.0);\n    }\n  "}),Xr=new Gr({source:"\n    vec4 VPTransform (mat4 VPMatrix, vec4 position){\n      return VPMatrix * position;\n    }\n  "}),qr=(new Gr({description:"Using camera view projection matrix and model matrix to transform vertices",source:"\n    vec4 VPTransform (mat4 VPMatrix, mat4 MMatrix, vec3 position){\n      return VPMatrix * MMatrix * vec4(position, 1.0);\n    }\n  "}),new Gr({description:"Transform from the current view projection matrix and its inverse, \n     and uv coordinates to world position",source:"\n    vec4 getWorldPosition(\n      vec2 uv, \n      float depth, \n      mat4 VPMatrix, \n      mat4 VPMatrixInverse){\n      float clipW = VPMatrix[2][3] * depth + VPMatrix[3][3];\n      return VPMatrixInverse * (vec4(uv * 2.0 - 1.0, depth, 1.0) * clipW);\n    }\n    "})),Yr=new Gr({description:"Get texture uv lookup position from NDC",source:"\n  vec2 NDCTextureLookUp(vec3 ndc){\n    return vec2(ndc.x / 2.0 + 0.5, ndc.y / 2.0 + 0.5);\n  }"}),Hr=new Gr({source:"\n  vec4 UVDepthToNDC(float depth, vec2 uv){\n    return vec4(uv.x * 2.0 - 1.0, uv.y * 2.0 - 1.0,depth, 1.0);\n  }"}),Wr=new Gr({source:"\n  vec3 getLastPixelNDC(vec4 ndc, mat4 VPMatrixInverse, mat4 LastVPMatrix){\n\n    // we consider frag too far is background\n    if(ndc.z > 0.99){\n      return ndc.xyz;\n    }\n    \n    vec4 worldPosition = VPMatrixInverse * ndc;\n    vec4 oldPosition = LastVPMatrix * worldPosition;\n    oldPosition = oldPosition / oldPosition.w;\n    return  oldPosition.xyz;\n  }\n  "}),Zr=new Gr({source:"\n  vec3 randDir(float x, float y){\n    float PI =  3.14159265; // TODO\n    float lambda = acos(2.0 * x - 1.0) - PI / 2.0;\n    float phi = 2.0 * PI * y;\n    return vec3(\n      cos(lambda) * cos(phi),\n      cos(lambda) * sin(phi),\n      sin(lambda)\n    );\n  }\n  "});function Qr(t){return new xr(t)}function Kr(t,e){const s=void 0!==e?e:ke.texture2D;return new _r(t,s)}function Jr(t,e){return new gr({name:t,type:e})}function ti(t,e){if("number"===typeof e)return Jr(t,ne.float).default(e);if(e instanceof se)return Jr(t,ne.floatVec2).default(e);if(e instanceof kt)return Jr(t,ne.floatVec3).default(e);if(e instanceof Bt)return Jr(t,ne.floatVec4).default(e);if(e instanceof Yt)return Jr(t,ne.Mat4).default(e);throw"un support uniform value"}function ei(t){return new wr({name:"inner"+Le.get(t).name,mapInner:t})}function si(...t){return new Er(t,ne.floatVec4)}function ri(t){return new yr(t)}function ii(){return Xr.make().input("VPMatrix",ei(De.VPMatrix)).input("position",$r.make().input("MMatrix",ei(De.MMatrix)).input("position",Qr({name:"position",type:ne.floatVec3,usage:Ue.position})))}function ni(){return si(Qr({name:"position",type:ne.floatVec3,usage:Ue.position}),ri(1))}const ai="v_uv",oi="v_normal",hi="v_position_ndc",ci="v_position_world";class li{constructor(){this.varyings=new Map}setFragmentRoot(t){return this.fragmentRoot=t,this}setVertexRoot(t){if(this.vertexRoot=t,t instanceof fr&&"VPTransform"===t.factory.define.name){const e=t.inputMap.get("position");if(void 0===e)throw"we have a shader function node but the input <position> has no input node";e instanceof fr&&"MTransform"===e.factory.define.name&&this.setVary(ci,e.swizzling("xyz"))}return this.setVary(hi,jr.make().input("position",t)),this}declareFragNormal(){return this.setVary(oi,Qr({name:"normal",type:ne.floatVec3,usage:Ue.normal}))}declareFragUV(){return this.setVary(ai,Qr({name:"uv",type:ne.floatVec2,usage:Ue.uv}))}setVary(t,e){const s=this.varyings.get(t);if(void 0!==s)throw"duplicate vary key found";return this.varyings.set(t,e),this}getFragRoot(){return this.fragmentRoot}getVary(t){const e=this.varyings.get(t);if(void 0===e)throw"cant get vary";return new vr(t,e.type)}reset(){return this.fragmentRoot=null,this.vertexRoot=null,this}compile(){if(null===this.vertexRoot)throw"can't compile shadergraph, vertex root not set";if(null===this.fragmentRoot)throw"can't compile shadergraph, fragment root not set";return Object.assign({},this.collectInputs(),{vertexShaderString:this.compileVertexSource(),fragmentShaderString:this.compileFragSource(),autoInjectHeader:!0})}get nodes(){const t=new Set;this.fragmentRoot.traverseDFS(e=>{t.add(e)}),this.vertexRoot.traverseDFS(e=>{t.add(e)}),this.varyings.forEach(e=>{e.traverseDFS(e=>{t.add(e)})});const e=[];return t.forEach(t=>{e.push(t)}),e}collectInputs(){const t=this.nodes,e=t.filter(t=>t instanceof mr),s=e.filter(t=>t instanceof xr).map(t=>{return{name:t.name,usage:t.attributeUsage,type:t.type}}),r=e.filter(t=>t instanceof gr).map(t=>{return{name:t.name,type:t.type,default:t.defaultValue}}),i=e.filter(t=>t instanceof wr).map(t=>{return{name:t.name,mapInner:t.mapInner}}),n=new Set;t.filter(t=>t instanceof Sr).forEach(t=>{n.add(t.source)});const a=[];n.forEach(t=>{a.push({name:t.name,type:t.type})});const o=[];return this.varyings.forEach((t,e)=>{o.push({name:e,type:t.type})}),{attributes:s,uniforms:r,textures:a,varyings:o,uniformsIncludes:i}}compileVertexSource(){return Pr(this)}compileFragSource(){return Rr(this)}}class ui{constructor(){this.uuid=Ut(),this.graph=new li,this.programConfigCache=null,this.needRebuildShader=!0,this.uniformProvider=[],this.afterShaderCompiled=new Ls}decorate(t){return this.uniformProvider.push(t),this}build(){this.graph.reset(),this.uniformProvider.forEach(t=>{t.decorate(this.graph)})}getProgramConfig(){return this.needRebuildShader&&(this.build(),this.programConfigCache=this.graph.compile(),this.afterShaderCompiled.notifyObservers(this.programConfigCache),this.needRebuildShader=!1),this.programConfigCache}getProgram(t){this.needRebuildShader&&this.disposeProgram(t);let e=t.getProgram(this);return void 0===e&&(e=t.createProgram(this)),e}disposeProgram(t){t.deleteProgram(this)}}function di(t){return(e,s)=>{void 0===e.uniforms&&(e.uniforms=new Map),void 0===e.propertyUniformNameMap&&(e.propertyUniformNameMap=new Map);let r=e[s];const i=()=>{return r},n=s=>{e.uniforms.set(t,s),e.hasAnyUniformChanged=!0,r=s};e.propertyUniformNameMap.set(s,t),Object.defineProperty(e,s,{get:i,set:n,enumerable:!0,configurable:!0})}}class pi{constructor(){this.hasAnyUniformChanged=!0,void 0===this.uniforms&&(this.uniforms=new Map),void 0===this.propertyUniformNameMap&&(this.propertyUniformNameMap=new Map)}getPropertyUniform(t){const e=this.propertyUniformNameMap.get(t),s=this[t];if(void 0===s)throw"uniform value not given";return ti(e,s)}}class fi extends pi{decorate(t){t.setVertexRoot(ni()).declareFragUV().setFragmentRoot(Kr("copySource").fetch(t.getVary(ai)))}}const mi=new se,gi=new se,vi=new se;class wi{constructor(t){this.enabled=!0,this.mouseButton=-1,this.controllers=[],this.onMouseMove=(t=>{this.enabled&&(gi.set(t.clientX,t.clientY),vi.copy(mi).sub(gi),0===this.mouseButton&&this.groupEmit(this.leftMouseMoveCallBacks,vi),2===this.mouseButton&&this.groupEmit(this.rightMouseMoveCallBacks,vi),mi.copy(gi))}),this.onMouseDown=(t=>{this.enabled&&(mi.set(t.clientX,t.clientY),this.mouseButton=t.button,t.preventDefault())}),this.onMouseUp=(t=>{this.enabled&&(this.groupEmit(this.mouseUpCallBacks),this.mouseButton=-1)}),this.onMouseWheel=(t=>{if(!this.enabled)return;let e=0;void 0!==t.wheelDelta?e=t.wheelDelta:void 0!==t.deltaY&&(e=-t.deltaY),e=e>0?1.1:.9,this.groupEmit(this.mouseWheelCallBacks,e)}),this.leftMouseMoveCallBacks=[],this.rightMouseMoveCallBacks=[],this.mouseWheelCallBacks=[],this.mouseDownCallBacks=[],this.mouseUpCallBacks=[],this.inputElement=t,this.bind()}bind(){const t=this.inputElement;this.mouseButton=-1,t.addEventListener("mousemove",this.onMouseMove,!1),t.addEventListener("mousedown",this.onMouseDown,!1),t.addEventListener("mouseup",this.onMouseUp,!1),t.addEventListener("wheel",this.onMouseWheel,!1),t.addEventListener("contextmenu",this.preventContentMenu,!1)}unbind(){const t=this.inputElement;this.mouseButton=-1,t.removeEventListener("mousemove",this.onMouseMove),t.removeEventListener("mousedown",this.onMouseDown),t.removeEventListener("mouseup",this.onMouseUp),t.removeEventListener("wheel",this.onMouseWheel),t.removeEventListener("contextmenu",this.preventContentMenu,!1)}preventContentMenu(t){t.preventDefault(),t.stopPropagation()}groupEmit(t,...e){t.forEach(t=>{t.callback(...e)})}removeController(t,e){e=e.filter(e=>{return e.controller===t})}bindLeftMouseMove(t,e){this.leftMouseMoveCallBacks.push({controller:t,callback:e})}bindRightMouseMove(t,e){this.rightMouseMoveCallBacks.push({controller:t,callback:e})}bindMouseWheel(t,e){this.mouseWheelCallBacks.push({controller:t,callback:e})}bindMouseDown(t,e){this.mouseDownCallBacks.push({controller:t,callback:e})}bindMouseUp(t,e){this.mouseUpCallBacks.push({controller:t,callback:e})}unbindControllerAllListener(t){this.removeController(t,this.mouseUpCallBacks),this.removeController(t,this.rightMouseMoveCallBacks),this.removeController(t,this.mouseWheelCallBacks),this.removeController(t,this.mouseDownCallBacks),this.removeController(t,this.mouseUpCallBacks)}dispose(){this.unbind(),this.leftMouseMoveCallBacks=[],this.rightMouseMoveCallBacks=[],this.mouseWheelCallBacks=[],this.mouseDownCallBacks=[],this.mouseUpCallBacks=[]}}function xi(t,e){t.updateSource(),t.resetSource();let s=null;do{s=t.nextRenderable(),null!==s&&e(s)}while(null!==s)}const bi=(new ui).decorate(new fi),yi=new tr;class _i{constructor(t,e){this._preferVAO=!0,this._vaoEnabled=!1,this.resizeObservable=new Ls,this.overrideShading=null,this.defaultTechnique=(new ui).decorate(new Ii),this._camera=new Fs,this.isCameraChanged=!0,this.cameraMatrixReverse=new Yt,this.ProjectionMatrix=new Yt,this.VPMatrix=new Yt,this.LastVPMatrix=new Yt,this.jitterPMatrix=new Yt,this.jitterVPMatrix=new Yt,this.globalUniforms=new Map,this.lastUploadedShaderUniformProvider=new Set,this.programShadingMap=new Map,this.renderer=new Cs(t,e),void 0!==t&&(this.camera.aspect=t.width/t.height),this.interactor=new wi(t),Le.forEach((t,e)=>{this.globalUniforms.set(e,new Ns(t.default))}),this.preferVAO=!0}get vaoEnabled(){return this._vaoEnabled}get preferVAO(){return this._preferVAO}set preferVAO(t){this._preferVAO=t,t?(this.renderer.vaoManager.isSupported||console.warn("prefer vao is set to true, but your environment cant support vao, vaoEnabled is false"),this._vaoEnabled=!0):(this.renderer.vaoManager.releaseGL(),this._vaoEnabled=!1)}setSize(t,e){this.renderer.setSize(t,e)&&this.resizeObservable.notifyObservers({width:t,height:e})}setActualSize(t,e){this.renderer.setRawRenderSize(t,e)&&this.resizeObservable.notifyObservers({width:t,height:e})}get camera(){return this._camera}set camera(t){this._camera=t,this.isCameraChanged=!0}jitterProjectionMatrix(){this.jitterPMatrix.copy(this.ProjectionMatrix),this.jitterPMatrix.elements[8]+=(2*Math.random()-1)/this.renderer.width,this.jitterPMatrix.elements[9]+=(2*Math.random()-1)/this.renderer.height,this.jitterVPMatrix.multiplyMatrices(this.jitterPMatrix,this.cameraMatrixReverse),this.getGlobalUniform(De.VPMatrix).setValue(this.jitterVPMatrix)}unJit(){this.getGlobalUniform(De.VPMatrix).setValue(this.VPMatrix)}connectCamera(){let t=!1;this.camera.projectionMatrixNeedUpdate&&(this.camera.updateProjectionMatrix(),this.ProjectionMatrix.copy(this.camera.projectionMatrix),t=!0),this.camera.transform.transformFrameChanged&&(this.camera.transform.matrix,this.camera.updateWorldMatrix(!0),this.cameraMatrixReverse.getInverse(this.camera.worldMatrix,!0),t=!0),this.LastVPMatrix.copy(this.VPMatrix),this.getGlobalUniform(De.LastVPMatrix).setValue(this.LastVPMatrix),t?(this.VPMatrix.multiplyMatrices(this.ProjectionMatrix,this.cameraMatrixReverse),this.getGlobalUniform(De.VPMatrix).setValue(this.VPMatrix),t=!1,this.isCameraChanged=!0):this.isCameraChanged=!1}render(t){xi(t,t=>{this.renderObject(t)})}renderObjects(t){for(let e=0;e<t.length;e++)this.renderObject(t[e])}renderObject(t){const e=this.connectShading(t);this.connectMaterial(t.material,e),this.connectGeometry(t.geometry,e),this.connectRange(t.range,e,t.geometry),t.state.syncGL(this.renderer),this.renderer.render(t.drawMode,e.useIndexDraw)}renderFrameBuffer(t,e){this.renderer.setRenderTargetScreen(),this.renderer.state.setViewport(e.x,e.y,e.z,e.w),this.overrideShading=bi,this.overrideShading.getProgram(this).defineFrameBufferTextureDep(t.name,"copySource"),this.render(yi),this.overrideShading=null}getGlobalUniform(t){return this.globalUniforms.get(t)}connectShading(t){let e;e=null!==this.overrideShading?this.overrideShading:void 0!==t.shading?t.shading:this.defaultTechnique;const s=e.getProgram(this);return this.lastProgramRendered!==s&&this.lastUploadedShaderUniformProvider.clear(),this.renderer.useProgram(s),this.getGlobalUniform(De.MMatrix).setValue(t.worldMatrix),s.updateInnerGlobalUniforms(this),e.uniformProvider.forEach(t=>{this.lastUploadedShaderUniformProvider.has(t)&&!t.hasAnyUniformChanged||(t.uniforms.forEach((t,e)=>{s.setUniform(e,t)}),t.hasAnyUniformChanged=!1,this.lastUploadedShaderUniformProvider.add(t))}),s}connectMaterial(t,e){e.forTextures(s=>{let r;if(void 0!==t){if(void 0===s.channel)throw"use texture in material / use material to render should set texture uniform channel type";const e=t.getChannelTexture(s.channel);r=e.getGLTexture(this)}if(void 0===r){const t=e.framebufferTextureMap[s.name];if(void 0===t)throw`cant find framebuffer for tex ${s.name}, please define before use`;r=this.renderer.framebufferManager.getFramebufferTexture(t)}if(void 0===r)throw"texture bind failed";s.useTexture(r)})}connectGeometry(t,e){if(e.useIndexDraw){if(null===t.indexBuffer)throw"indexBuffer not found for index draw";const s=t.indexBuffer;s.data instanceof Uint32Array?e.indexUINT=!0:e.indexUINT=!1}let s;if(this._vaoEnabled){const e=this.renderer.vaoManager,r=e.getVAO(t);if(void 0!==r||!t.needUpdate)return void e.useVAO(r);e.deleteVAO(t),s=e.createVAO(t)}if(e.forAttributes(s=>{const r=t.bufferDatum[s.name];if(void 0===r)throw`program ${e.name} needs an attribute named ${s.name}, but cant find in geometry data`;let i=this.getGLAttributeBuffer(r);void 0===i&&r.shouldUpdate&&(i=this.createOrUpdateAttributeBuffer(r,!1),r.shouldUpdate=!1),s.useBuffer(i)}),e.useIndexDraw){const s=t.indexBuffer;let r=this.getGLAttributeBuffer(s);void 0===r&&(r=this.createOrUpdateAttributeBuffer(s,!0)),e.useIndexBuffer(r)}this._vaoEnabled&&s&&(s.unbind(),this.renderer.vaoManager.useVAO(s.vao))}connectRange(t,e,s){let r=0,i=0;if(void 0===t){if(null===s.indexBuffer)throw"range should be set if use none index geometry";i=s.indexBuffer.data.length}e.drawFrom=r,e.drawCount=i}getProgram(t){return this.programShadingMap.get(t)}createProgram(t){const e=this.renderer.createProgram(t.getProgramConfig());return this.programShadingMap.set(t,e),e}deleteProgram(t){const e=this.programShadingMap.get(t);void 0!==e&&(e.dispose(),this.programShadingMap.delete(t))}getGLAttributeBuffer(t){return this.renderer.attributeBufferManager.getGLBuffer(t.data.buffer)}createOrUpdateAttributeBuffer(t,e){return this.renderer.attributeBufferManager.updateOrCreateBuffer(t.data.buffer,e)}downloadCurrentRender(){sr(this.renderer.el,"artgl-renderscreenshot")}releaseGL(){this.renderer.releaseGL()}dispose(){this.resizeObservable.clear(),this.releaseGL(),this.interactor.dispose()}}class Mi{constructor(t){this.size=10,this.count=0,this.records=[],this.all=0,this.size=void 0===t?10:t,this.reset()}get average(){return this.count>=this.size?this.all/this.size:this.all/this.count}get last(){return Math.max(0,this.count-this.size)%this.size}push(t){this.count++;const e=this.count%this.size;this.all-=this.records[this.last],this.all+=t,this.records[e]=t}reset(){this.count=0,this.all=0,this.records=[];for(let t=0;t<this.size;t++)this.records.push(0)}resetWithNewSize(t){this.size=t,this.reset()}}class Si{constructor(){this.avgRenderFrameTimeLast120Frame=new Mi(120),this.userRenderFrame=null,this.renderFrame=(t=>{this.frameStart(t),null!==this.userRenderFrame&&this.userRenderFrame(t),this.frameEnd(performance.now()),this.active&&(this.tickId=window.requestAnimationFrame(this.renderFrame))}),this.active=!1,this.frameStartTime=0}setFrame(t){this.userRenderFrame=t}run(){this.active=!0,this.tickId=window.requestAnimationFrame(this.renderFrame)}step(){this.active||this.renderFrame(performance.now())}stop(){this.active=!1,void 0!==this.tickId&&window.cancelAnimationFrame(this.tickId)}frameStart(t){this.frameStartTime=t}frameEnd(t){this.avgRenderFrameTimeLast120Frame.push(t-this.frameStartTime)}}class Ci extends Us{constructor(){super(),this.drawMode=Be.LINES}}class Ei extends Us{constructor(){super(),this.drawMode=Be.POINTS}}var Ti,Ai,Ri;(function(t){t["diffuse"]="diffuse",t["roughness"]="roughness",t["metallic"]="metallic",t["ao"]="ao"})(Ti||(Ti={}));class Pi{constructor(){this.list=[],this.realLength=0,this.renderListCursor=0}addRenderItem(t){this.realLength<this.list.length?this.list[this.realLength]=t:this.list.push(t),this.realLength++}forEach(t){for(let e=0;e<this.realLength;e++)t(this.list[e])}next(){if(this.renderListCursor>=this.list.length)return null;const t=this.list[this.renderListCursor];return this.renderListCursor++,t}reset(){this.realLength=0}resetCursor(){this.renderListCursor=0}clear(){this.list=[]}sort(){}}class zi{constructor(){this.root=new Ps,this.objectList=new Pi,this.isFrameStructureChange=!0,this.isFrameTransformChange=!0,this.isFrameVisibleChange=!0,this.onRemoveList=new Set,this.onAddList=new Set}get isFrameChange(){return this.isFrameStructureChange||this.isFrameTransformChange||this.isFrameVisibleChange}addNode(t){this.onRemoveList.delete(t),this.onAddList.add(t),this.isFrameStructureChange=!0}removeNode(t){this.onAddList.delete(t),this.onRemoveList.add(t),this.isFrameStructureChange=!0}updateSource(){this.isFrameStructureChange&&this.updateObjectList()}resetSource(){this.objectList.resetCursor()}nextRenderable(){return this.objectList.next()}updateObjectList(){this.objectList.reset(),this.onRemoveList.clear(),this.onAddList.clear(),this.root.traverse(t=>{t.scene=this,(this.isFrameStructureChange||this.isFrameTransformChange)&&(null!==t.parent?t._worldMatrix.multiplyMatrices(t.parent._worldMatrix,t.transform.matrix):t._worldMatrix.copy(t.transform.matrix)),t instanceof Us&&this.objectList.addRenderItem(t)}),this.isFrameStructureChange=!1,this.isFrameTransformChange=!1,this.isFrameVisibleChange=!1}updateWorldMatrix(){this.root.updateWorldMatrix(!0)}setRootNode(t){if(t.scene)throw"node has set to scene, abort";this.root=t,this.isFrameStructureChange=!0}disposeRootNode(){if(!this.root)throw"scene hasn't root";this.root.traverse(t=>{t.scene=null}),this.root=null}registGeometryLoader(t){}}(function(t){t[t["bindRenderSize"]=0]="bindRenderSize",t[t["fixed"]=1]="fixed"})(Ai||(Ai={})),function(t){t[t["DisableColorWrite"]=0]="DisableColorWrite",t[t["DisableAlphaWrite"]=1]="DisableAlphaWrite"}(Ri||(Ri={}));class Oi{constructor(t){if(this.enableDepthClear=!0,this.enableColorClear=!0,this.overrideShading=null,this.inputTarget=new Map,this.isOutputScreen=!0,this.define=t,this.name=t.name,void 0!==t.shading){const e=t.shading;if(void 0===e)throw`technique '${t.shading}' not defined`;this.overrideShading=e}this.clearColor=t.clearColor,this.enableColorClear=void 0===t.enableColorClear||t.enableColorClear,this.enableDepthClear=void 0===t.enableDepthClear||t.enableDepthClear,this.beforePassExecute=t.beforePassExecute,this.afterPassExecute=t.afterPassExecute}updateInputTargets(t){this.inputTarget.clear(),Object.keys(t).forEach(e=>{const s=t[e];this.inputTarget.set(e,s)})}setOutPutTarget(t,e){e.name===Ni.screenRoot?(this.outputTarget=void 0,this.isOutputScreen=!0):(this.outputTarget=e.getOrCreateFrameBuffer(t),this.isOutputScreen=!1)}renderDebugResult(t,e){const s=e.renderTargetNodes.get(this.outputTarget.name).debugViewPort;t.renderFrameBuffer(this.outputTarget,s),this.inputTarget.forEach((s,r)=>{const i=t.renderer.framebufferManager.getFramebuffer(s),n=e.renderTargetNodes.get(i.name).debugViewPort;t.renderFrameBuffer(i,n)})}execute(t,e){if(this.isOutputScreen)if(t.renderer.setRenderTargetScreen(),e.enableDebuggingView){const s=e.screenNode.debugViewPort;t.renderer.state.setViewport(s.x,s.y,s.z,s.w)}else t.renderer.state.setFullScreenViewPort();else t.renderer.setRenderTarget(this.outputTarget),t.renderer.state.setViewport(0,0,this.outputTarget.width,this.outputTarget.height);null!==this.overrideShading&&(t.overrideShading=this.overrideShading,this.inputTarget.forEach((e,s)=>{t.overrideShading.getProgram(t).defineFrameBufferTextureDep(e,s)})),this.enableColorClear&&(void 0!==this.clearColor&&t.renderer.state.colorbuffer.setClearColor(this.clearColor),t.renderer.state.colorbuffer.clear()),this.enableDepthClear&&!this.isOutputScreen&&this.outputTarget.enableDepth&&t.renderer.state.depthbuffer.clear(),void 0!==this.beforePassExecute&&this.beforePassExecute(),this.define.source.forEach(e=>{t.render(e)}),void 0!==this.afterPassExecute&&this.afterPassExecute(),t.overrideShading=null,t.renderer.state.colorbuffer.resetDefaultClearColor(),e.enableDebuggingView&&!this.isOutputScreen&&this.renderDebugResult(t,e)}checkIsValid(){if(this.isOutputScreen)return;const t=this.outputTarget.name;this.inputTarget.forEach(e=>{if(e===t)throw`you cant output to the render target which is depend on: \nDuplicate target: ${this.outputTarget.name};`})}}class Fi{constructor(){this.passes=[],this.nodeMap=new Map}render(t,e){this.passes.forEach(s=>{s.execute(t,e)})}reset(){this.passes=[]}addPass(t){this.passes.push(t)}registerNode(t,e){const s=new Oi(e);this.nodeMap.set(t,s)}clear(){this.passes=[],this.nodeMap.clear()}getPass(t){return this.nodeMap.get(t)}}class Ni{constructor(){this.enableDebuggingView=!1,this.renderTargetNodes=new Map,this.passNodes=new Map}get nodes(){const t=[];return this.passNodes.forEach(e=>{t.push(e)}),this.renderTargetNodes.forEach(e=>{t.push(e)}),t}reset(){this.renderTargetNodes.clear(),this.passNodes.clear()}defineGraph(t,e){this.reset(),this.allocateRenderTargetNodes(e.renderTargets),this.constructPassGraph(e.passes,t)}update(t,e){this.passNodes.forEach(t=>{t.updateDependNode(this)}),this.renderTargetNodes.forEach(t=>{t.updateDependNode(this)});const s=this.screenNode.generateDependencyOrderList();e.reset(),s.forEach(e=>{e instanceof Di&&e.updateSize(t)}),s.forEach(r=>{if(r instanceof Li){const i=e.getPass(r);if(void 0===i)throw"err";r.updatePass(t,i,s),e.addPass(i)}})}constructPassGraph(t,e){t.forEach(t=>{if(this.passNodes.has(t.name))throw"duplicate pass define found";{const s=new Li(this,t);this.passNodes.set(t.name,s),e.registerNode(s,t)}})}getRenderTargetDependence(t){return this.renderTargetNodes.get(t)}getRenderPassDependence(t){return this.passNodes.get(t)}getRootScreenTargetNode(){let t;return this.renderTargetNodes.forEach(e=>{e.isScreenNode&&(t=e)}),t}allocateRenderTargetNodes(t){if(t.forEach(t=>{if(this.renderTargetNodes.has(t.name))throw"render graph build error, duplicate texture key name found ";const e=new Di(t);if(t.name===Ni.screenRoot){if(void 0!==this.screenNode)throw"duplicate screen root node";this.screenNode=e}this.renderTargetNodes.set(t.name,e)}),void 0===this.screenNode)throw"screen root not found"}}Ni.screenRoot="artgl-rendergraph-screen-rt",Ni.quadSource=new tr;class Di extends dr{constructor(t){super(),this.debugViewPort=new Bt(0,0,200,200),this.autoWidthRatio=0,this.autoHeightRatio=0,this.enableDepth=!0,this.widthAbs=0,this.heightAbs=0,this.from=null,this.name=t.name,this.define=t,this.fromGetter=t.from,this.isScreenNode=t.name===Ni.screenRoot,this.isScreenNode||(void 0===t.format&&(t.format={pixelFormat:ss.RGBA,dimensionType:Ai.bindRenderSize}),t.format.dimensionType===Ai.bindRenderSize&&(this.autoWidthRatio=void 0!==t.format.width?Ht.clamp(t.format.width,0,1):1,this.autoHeightRatio=void 0!==t.format.height?Ht.clamp(t.format.height,0,1):1),this.enableDepth=void 0===t.format.disableDepthBuffer||t.format.disableDepthBuffer)}getOrCreateFrameBuffer(t){const e=t.renderer.framebufferManager.getFramebuffer(this.name);return e||t.renderer.framebufferManager.createFrameBuffer(t,this.name,this.widthAbs,this.heightAbs,this.enableDepth)}updateSize(t){if(this.isScreenNode)return;const e=this.define;let s,r;e.format.dimensionType===Ai.fixed?(s=void 0!==e.format.width?e.format.width:t.renderer.width,r=void 0!==e.format.height?e.format.height:t.renderer.height):(s=Math.max(5,t.renderer.width*this.autoWidthRatio),r=Math.max(5,t.renderer.height*this.autoHeightRatio)),this.widthAbs=Math.max(5,s),this.heightAbs=Math.max(5,r),this.getOrCreateFrameBuffer(t).resize(t,s,r)}updateDependNode(t){if(this.clearAllFrom(),this.from=this.fromGetter(),null!==this.from){const e=t.getRenderPassDependence(this.from);e.connectTo(this)}}}class Li extends dr{constructor(t,e){super(),this.inputsGetter=null,this.inputs={},this.name=e.name,void 0!==e.inputs&&(this.inputsGetter=e.inputs)}updateDependNode(t){this.clearAllFrom(),null!==this.inputsGetter&&(this.inputs=this.inputsGetter());const e=this.inputs;Object.keys(e).forEach(s=>{const r=e[s],i=t.getRenderTargetDependence(r);if(void 0===i)throw`render graph updating error, renderTarget depend node ${r} cant found`;i.connectTo(this)})}updatePass(t,e,s){e.updateInputTargets(this.inputs);let r=null;if(0===this.toNodes.size)throw"cant found render target node for a render pass";this.toNodes.forEach(i=>{if(i instanceof Di)for(let n=0;n<s.length;n++)if(s[n]===i){if(null!==r)throw`RenderGraph update error: one target node should only has one pass targeted;\nprevious found target pass: ${r.name};\nnew found target pass: ${s[n].name};\n              `;r=i,e.setOutPutTarget(t,i)}}),e.checkIsValid()}}const Vi=new Gr({source:"vec4 normalShading(vec3 normal){\n      return vec4(normal * 0.5 + 0.5, 1.0);\n    }"});class Ii extends pi{decorate(t){t.setVertexRoot(ii()).declareFragNormal().setFragmentRoot(Vi.make().input("normal",t.getVary(oi)))}}const Ui=new Gr({description:"pack depth to RGBA output",source:"\n    vec4 depthPack(float frag_depth){\n      vec4 bitSh = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n      vec4 bitMsk = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n      vec4 enc = fract(frag_depth * bitSh);\n      enc -= enc.xxyz * bitMsk;\n      return enc;\n    }\n  "}),ki=new Gr({description:"unpack depth from RGBA channel",source:"\n  float UnpackDepth( vec4 enc ) {\n    const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );\n    return dot( enc, bit_shift );\n}"}),Bi=new Gr({source:"float rand(float n) {return fract(sin(n) * 43758.5453123);}"}),Gi=(new Gr({source:"\n  float rand(vec2 cood){\n    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\n}\n  "}),new Gr({source:"\n  float rand(vec2 cood, float t){\n    vec2 co = cood;\n    co.x = sin(t) + co.x;\n    co.y = cos(t) + co.y;\n    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\n}\n  "})),ji=new Gr({source:"\n  vec3 newPosition(vec3 positionOld, float distance, vec3 dir){\n    return distance * dir + positionOld;\n  }\n  "}),$i=new Gr({source:"\n  vec3 depthFromWorldPositionAndVPMatrix(vec3 position, mat4 matrix){\n    vec4 ndc = matrix * vec4(position, 1.0);\n    ndc = ndc / ndc.w;\n    return ndc.xyz;\n  }\n  "}),Xi=new Gr({source:"\n  vec3 sampleAO(float depth, float newDepth){\n    if (depth >0.999){\n      return vec3(0.5);\n    }\n    float rate =  depth > newDepth ? 0.0 : 1.0;\n    return vec3(rate);\n  }\n  "}),qi=new Gr({source:"\n  vec4 tssaoMix(vec3 oldColor, vec3 newColor, float sampleCount){\n    return vec4((oldColor * sampleCount + newColor) / (sampleCount + 1.0), 1.0);\n  }\n  "});class Yi extends pi{constructor(){super(...arguments),this.sampleCount=0,this.VPMatrixInverse=new Yt,this.aoRadius=1}decorate(t){const e=ei(De.VPMatrix),s=this.getPropertyUniform("sampleCount"),r=Kr("depthResult");t.setVertexRoot(ni()).declareFragUV();const i=t.getVary(ai),n=ki.make().input("enc",r.fetch(i)),a=qr.make().input("uv",i).input("depth",n).input("VPMatrix",e).input("VPMatrixInverse",this.getPropertyUniform("VPMatrixInverse")),o=Gi.make().input("cood",i).input("t",s),h=Bi.make().input("n",o),c=Zr.make().input("x",o).input("y",h),l=ji.make().input("positionOld",a.swizzling("xyz")).input("distance",this.getPropertyUniform("aoRadius")).input("dir",c),u=ki.make().input("enc",r.fetch(Yr.make().input("ndc",$i.make().input("position",l).input("matrix",e))));t.setFragmentRoot(qi.make().input("oldColor",Kr("AOAcc").fetch(i).swizzling("xyz")).input("newColor",Xi.make().input("depth",n).input("newDepth",u)).input("sampleCount",s))}}er["b"]([di("u_sampleCount")],Yi.prototype,"sampleCount",void 0),er["b"]([di("VPMatrixInverse")],Yi.prototype,"VPMatrixInverse",void 0),er["b"]([di("u_aoRadius")],Yi.prototype,"aoRadius",void 0);const Hi=new Gr({source:"\n  vec4 tssaoBlend(\n    vec3 color, \n    vec3 aoColor, \n    float sampleCount, \n    float tssaoComposeRate,\n    float tssaoShowThreshold,\n    float tssaoComposeThreshold\n    ) {\n    vec3 aoModify = vec3(1.0) - tssaoComposeRate * (vec3(1.0) - aoColor) * vec3(min(sampleCount / tssaoShowThreshold, 1.0));\n    aoModify = clamp(aoModify + vec3(tssaoComposeThreshold), vec3(0.0), vec3(1.0));\n    return vec4(color * aoModify, 1.0);\n  }\n  "});class Wi extends pi{constructor(){super(...arguments),this.sampleCount=0,this.tssaoComposeRate=1,this.tssaoShowThreshold=200,this.tssaoComposeThreshold=.5}decorate(t){t.setVertexRoot(ni()).declareFragUV().setFragmentRoot(Hi.make().input("color",Kr("basic").fetch(t.getVary(ai)).swizzling("xyz")).input("aoColor",Kr("tssao").fetch(t.getVary(ai)).swizzling("xyz")).input("sampleCount",this.getPropertyUniform("sampleCount")).input("tssaoComposeRate",this.getPropertyUniform("tssaoComposeRate")).input("tssaoShowThreshold",this.getPropertyUniform("tssaoShowThreshold")).input("tssaoComposeThreshold",this.getPropertyUniform("tssaoComposeThreshold")))}}er["b"]([di("u_sampleCount")],Wi.prototype,"sampleCount",void 0),er["b"]([di("u_tssaoComposeRate")],Wi.prototype,"tssaoComposeRate",void 0),er["b"]([di("u_tssaoShowThreshold")],Wi.prototype,"tssaoShowThreshold",void 0),er["b"]([di("u_tssaoComposeThreshold")],Wi.prototype,"tssaoComposeThreshold",void 0);const Zi=new Gr({source:"\n    float depthVary(vec4 worldPosition){\n      return worldPosition.z / worldPosition.w;\n    }\n    "});class Qi extends pi{decorate(t){const e=ii();t.setVertexRoot(e).setVary("depth",Zi.make().input("worldPosition",e)).setFragmentRoot(Ui.make().input("frag_depth",t.getVary("depth")))}}const Ki=new Gr({source:"\n  vec4 TAAMix (vec3 oldColor, vec3 newColor, float sampleCount){\n    float rate = 0.05;\n    // return vec4(newColor * rate + (1.0 - rate) * oldColor, 1.0);\n    \n    return vec4((oldColor * sampleCount + newColor) / (sampleCount + 1.0), 1.0);\n\n    // need figure out how to clamp color\n    // if(sampleCount < 0.1){\n    //   // vec3 clampedOldColor = getClampColor(v_uv, oldColor);\n    //   // return vec4(newColor * rate + (1.0 - rate) * clampedOldColor, 1.0);\n    //   return vec4(newColor * rate + (1.0 - rate) * oldColor, 1.0);\n    // } else{\n    //   return vec4((oldColor * sampleCount + newColor) / (sampleCount + 1.0), 1.0);\n    // }\n\n  }\n    "});class Ji extends pi{constructor(){super(...arguments),this.VPMatrixInverse=new Yt,this.sampleCount=0}decorate(t){t.setVertexRoot(ni()).declareFragUV();const e=t.getVary(ai),s=ki.make().input("enc",Kr("depthResult").fetch(e)),r=Kr("TAAHistoryOld").fetch(Yr.make().input("ndc",Wr.make().input("ndc",Hr.make().input("depth",s).input("uv",t.getVary(ai))).input("VPMatrixInverse",this.getPropertyUniform("VPMatrixInverse")).input("LastVPMatrix",ei(De.LastVPMatrix))));t.setFragmentRoot(Ki.make().input("oldColor",r.swizzling("xyz")).input("newColor",Kr("sceneResult").fetch(e).swizzling("xyz")).input("sampleCount",this.getPropertyUniform("sampleCount")))}}er["b"]([di("VPMatrixInverse")],Ji.prototype,"VPMatrixInverse",void 0),er["b"]([di("u_sampleCount")],Ji.prototype,"sampleCount",void 0);class tn extends Zs{constructor(t,e,s,r,i,n,a){super(),this.name="SphereGeometry",this.radius=1,this.widthSegments=10,this.heightSegments=10,this.phiStart=0,this.phiLength=2*Math.PI,this.thetaStart=0,this.thetaLength=2*Math.PI,this.radius=void 0!==t?t:1,this.widthSegments=Math.max(3,Math.floor(e)||8),this.heightSegments=Math.max(2,Math.floor(s)||6),this.phiStart=void 0!==r?r:0,this.phiLength=void 0!==i?i:2*Math.PI,this.thetaStart=void 0!==n?n:0,this.thetaLength=void 0!==a?a:Math.PI,this.thetaEnd=this.thetaStart+this.thetaLength,this.populate()}populate(){let t,e,s=0,r=[],i=new kt(0,0,0),n=new kt(0,0,0),a=[],o=[],h=[],c=[];for(e=0;e<=this.heightSegments;e++){let a=[],l=e/this.heightSegments;for(t=0;t<=this.widthSegments;t++){let e=t/this.widthSegments;i.x=-this.radius*Math.cos(this.phiStart+e*this.phiLength)*Math.sin(this.thetaStart+l*this.thetaLength),i.y=this.radius*Math.cos(this.thetaStart+l*this.thetaLength),i.z=this.radius*Math.sin(this.phiStart+e*this.phiLength)*Math.sin(this.thetaStart+l*this.thetaLength),o.push(i.x,i.y,i.z),n.set(i.x,i.y,i.z).normalize(),h.push(n.x,n.y,n.z),c.push(e,1-l),a.push(s++)}r.push(a)}for(e=0;e<this.heightSegments;e++)for(t=0;t<this.widthSegments;t++){let s=r[e][t+1],i=r[e][t],n=r[e+1][t],o=r[e+1][t+1];(0!==e||this.thetaStart>0)&&a.push(s,i,o),(e!==this.heightSegments-1||this.thetaEnd<Math.PI)&&a.push(i,n,o)}this.create(a,o,h,c)}}class en extends Zs{constructor(t,e,s,r,i,n){super(),this.width=1,this.height=1,this.depth=1,this.widthSegments=1,this.heightSegments=1,this.depthSegments=1,void 0!==t&&(this.width=t),void 0!==e&&(this.height=e),void 0!==s&&(this.depth=s),void 0!==r&&(this.widthSegments=r),void 0!==i&&(this.heightSegments=i),void 0!==n&&(this.depthSegments=n),this.populate()}populate(){const t=[],e=[],s=[],r=[];let i=0;function n(n,a,o,h,c,l,u,d,p,f){const m=l/p,g=u/f,v=l/2,w=u/2,x=d/2,b=p+1,y=f+1;let _,M;const S=new kt;let C=0;for(M=0;M<y;M++){var E=M*g-w;for(_=0;_<b;_++){var T=_*m-v;S[n]=T*h,S[a]=E*c,S[o]=x,e.push(S.x,S.y,S.z),S[n]=0,S[a]=0,S[o]=d>0?1:-1,s.push(S.x,S.y,S.z),r.push(_/p),r.push(1-M/f),C+=1}}for(M=0;M<f;M++)for(_=0;_<p;_++){var A=i+_+b*M,R=i+_+b*(M+1),P=i+(_+1)+b*(M+1),z=i+(_+1)+b*M;t.push(A,R,z),t.push(R,P,z)}i+=C}n("z","y","x",-1,-1,this.depth,this.height,this.width,this.depthSegments,this.heightSegments),n("z","y","x",1,-1,this.depth,this.height,-this.width,this.depthSegments,this.heightSegments),n("x","z","y",1,1,this.width,this.depth,this.height,this.widthSegments,this.depthSegments),n("x","z","y",1,-1,this.width,this.depth,-this.height,this.widthSegments,this.depthSegments),n("x","y","z",1,-1,this.width,this.height,this.depth,this.widthSegments,this.heightSegments),n("x","y","z",-1,-1,this.width,this.height,-this.depth,this.widthSegments,this.heightSegments),this.create(t,e,s,r)}}class sn{constructor(){}}class rn{constructor(t,e,s){this.center=new kt,this.radius=void 0!==t?t:1,this.polar=void 0!==e?e:0,this.azim=void 0!==s?s:0}set(t,e,s){return this.radius=t,this.polar=e,this.azim=s,this}copy(t){return this.set(t.radius,t.polar,t.azim)}clone(){return new rn(this.radius,this.polar,this.azim)}setFromVector(t){return this.radius=t.length(),0===this.radius?(this.polar=0,this.azim=0):(this.polar=Math.acos(Ht.clamp(t.y/this.radius,-1,1)),this.azim=Math.atan2(t.x,t.z)),this}}const nn=new kt;class an extends sn{constructor(t){super(),this.camera=t,this.spherical=new rn,this.rotateAngleFactor=.5,this.panFactor=.002,this.maxPolarAngle=179/180*Math.PI,this.minPolarAngle=.1,this.sphericalDelta=new rn(0,0,0),this.zoomingFactor=1,this.panOffset=new kt,this.enableDamping=!0,this.dampingFactor=.25,this.panDampingFactor=.5,this.rotate=(t=>{const e=5e3*this.camera.width,s=5e3*this.camera.height;this.sphericalDelta.polar+=t.y/s*Math.PI*this.rotateAngleFactor,this.sphericalDelta.azim+=t.x/e*Math.PI*this.rotateAngleFactor,this.needUpdate=!0}),this.zoom=(t=>{this.zoomingFactor=t,this.needUpdate=!0}),this.move=(t=>{t.rotate(-this.spherical.azim).multiplyScalar(this.spherical.radius*this.panFactor),this.panOffset.x+=t.x,this.panOffset.z+=t.y,this.needUpdate=!0}),this.needUpdate=!0,this.camera=t;const e=new kt;e.copy(t.transform.position).sub(this.spherical.center),this.spherical.setFromVector(e)}registerInteractor(t){void 0!==this.interactor&&this.interactor.unbindControllerAllListener(this),this.interactor=t,this.interactor.bindLeftMouseMove(this,this.rotate),this.interactor.bindRightMouseMove(this,this.move),this.interactor.bindMouseWheel(this,this.zoom)}update(){(Math.abs(this.sphericalDelta.azim)>1e-4||Math.abs(this.sphericalDelta.polar)>1e-4||Math.abs(this.sphericalDelta.radius)>1e-4||Math.abs(this.zoomingFactor-1)>1e-4||this.panOffset.mag()>.01)&&(this.needUpdate=!0),this.needUpdate&&(this.spherical.radius*=this.zoomingFactor,this.spherical.azim+=this.sphericalDelta.azim,this.spherical.polar=Ht.clamp(this.spherical.polar+this.sphericalDelta.polar,this.minPolarAngle,this.maxPolarAngle),this.spherical.center.add(this.panOffset),nn.setFromSpherical(this.spherical).add(this.spherical.center),this.camera.transform.position.copy(nn),this.camera.lookAt(this.spherical.center)),this.needUpdate=!1,!0===this.enableDamping?(this.sphericalDelta.azim*=1-this.dampingFactor,this.sphericalDelta.polar*=1-this.dampingFactor,this.zoomingFactor=this.zoomingFactor+(1-this.zoomingFactor)*this.dampingFactor,this.panOffset.multiplyScalar(1-this.panDampingFactor)):(this.sphericalDelta.set(0,0,0),this.zoomingFactor=1,this.panOffset.set(0,0,0))}}const on=new kt,hn=new kt,cn=new kt,ln=new kt,un=new kt,dn=new kt;function pn(t){const e=t.length,s=9,r=new Float32Array(e);for(let i=0;i<e;i+=s)on.set(t[i+0],t[i+1],t[i+2]),hn.set(t[i+3],t[i+4],t[i+5]),cn.set(t[i+6],t[i+7],t[i+8]),ln.copy(hn).sub(on),un.copy(cn).sub(on),dn.crossVectors(ln,un),dn.normalize(),r[i+0]=dn.x,r[i+1]=dn.y,r[i+2]=dn.z,r[i+3]=dn.x,r[i+4]=dn.y,r[i+5]=dn.z,r[i+6]=dn.x,r[i+7]=dn.y,r[i+8]=dn.z;return r}class fn{constructor(){this.name="unnamed loader"}}class mn extends fn{}class gn extends mn{constructor(){super(...arguments),this.vertexPattern=/v( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,this.normalPattern=/vn( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,this.uvPattern=/vt( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,this.facePattern1=/f\s+(([\d]{1,}[\s]?){3,})+/,this.facePattern2=/f\s+((([\d]{1,}\/[\d]{1,}[\s]?){3,})+)/,this.facePattern3=/f\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){3,})+)/,this.facePattern4=/f\s+((([\d]{1,}\/\/[\d]{1,}[\s]?){3,})+)/,this.positions=[],this.normals=[],this.uvs=[],this.indicesForArtgl=[],this.wrappedPositionForArtgl=[],this.wrappedUvsForArtgl=[],this.wrappedNormalsForArtgl=[],this.tuplePosNorm=[],this.curPositionInIndices=0,this.setDataForCurrentFaceWithPattern4=(t=>{const e=this.collectTriangle(t);for(var s=0;s<e.length;s++){var r=e[s].split("//"),i=parseInt(r[0])-1,n=parseInt(r[1])-1;this.setData(i,1,n,this.positions[i],new se(0,0),this.normals[n])}})}collectTriangle(t){const e=[];return this.getTriangles(t,1,e),e}getTriangles(t,e,s){e+1<t.length&&(s.push(t[0],t[e],t[e+1]),e+=1,this.getTriangles(t,e,s))}reset(){this.positions=[],this.normals=[],this.uvs=[],this.indicesForArtgl=[],this.wrappedPositionForArtgl=[],this.wrappedUvsForArtgl=[],this.wrappedNormalsForArtgl=[],this.tuplePosNorm=[],this.curPositionInIndices=0}isInArray(t,e){this.tuplePosNorm[t]||(this.tuplePosNorm[t]={normals:[],idx:[]});const s=this.tuplePosNorm[t].normals.indexOf(e);return-1===s?-1:this.tuplePosNorm[t].idx[s]}setData(t,e,s,r,i,n){const a=-1;-1===a?(this.indicesForArtgl.push(this.wrappedPositionForArtgl.length),this.wrappedPositionForArtgl.push(r),this.wrappedUvsForArtgl.push(i),this.wrappedNormalsForArtgl.push(n),this.curPositionInIndices++):this.indicesForArtgl.push(a)}setDataForCurrentFaceWithPattern1(t){const e=this.collectTriangle(t);for(var s=0;s<e.length;s++){var r=parseInt(e[s])-1;this.setData(r,0,0,this.positions[r],new se,new kt(0,1,0))}}setDataForCurrentFaceWithPattern2(t){const e=this.collectTriangle(t);for(var s=0;s<e.length;s++){var r=e[s].split("/"),i=parseInt(r[0])-1,n=parseInt(r[1])-1;this.setData(i,n,0,this.positions[i],this.uvs[n],new kt(0,1,0))}}setDataForCurrentFaceWithPattern3(t){const e=this.collectTriangle(t);for(var s=0;s<e.length;s++){var r=e[s].split("/"),i=parseInt(r[0])-1,n=parseInt(r[1])-1,a=parseInt(r[2])-1;this.setData(i,n,a,this.positions[i],this.uvs[n],this.normals[a])}}parse(t,e){this.reset();const s=t.split("\n");for(let l=0;l<s.length;l++){const t=s[l].trim();let e;0!==t.length&&"#"!==t.charAt(0)&&(null!==(e=this.vertexPattern.exec(t))?this.positions.push(new kt(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]))):null!==(e=this.normalPattern.exec(t))?this.normals.push(new kt(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]))):null!==(e=this.uvPattern.exec(t))?this.uvs.push(new se(parseFloat(e[1]),parseFloat(e[2]))):null!==(e=this.facePattern3.exec(t))?this.setDataForCurrentFaceWithPattern3(e[1].trim().split(" ")):null!==(e=this.facePattern4.exec(t))?this.setDataForCurrentFaceWithPattern4(e[1].trim().split(" ")):null!==(e=this.facePattern2.exec(t))?this.setDataForCurrentFaceWithPattern2(e[1].trim().split(" ")):null!==(e=this.facePattern1.exec(t))?this.setDataForCurrentFaceWithPattern1(e[1].trim().split(" ")):console.log("Unhandled expression at line : "+t))}const r=new Zs,i=[];this.wrappedPositionForArtgl.forEach(t=>{i.push(t.x),i.push(t.y),i.push(t.z)});const n=[];this.wrappedNormalsForArtgl.forEach(t=>{n.push(t.x),n.push(t.y),n.push(t.z)});const a=new Float32Array(i),o=new Float32Array(n);let h;this.indicesForArtgl.length>65535?(h=new Uint32Array(this.indicesForArtgl),r.indexBuffer=new qs(h,1)):(h=new Uint16Array(this.indicesForArtgl),r.indexBuffer=new qs(h,1)),r.bufferDatum.position=new qs(a,3);const c=!1;return r.bufferDatum.normal=new qs(c?pn(a):o,3),console.log("indexlength:"+h.length),console.log("positionBuffer:"+a.length),r.name=e?"Objfile-"+e:"Objfile-unnamed",r}}class vn extends Ps{constructor(){super(),void 0===this.uniforms&&(this.uniforms=new Map),void 0===this.propertyUniformNameMap&&(this.propertyUniformNameMap=new Map)}decorate(t){throw new Error("Method not implemented.")}getPropertyUniform(t){const e=this.propertyUniformNameMap.get(t),s=this[t];if(void 0===s)throw"uniform value not given";return ti(e,s)}}const wn=new Gr({source:"\n    vec4 pointLight(\n      vec3 fragPosition,\n      vec3 FragNormal,\n      vec3 lightPosition, \n      vec3 color,\n      float radius ){\n        float distance = length(fragPosition - lightPosition);\n        if( distance < radius){\n          return vec4(color * (1.0 - distance / radius), 0.0);\n        }\n        return vec4(0.0);\n    }\n  "}),xn=new Gr({source:"\n  vec4 add(\n    vec4 base,\n    vec4 light){\n      return base + light;\n  }\n  "});class bn extends vn{constructor(){super(...arguments),this.color=new kt(1,1,1),this.position=new kt(0,0,0),this.radius=3}decorate(t){t.setFragmentRoot(xn.make().input("base",t.getFragRoot()).input("light",wn.make().input("fragPosition",t.getVary(ci)).input("FragNormal",t.getVary(oi)).input("lightPosition",this.getPropertyUniform("position")).input("color",this.getPropertyUniform("color")).input("radius",this.getPropertyUniform("radius"))))}}er["b"]([di("lightColor")],bn.prototype,"color",void 0),er["b"]([di("lightPosition")],bn.prototype,"position",void 0),er["b"]([di("lightRadius")],bn.prototype,"radius",void 0);var yn=function(t){const e=new tn(1,40,40),s=new Qs(10,10,10,10),r=new en(5,3,4),i=new bn;let n=(new ui).decorate(new Ii).decorate(i);n.afterShaderCompiled.add(t=>{console.log(t)});const a=(new ks).g(s).s(n);t.addChild(a);const o=(new ks).g(r).s(n);o.transform.position.y=-2,t.addChild(o);for(let h=0;h<5;h++){const s=new Ps;s.transform.position.x=h,t.addChild(s);for(let t=0;t<5;t++){const r=new Ps;r.transform.position.y=t,s.addChild(r);for(let t=0;t<5;t++){const s=(new ks).g(e).s(n);s.transform.position.z=t,s.transform.scale.set(.3,.3,.3),r.addChild(s)}}}return t};function _n(t,e){return{name:"root",type:"folder",value:[{name:"canvas",value:[{name:"renderSize",value:[{name:"width",value:t.renderer.width,onChange:s=>{e.sampleCount=0,t.setActualSize(s,t.renderer.height)},editors:[{type:"slider",min:10,max:500,step:1}]},{name:"height",value:t.renderer.height,onChange:s=>{e.sampleCount=0,t.setActualSize(t.renderer.width,s)},editors:[{type:"slider",min:10,max:500,step:1}]}]}]},{name:"engine",value:[{name:"preferUseVAO",value:t.preferVAO,onChange:e=>{t.preferVAO=e}},{name:"enableUniformDiffUpload",value:t.renderer.enableUniformDiff,onChange:e=>{t.renderer.enableUniformDiff=e},description:"this is a demo description"},{name:"TAA",value:[{name:"enable",value:e.enableTAA,onChange:t=>{e.enableTAA=t,t||(e.sampleCount=0)}}]},{name:"TSSAO",value:[{name:"enable",value:e.enableTSSAO,onChange:t=>{e.enableTSSAO=t,e.composeShading.tssaoComposeRate=t?1:0}},{name:"composeRate",value:e.composeShading.tssaoComposeRate,onChange:t=>{e.composeShading.tssaoComposeRate=t},editors:[{type:"slider",min:0,max:4,step:.1}]},{name:"composeThreshold",value:e.composeShading.tssaoComposeThreshold,onChange:t=>{e.composeShading.tssaoComposeThreshold=t},editors:[{type:"slider",min:0,max:4,step:.1}]},{name:"radius",value:e.tssaoShading.aoRadius,onChange:t=>{e.tssaoShading.aoRadius=t,e.sampleCount=0},editors:[{type:"slider",min:.1,max:10,step:.1}]},{name:"sample_count_to_show",value:e.composeShading.tssaoShowThreshold,onChange:t=>{e.composeShading.tssaoShowThreshold=t},editors:[{type:"slider",min:1,max:1e3,step:20}]}]}]}]}}class Mn{constructor(){this.graph=new Ni,this.composer=new Fi,this.enableTAA=!0,this.taaShading=new Ji,this.taaShader=(new ui).decorate(this.taaShading),this.enableTSSAO=!0,this.tssaoShading=new Yi,this.tssaoShader=(new ui).decorate(this.tssaoShading),this.composeShading=new Wi,this.composeShader=(new ui).decorate(this.composeShading),this.depthShader=(new ui).decorate(new Qi),this.sampleCount=0,this.tickNum=0}get isEvenTick(){return this.tickNum%2===0}render(t,e){this.tickNum++,t.connectCamera(),t.isCameraChanged||e.isFrameChange?this.sampleCount=0:this.enableTAA&&t.jitterProjectionMatrix(),this.graph.update(t,this.composer),this.composer.render(t,this.graph)}build(t,e){this.config=_n(t,this),this.graph.defineGraph(this.composer,{renderTargets:[{name:Ni.screenRoot,from:()=>"CopyToScreen"},{name:"sceneResult",from:()=>"SceneOrigin"},{name:"depthResult",from:()=>"Depth"},{name:"TAAHistoryA",from:()=>this.isEvenTick?null:"TAA"},{name:"TAAHistoryB",from:()=>this.isEvenTick?"TAA":null},{name:"TSSAOHistoryA",from:()=>this.isEvenTick?null:"TSSAO"},{name:"TSSAOHistoryB",from:()=>this.isEvenTick?"TSSAO":null}],passes:[{name:"SceneOrigin",source:[e]},{name:"Depth",shading:this.depthShader,source:[e]},{name:"TAA",inputs:()=>{return{sceneResult:"sceneResult",depthResult:"depthResult",TAAHistoryOld:this.isEvenTick?"TAAHistoryA":"TAAHistoryB"}},shading:this.taaShader,source:[Ni.quadSource],enableColorClear:!1,beforePassExecute:()=>{t.unJit();const e=t.getGlobalUniform(De.VPMatrix).value;this.taaShading.VPMatrixInverse=this.taaShading.VPMatrixInverse.getInverse(e,!0),this.taaShading.sampleCount=this.sampleCount}},{name:"TSSAO",inputs:()=>{return{depthResult:"depthResult",AOAcc:this.isEvenTick?"TSSAOHistoryA":"TSSAOHistoryB"}},shading:this.tssaoShader,source:[Ni.quadSource],enableColorClear:!1,beforePassExecute:()=>{const e=t.getGlobalUniform(De.VPMatrix).value;this.tssaoShading.VPMatrixInverse=this.tssaoShading.VPMatrixInverse.getInverse(e,!0),this.tssaoShading.sampleCount=this.sampleCount}},{name:"CopyToScreen",enableColorClear:!1,inputs:()=>{let t,e;return t=this.enableTAA?this.isEvenTick?"TAAHistoryB":"TAAHistoryA":"sceneResult",e=this.enableTSSAO?this.isEvenTick?"TSSAOHistoryB":"TSSAOHistoryA":"sceneResult",{basic:t,tssao:e}},beforePassExecute:()=>{this.composeShading.sampleCount=this.sampleCount},afterPassExecute:()=>{this.sampleCount++},shading:this.composeShader,source:[Ni.quadSource]}]})}}const Sn="http://localhost:3000/";class Cn{constructor(){this.framer=new Si,this.hasInitialized=!1,this.scene=new zi,this.onContainerResize=(()=>{const t=this.el.offsetWidth,e=this.el.offsetHeight;this.engine.setSize(t,e),this.engine.camera.aspect=t/e}),this.sampleCount=0,this.beforeRender=new Ls,this.afterRender=new Ls,this.render=(()=>{this.beforeRender.notifyObservers(this.engine),this.orbitController.update(),this.pipeline.render(this.engine,this.scene),this.afterRender.notifyObservers(this.engine),this.engine.renderer.stat.reset()})}initialize(t){this.el=t,this.engine=new _i(t),this.pipeline=new Mn,this.pipeline.build(this.engine,this.scene),this.engine.camera.transform.position.set(20,10,10),this.orbitController=new an(this.engine.camera),this.orbitController.registerInteractor(this.engine.interactor),this.hasInitialized=!0,this.createScene(this.scene),window.addEventListener("resize",this.onContainerResize),this.onContainerResize(),this.framer.setFrame(this.render)}unintialize(){window.removeEventListener("resize",this.onContainerResize),this.engine=null,this.pipeline=null,this.framer.stop(),this.framer.setFrame(null),this.el=null}notifyResize(){this.onContainerResize()}pickColor(t,e){const s=this.engine.renderer.framebufferManager.getFramebuffer("sceneResult"),r=new Uint8Array(10);s.readPixels(t*this.engine.renderer.width,e*this.engine.renderer.height,1,1,r),console.log(`${r[0]}`)}run(){this.engine.interactor.enabled=!0,this.framer.run()}stop(){this.engine.interactor.enabled=!1,this.framer.stop()}step(){this.framer.step()}createScene(t){return yn(t.root),t}loadOBJFromURL(){return a["a"](this,void 0,void 0,function*(){const t=new gn,e=yield fetch(Sn+"obj/chair.obj"),s=yield e.text(),r=t.parse(s),i=new ks;i.geometry=r,this.scene.root.addChild(i)})}}let En=new Cn,Tn=class extends o["e"]{hide(){return a["a"](this,void 0,void 0,function*(){this.$store.state.showConfigPanel=!1,yield this.$nextTick(),En.notifyResize()})}};a["b"]([Object(o["c"])()],Tn.prototype,"appConfig",void 0),Tn=a["b"]([Object(o["a"])({components:{Config:Tt}})],Tn);var An=Tn,Rn=An,Pn=(s("9479"),Object(p["a"])(Rn,R,P,!1,null,"134ba5ce",null));Pn.options.__file="config-panel.vue";var zn=Pn.exports,On=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"scene-panel"},[t._e(),s("div",{staticClass:"panel-title"},[t._v("Scene explorer\n    "),s("button",{on:{click:t.sync}},[t._v("sync")]),s("button",{on:{click:t.hide}},[t._v("hide")])]),s("nav",{staticClass:"scene-nav"},t._l(t.nav,function(e){return s("div",{key:e,class:{"current-nav":e===t.currentNav},on:{click:function(s){t.currentNav=e}}},[t._v(t._s(e))])}),0),t.sceneView?s("div",{staticClass:"view-wrap"},["hierarchy"===t.currentNav?s("NodeView",{attrs:{view:t.sceneView.root},on:{nodeChange:t.catchChange}}):t._e(),"geometry"===t.currentNav?s("GeometryViewPanel",{attrs:{view:t.sceneView}}):t._e(),"material"===t.currentNav?s("MaterialViewPanel",{attrs:{view:t.sceneView}}):t._e()],1):t._e(),s("div",{staticClass:"render-info"},[s("div",{staticClass:"panel-title"},[t._v("RenderInfo")]),t.renderView?s("div",{staticClass:"render-info-group"},[s("div",[t._v("\n        activeProgramCount: "+t._s(t.renderView.compiledPrograms)+"\n      ")]),s("div",[t._v("\n        programswitch: "+t._s(t.renderView.programSwitchCount)+"\n      ")]),s("div",[t._v("\n        drawcall: "+t._s(t.renderView.drawcall)+"\n      ")]),s("div",[t._v("\n        uniformUpload: "+t._s(t.renderView.uniformUpload)+"\n      ")])]):s("div",{staticClass:"render-info-group"},[t._v("\n      sync scene to get synced render info stat\n    ")])])],1)},Fn=[];const Nn=new gn;class Dn{static create(t){const e=new Dn;e.uuid=t.uuid,e.name=void 0===t.name?"unnamed":t.name,e.buffers=[];for(const s in t.bufferDatum)if(t.bufferDatum.hasOwnProperty(s)){const r=t.bufferDatum[s];e.buffers.push({name:s,type:"bufferdata",dataByteSize:r.getDataSizeByte()})}return t.indexBuffer&&e.buffers.push({name:"index",type:"indexbuffer",dataByteSize:t.indexBuffer.getDataSizeByte()}),e}}class Ln{static create(t){const e=new Ln;return e.uuid=t.uuid,e}}class Vn{constructor(){this.geometries=new Map,this.materials=new Map}collectEntity(t){if(t instanceof ks){const e=t.geometry,s=t.material;void 0!==e&&(this.geometries.has(e.uuid)||this.geometries.set(e.uuid,Dn.create(e))),void 0!==s&&(this.geometries.has(s.uuid)||this.materials.set(s.uuid,Ln.create(s)))}}static create(t){const e=new Vn;return e.root=t.root.map(t=>{return e.collectEntity(t),In.create(t)}),e}static deleteNode(t,e){const s=e.root.findSubNode(t);void 0!==s&&(s.parent?s.parent.removeChild(s):e.setRootNode(new Ps))}static loadObj(t,e){return a["a"](this,void 0,void 0,function*(){const s=e.root.findSubNode(t);if(void 0===s)return;const r=yield nr();if(!r&&0===r.length)return;const i=Nn.parse(r),n=new ks;n.geometry=i,n.shading=(new ui).decorate(new Ii),s.addChild(n)})}}class In{constructor(){this.position=new kt,this.type="node",this.children=[]}static create(t){const e=new In;return e.position.copy(t.transform.position),e.uuid=t.uuid,t instanceof ks&&(e.type="mesh"),e}}class Un{static create(t){const e=t.renderer,s=new Un;return s.compiledPrograms=e.programManager.compiledProgramsCount,s.updateFrameInfo(t),s}updateFrameInfo(t){this.programSwitchCount=t.renderer.stat.programSwitch,this.uniformUpload=t.renderer.stat.uniformUpload,this.drawcall=t.renderer.stat.drawcall}}var kn=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"geometry-view"},t._l(t.geometrylist,function(e){return s("div",{key:e.uuid},[s("span",[t._v("\n    "+t._s(e.name)+"-"+t._s(e.uuid.slice(0,6))+"\n  ")]),t.expandDetail?s("div",{staticClass:"buffer-detail"},t._l(e.buffers,function(e){return s("div",{key:e.name},[t._v("\n      "+t._s(e.name)+" - "+t._s(Math.ceil(e.dataByteSize/1024*10)/10)+"KB\n      ")])}),0):t._e()])}),0)},Bn=[];let Gn=class extends o["e"]{constructor(){super(...arguments),this.expandDetail=!0}get geometrylist(){const t=[];return this.view.geometries.forEach(e=>{t.push(e)}),t}};a["b"]([Object(o["c"])()],Gn.prototype,"view",void 0),Gn=a["b"]([Object(o["a"])({components:{}})],Gn);var jn=Gn,$n=jn,Xn=(s("277c"),Object(p["a"])($n,kn,Bn,!1,null,"16a04246",null));Xn.options.__file="geometry-view.vue";var qn=Xn.exports,Yn=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"material-view"},[0===t.materiallist.length?s("div",[t._v("\n    no material found\n  ")]):t._e(),t._l(t.materiallist,function(e){return s("div",{key:e.uuid},[s("span",[t._v("\n      "+t._s(e.name)+"-"+t._s(e.uuid.slice(0,6))+"\n    ")]),t.expandDetail?s("div",{staticClass:"channel-detail"}):t._e()])})],2)},Hn=[],Wn=function(){var t=this,e=t.$createElement;t._self._c;return t._m(0)},Zn=[function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",[s("button",[t._v("upload")])])}];class Qn extends o["e"]{}var Kn=Qn,Jn=Object(p["a"])(Kn,Wn,Zn,!1,null,null,null);Jn.options.__file="channel-editor.vue";var ta=Jn.exports;let ea=class extends o["e"]{constructor(){super(...arguments),this.expandDetail=!0}get materiallist(){const t=[];return this.view.materials.forEach(e=>{t.push(e)}),t}};a["b"]([Object(o["c"])()],ea.prototype,"view",void 0),ea=a["b"]([Object(o["a"])({components:{ChannelEditor:ta}})],ea);var sa=ea,ra=sa,ia=Object(p["a"])(ra,Yn,Hn,!1,null,"0becaf20",null);ia.options.__file="material-view.vue";var na=ia.exports,aa=function(){var t=this,e=t.$createElement;t._self._c;return t._m(0)},oa=[function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"object-panel"},[s("button",[t._v("X")])])}];let ha=class extends o["e"]{};ha=a["b"]([Object(o["a"])({components:{}})],ha);var ca=ha,la=ca,ua=(s("7feb"),Object(p["a"])(la,aa,oa,!1,null,"4a932871",null));ua.options.__file="object-panel.vue";var da=ua.exports,pa=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"node-view"},[s("div",{staticClass:"title"},[s("div",{class:{expandable:t.hasChildren},on:{click:function(e){t.isExpand=!t.isExpand}}},[t.hasChildren&&!t.isExpand?s("span",[t._v(" + ")]):t._e(),t.hasChildren&&t.isExpand?s("span",[t._v(" = ")]):t._e(),t._v("\n\n      "+t._s(t.view.type)+" - "+t._s(t.clampId)+"\n    ")]),s("button",{on:{click:function(e){t.showMenu=!0}}},[t._v("*")])]),t.showMenu?s("div",{staticClass:"menu"},[s("button",{on:{click:t.emitDelete}},[t._v("delete")]),s("button",{on:{click:t.emitLoadObj}},[t._v("loadobj")])]):t._e(),t.showMenu?s("div",{staticClass:"mask",on:{click:function(e){t.showMenu=!1}}}):t._e(),t.isExpand?s("div",{staticClass:"children"},t._l(t.view.children,function(e){return s("scene-node-view",{key:e.uuid,attrs:{view:e},on:{nodeChange:t.emitChange}})}),1):t._e()])},fa=[];let ma=class extends o["e"]{constructor(){super(...arguments),this.showMenu=!1,this.isExpand=!0}get clampId(){return this.view.uuid.slice(0,6)}get hasChildren(){return this.view.children.length}emitLoadObj(){this.emitChange({type:"load",id:this.view.uuid})}emitDelete(){this.emitChange({type:"delete",id:this.view.uuid})}emitChange(t){this.$emit("nodeChange",t),this.showMenu=!1}};a["b"]([Object(o["c"])()],ma.prototype,"view",void 0),ma=a["b"]([Object(o["a"])({name:"scene-node-view"})],ma);var ga=ma,va=ga,wa=(s("3aba"),Object(p["a"])(va,pa,fa,!1,null,"95da2114",null));wa.options.__file="scene-node-view.vue";var xa=wa.exports;let ba=class extends o["e"]{constructor(){super(...arguments),this.sceneView=null,this.renderView=null,this.nav=["hierarchy","technique","geometry","material"],this.currentNav="hierarchy"}sync(){this.sceneView=Vn.create(En.scene),this.renderView=Un.create(En.engine),this.afterObs&&En.afterRender.remove(this.afterObs),this.afterObs=En.afterRender.add(t=>{this.renderView.updateFrameInfo(t)})}hide(){return a["a"](this,void 0,void 0,function*(){this.$store.state.showScenePanel=!1,yield this.$nextTick(),En.notifyResize()})}beforeDestroy(){this.afterObs&&En.afterRender.remove(this.afterObs)}catchChange(t){return a["a"](this,void 0,void 0,function*(){"delete"===t.type?Vn.deleteNode(t.id,En.scene):"load"===t.type?yield Vn.loadObj(t.id,En.scene):(console.log("unkown change"),console.log(t)),this.sync()})}};ba=a["b"]([Object(o["a"])({components:{NodeView:xa,ObjectPanel:da,GeometryViewPanel:qn,MaterialViewPanel:na}})],ba);var ya=ba,_a=ya,Ma=(s("82bf"),Object(p["a"])(_a,On,Fn,!1,null,"cd90fe88",null));Ma.options.__file="scene-panel.vue";var Sa=Ma.exports,Ca=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"canvas-wrap"},[s("canvas",{attrs:{id:"viewer-canvas"},on:{click:t.pick}}),t.isRunning?t._e():s("div",{staticClass:"stop-notation"},[t._v("STOPPED")]),t.showGraphViewer?s("div",{staticClass:"graph-viewer-wrap"},[s("div",{staticStyle:{position:"absolute",bottom:"0px","pointer-events":"auto"}},[s("button",{on:{click:t.layout}},[t._v("layout")])]),s("GraphView",{attrs:{board:t.board},on:{updateAllViewport:t.updateAllViewport}},t._l(t.nodes,function(e){return s("DAGNodeView",{key:e.node.uuid,ref:"vueNodes",refInFor:!0,attrs:{node:e.node,layout:e.layout,boardInfo:t.board},on:{updateViewport:t.updateViewport,updateLine:t.updateLine}},[t.isRenderTargetNode(e.node)?s("RenderTargetNodeView",{attrs:{node:e.node,layout:e.layout},on:{updateSize:t.updateViewport}}):t._e()],1)}),1),s("LineHUDCanvas",{attrs:{lines:t.lines,boardInfo:t.board}})],1):t._e(),s("div",{staticClass:"command-bar"},[t.isRunning?t._e():s("button",{on:{click:t.run}},[t._v("run")]),t.isRunning?s("button",{on:{click:t.stop}},[t._v("stop")]):t._e(),t.isRunning?t._e():s("button",{on:{click:t.step}},[t._v("step next frame")]),t.isRunning?t._e():s("button",{attrs:{disabled:""},on:{click:t.screenshot}},[t._v("download screenshot")]),t.showGraphViewer?t._e():s("button",{on:{click:t.inspectGraph}},[t._v("inspectGraph")]),t.showGraphViewer?s("button",{on:{click:t.closeGraphInspector}},[t._v("closeGraphViewer")]):t._e(),s("button",{on:{click:t.showScenePanel}},[t._v("show scene panel")]),s("button",{on:{click:t.showConfigPanel}},[t._v("show config panel")])])])},Ea=[],Ta=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"graph-viewer",attrs:{tabindex:"-1"}},[s("div",{style:{transform:t.transform}},[t._t("default")],2),t.showMove?s("div",{staticClass:"mask",on:{mousedown:t.startDrag}}):t._e(),s("div",{staticClass:"ops"},[t.showMove?t._e():s("button",{on:{click:function(e){t.showMove=!0}}},[t._v("move")]),t.showMove?s("button",{on:{click:function(e){t.showMove=!1}}},[t._v("unmove")]):t._e()])])},Aa=[];let Ra=class extends o["e"]{constructor(){super(...arguments),this.showMove=!1,this.isDragging=!1}get transform(){return`translate(${this.board.transformX}px, ${this.board.transformY}px)`}startDrag(t){this.isDragging=!0,this.screenOriginX=t.screenX,this.screenOriginY=t.screenY,this.originTransformX=this.board.transformX,this.originTransformY=this.board.transformY,window.addEventListener("mousemove",this.dragging),window.addEventListener("mouseup",t=>{this.isDragging=!1,window.removeEventListener("mousemove",this.dragging)})}dragging(t){this.board.transformX=this.originTransformX+t.screenX-this.screenOriginX,this.board.transformY=this.originTransformY+t.screenY-this.screenOriginY,this.$emit("updateAllViewport")}mounted(){this.updateBoard(),window.addEventListener("resize",this.updateBoard)}beforeDestroy(){window.removeEventListener("resize",this.updateBoard)}updateBoard(){this.board.width=this.$el.clientWidth,this.board.height=this.$el.clientHeight,this.$emit("updateAllViewport")}};a["b"]([Object(o["c"])({required:!0})],Ra.prototype,"board",void 0),Ra=a["b"]([Object(o["a"])({components:{}})],Ra);var Pa=Ra,za=Pa,Oa=(s("81f7"),Object(p["a"])(za,Ta,Aa,!1,null,"4b63007a",null));Oa.options.__file="graph-viewer.vue";var Fa=Oa.exports,Na=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"dag-node",style:{left:t.viewPositionX,top:t.viewPositionY,width:t.viewWidth}},[s("div",{staticClass:"node-title",style:{cursor:this.isDragging?"grabbing":""},on:{mousedown:t.startDrag}},[s("span",[t._v(t._s(t.node.constructor.name)+": "+t._s(t.node.uuid.slice(0,4)))])]),t._t("default")],2)},Da=[];function La(t){return{x:t.absX+t.width,y:t.absY+10}}function Va(t,e,s=300){const r=[];function i(t){r.forEach(e=>{const s=e.indexOf(t);-1!==s&&e.splice(s,1)})}function n(t,e){let s=r[e];void 0===s&&(r[e]=[],s=r[e]),i(t),s.push(t),t.fromNodes.forEach(t=>{n(t,e+1)})}n(t,0),r.reverse().forEach((t,r)=>{t.forEach((t,i)=>{const n=e[t.uuid];if(void 0===n)throw"cant find nodes layout";n.absX=r*s,n.absY=i*s})})}class Ia{constructor(){this.startX=0,this.startY=0,this.endX=0,this.endY=0}draw(t,e){const s=t.ctx;s.beginPath(),s.moveTo(this.startX+e.transformX,this.startY+e.transformY),s.lineTo(this.endX+e.transformX,this.endY+e.transformY),s.stroke()}}class Ua{constructor(t){this.width=0,this.height=0,this.el=t,this.ctx=t.getContext("2d")}clear(){this.ctx.clearRect(0,0,this.width,this.height)}draw(t,e){this.clear(),t.forEach(t=>t.draw(this,e))}}let ka=class extends o["e"]{constructor(){super(...arguments),this.selfLines=[],this.isDragging=!1,this.originX=0,this.originY=0,this.screenOriginX=0,this.screenOriginY=0}getNodesLayout(t){return ar(this.nodes,e=>{return e.node===t}).layout}getLines(){return this.inputs.map(t=>{const e=La(this.getNodesLayout(t)),s=new Ia;return s.startX=e.x,s.startY=e.y,s.endX=this.layout.absX,s.endY=this.layout.absY,s})}updateLine(){this.selfLines.forEach(t=>{const e=this.lines.indexOf(t);-1!==e&&this.lines.splice(e,1)}),this.selfLines=this.getLines(),this.selfLines.forEach(t=>{this.lines.push(t)})}mounted(){this.updateLine()}get inputs(){const t=[];return this.node.fromNodes.forEach(e=>{t.push(e)}),t}get viewPositionX(){return this.layout.absX+"px"}get viewPositionY(){return this.layout.absY+"px"}get viewWidth(){return this.layout.width+"px"}get viewHeight(){return this.layout.height+"px"}startDrag(t){this.isDragging=!0,this.originX=this.layout.absX,this.originY=this.layout.absY,this.screenOriginX=t.screenX,this.screenOriginY=t.screenY,window.addEventListener("mousemove",this.dragging),window.addEventListener("mouseup",t=>{this.isDragging=!1,window.removeEventListener("mousemove",this.dragging)})}dragging(t){this.layout.absX=this.originX+t.screenX-this.screenOriginX,this.layout.absY=this.originY+t.screenY-this.screenOriginY,this.$emit("updateViewport",{node:this.node,layout:this.layout}),this.$emit("updateLine",this.node)}};a["b"]([Object(o["b"])()],ka.prototype,"nodes",void 0),a["b"]([Object(o["b"])()],ka.prototype,"lines",void 0),a["b"]([Object(o["c"])({required:!0})],ka.prototype,"node",void 0),a["b"]([Object(o["c"])({required:!0})],ka.prototype,"layout",void 0),a["b"]([Object(o["c"])({required:!0})],ka.prototype,"boardInfo",void 0),a["b"]([Object(o["c"])({required:!1,default:!0})],ka.prototype,"editable",void 0),ka=a["b"]([Object(o["a"])({components:{}})],ka);var Ba=ka,Ga=Ba,ja=(s("36e4"),Object(p["a"])(Ga,Na,Da,!1,null,"186cb780",null));ja.options.__file="dag-node.vue";var $a=ja.exports,Xa=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("canvas",{staticClass:"lines-hud"})},qa=[];let Ya=class extends o["e"]{constructor(){super(...arguments),this.isRunning=!0}mounted(){this.HUD=new Ua(this.$el),window.addEventListener("resize",this.updateSize),window.requestAnimationFrame(this.draw),this.updateSize()}beforeDestroy(){this.isRunning=!1}updateSize(){const t=this.$el;this.HUD.width=t.clientWidth,this.HUD.height=t.clientHeight,t.width=t.clientWidth,t.height=t.clientHeight}draw(){this.HUD.draw(this.lines,this.boardInfo),this.isRunning&&window.requestAnimationFrame(this.draw)}};a["b"]([Object(o["c"])({required:!0})],Ya.prototype,"lines",void 0),a["b"]([Object(o["c"])({required:!0})],Ya.prototype,"boardInfo",void 0),Ya=a["b"]([Object(o["a"])({components:{}})],Ya);var Ha=Ya,Wa=Ha,Za=(s("df0b"),Object(p["a"])(Wa,Xa,qa,!1,null,"3fa939d0",null));Za.options.__file="line-hud-canvas.vue";var Qa=Za.exports,Ka=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",[t._v("\n  "+t._s(t.node.name)+"\n  "),s("button",{on:{click:t.actualSize}},[t._v("actual size")]),s("button",{on:{click:t.defaultSize}},[t._v("default size")])])},Ja=[];let to=class extends o["e"]{actualSize(){this.layout.width=this.node.widthAbs/2/window.devicePixelRatio,this.layout.height=this.node.heightAbs/2/window.devicePixelRatio,this.$emit("updateSize",{node:this.node,layout:this.layout})}defaultSize(){this.layout.width=200,this.layout.height=200,this.$emit("updateSize",{node:this.node,layout:this.layout})}};a["b"]([Object(o["c"])({required:!0})],to.prototype,"node",void 0),a["b"]([Object(o["c"])({required:!0})],to.prototype,"layout",void 0),to=a["b"]([Object(o["a"])({components:{}})],to);var eo=to,so=eo,ro=Object(p["a"])(so,Ka,Ja,!1,null,"3e54fb51",null);ro.options.__file="render-target-node.vue";var io=ro.exports;let no=class extends o["e"]{constructor(){super(...arguments),this.isRunning=En.framer.active,this.showGraphViewer=!1,this.board={width:0,height:0,transformX:0,transformY:0},this.nodes=[],this.lines=[]}showScenePanel(){return a["a"](this,void 0,void 0,function*(){this.$store.state.showScenePanel=!0,yield this.$nextTick(),En.notifyResize()})}showConfigPanel(){return a["a"](this,void 0,void 0,function*(){this.$store.state.showConfigPanel=!0,yield this.$nextTick(),En.notifyResize()})}pick(t){const e=this.$el.querySelector("canvas");En.pickColor(t.offsetX/e.clientWidth,(e.clientHeight-t.offsetY)/e.clientHeight)}updateViewport({node:t,layout:e}){if(t instanceof Di){const s=new Bt,r=e,i=t;s.set(r.absX+this.board.transformX,this.board.height-r.absY-r.height-this.board.transformY,r.width,r.height),s.multiplyScalar(window.devicePixelRatio),i.debugViewPort.copy(s)}}updateLine(t){this.notifyNodeNeedUpdateLine(t),t.toNodes.forEach(t=>{this.notifyNodeNeedUpdateLine(t)})}notifyNodeNeedUpdateLine(t){if(this.$refs.vueNodes)for(let e=0;e<this.$refs.vueNodes.length;e++){const s=this.$refs.vueNodes[e];s.node===t&&s.updateLine()}}updateAllViewport(){this.nodes.forEach(t=>{this.updateViewport(t)})}layout(){const t={};this.nodes.forEach(e=>{t[e.node.uuid]=e.layout}),Va(En.pipeline.graph.screenNode,t),this.updateAllViewport(),this.nodes.forEach(t=>this.updateLine(t.node))}isRenderTargetNode(t){return t instanceof Di}inspectGraph(){En.pipeline.graph.enableDebuggingView=!0;const t=En.pipeline.graph.nodes;this.nodes=t.map(t=>{return{node:t,layout:{absX:0,absY:0,width:200,height:200}}}),this.showGraphViewer=!0,this.layout()}closeGraphInspector(){En.pipeline.graph.enableDebuggingView=!1,this.showGraphViewer=!1}run(){En.run(),this.isRunning=!0}stop(){En.stop(),this.isRunning=!1}step(){En.step()}screenshot(){En.engine.downloadCurrentRender()}};a["b"]([Object(o["d"])()],no.prototype,"nodes",void 0),a["b"]([Object(o["d"])()],no.prototype,"lines",void 0),no=a["b"]([Object(o["a"])({components:{GraphView:Fa,DAGNodeView:$a,RenderTargetNodeView:io,LineHUDCanvas:Qa}})],no);var ao=no,oo=ao,ho=(s("94f3"),Object(p["a"])(oo,Ca,Ea,!1,null,"5da8d6ca",null));ho.options.__file="viewer-canvas.vue";var co=ho.exports;let lo=class extends o["e"]{constructor(){super(...arguments),this.appConf={name:"root",type:"folder",value:[]}}mounted(){const t=this.$el.querySelector("#viewer-canvas");En.initialize(t),this.appConf=En.pipeline.config}beforeDestroy(){En.unintialize()}};lo=a["b"]([Object(o["a"])({components:{ConfigPanel:zn,ScenePanel:Sa,ViewerCanvas:co,ObjectPanel:da}})],lo);var uo=lo,po=uo,fo=(s("a638"),Object(p["a"])(po,T,A,!1,null,"36c0e409",null));fo.options.__file="viewer.vue";var mo=fo.exports,go=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"shader-graph"},[s("div",{staticClass:"editor"},[s("button",{on:{click:t.layout}},[t._v("relayout")]),s("div",[s("button",{on:{click:t.addUniform}},[t._v("uniform")]),s("button",[t._v("attribute")])]),s("GraphView",{attrs:{board:t.board}},t._l(t.nodes,function(e){return s("DAGNodeView",{key:e.node.uuid,attrs:{node:e.node,layout:e.layout,boardInfo:t.board},on:{updateViewport:function(s){return t.updateViewport(e)}}})}),1)],1),s("div",{staticClass:"viewer"},[s("h1",[t._v("viewer")]),t.showCode?s("button",{on:{click:function(e){t.showCode=!1}}},[t._v("canvas")]):s("button",{on:{click:t.codeGen}},[t._v("view generated code")]),s("button",{on:{click:t.updateTechnique}},[t._v("updateTechnique")]),s("div",{directives:[{name:"show",rawName:"v-show",value:t.showCode,expression:"showCode"}],staticClass:"code-result"},[s("pre",[t._v(t._s(t.codeGenResult))])]),s("div",{directives:[{name:"show",rawName:"v-show",value:!t.showCode,expression:"!showCode"}],staticClass:"canvas-wrap",on:{mouseenter:t.start,mouseleave:t.end}},[s("canvas",{attrs:{id:"shader-editor-canvas"}})])])])},vo=[];class wo{constructor(){this.graph=new li,this.scene=new zi,this.canvasRun=!1,this.tick=(()=>{this.canvasRun&&this.render(),window.requestAnimationFrame(this.tick)}),this.onContainerResize=(()=>{const t=this.canvas.offsetWidth,e=this.canvas.offsetHeight;this.engine.setSize(t,e),this.engine.camera.aspect=t/e})}init(t){this.canvas=t,this.engine=new _i(t),this.engine.camera.transform.position.set(20,10,10),this.orbitController=new an(this.engine.camera),this.orbitController.registerInteractor(this.engine.interactor),this.shader=(new ui).decorate(new Ii),this.loadScene(),this.tick(),this.start(),window.addEventListener("resize",this.onContainerResize),this.onContainerResize()}updateShader(){}loadScene(){let t=new tn(1,40,40);const e=new ks;e.geometry=t,e.shading=this.shader,this.mesh=e,this.scene.root.addChild(e)}start(){this.canvasRun=!0}render(){this.orbitController.update(),this.engine.connectCamera(),this.engine.render(this.scene)}uninit(){this.canvas=null,this.engine=null}}let xo=new wo,bo=class extends o["e"]{constructor(){super(...arguments),this.showCode=!1,this.graph=null,this.codeGenResult="",this.board={width:0,height:0,transformX:0,transformY:0},this.nodes=[]}mounted(){const t=this.$el.querySelector("#shader-editor-canvas");xo.init(t),this.graph=xo.shader.graph,this.board.width=t.clientWidth,this.board.height=t.clientHeight,console.log(this.graph)}layout(){}updateViewport(t){console.log("upd")}codeGen(){this.showCode=!0}addUniform(){this.nodes.push({node:Jr("unnamed",ne.float),layout:{absX:0,absY:0,width:100,height:100}})}updateTechnique(){xo.updateShader()}start(){xo.start()}end(){xo.canvasRun=!1}};bo=a["b"]([Object(o["a"])({components:{DAGNodeView:$a,GraphView:Fa}})],bo);var yo=bo,_o=yo,Mo=(s("2a56"),Object(p["a"])(_o,go,vo,!1,null,"31be39e7",null));Mo.options.__file="shader-editor.vue";var So=Mo.exports,Co=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div")},Eo=[];let To=class extends o["e"]{mounted(){console.log("debug");new Qi}};To=a["b"]([Object(o["a"])({})],To);var Ao=To,Ro=Ao,Po=Object(p["a"])(Ro,Co,Eo,!1,null,null,null);Po.options.__file="debug.vue";var zo=Po.exports,Oo=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",[s("h1",[t._v("Examples")]),t._l(t.examples,function(e){return s("div",{key:e.name,staticClass:"example-entry",on:{click:function(s){return t.gotoExample(e.name)}}},[t._v(t._s(e.name))])})],2)},Fo=[];let No=class extends o["e"]{get examples(){return this.$store.state.examples}mounted(){}gotoExample(t){console.log("goto"),this.$store.state.viewExample=t,this.$router.push({name:"example",params:{name:t}})}};No=a["b"]([Object(o["a"])({components:{}})],No);var Do=No,Lo=Do,Vo=(s("092b"),Object(p["a"])(Lo,Oo,Fo,!1,null,"063d4f2b",null));Vo.options.__file="example-page.vue";var Io=Vo.exports,Uo=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",[s("h1",[t._v(t._s(t.example.name))]),s("div"),t._m(0),t.exampleHasBuild?s("div",[t.isRunning?t._e():s("button",{on:{click:t.start}},[t._v("start")]),t.isRunning?t._e():s("button",{on:{click:t.step}},[t._v("step")]),t.isRunning?s("button",{on:{click:t.stop}},[t._v("stop")]):t._e()]):s("div",[t._v("\n    example is in building\n  ")])])},ko=[function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",[s("canvas")])}];class Bo{constructor(){this.framer=new Si}screenShotCompareElement(t,e){return er["a"](this,void 0,void 0,function*(){})}}class Go{constructor(){this.framer=new Si}screenShotCompareElement(t,e){return er["a"](this,void 0,void 0,function*(){yield window.screenShotCompareElement(t,e)})}}window.HeadlessTestBridge=Go;const jo=new Bo;let $o=class extends o["e"]{constructor(){super(...arguments),this.exampleHasBuild=!1,this.isRunning=!1}get example(){this.$store.state.viewExample=this.$route.params.name;for(let t=0;t<this.$store.state.examples.length;t++){const e=this.$store.state.examples[t];if(e.name===this.$store.state.viewExample)return e}throw"cant find example"}start(){jo.framer.run(),this.isRunning=!0}stop(){jo.framer.stop(),this.isRunning=!1}step(){jo.framer.step()}mounted(){return a["a"](this,void 0,void 0,function*(){console.log(this.example),yield this.example.build(jo),this.exampleHasBuild=!0})}};$o=a["b"]([Object(o["a"])({components:{}})],$o);var Xo=$o,qo=Xo,Yo=(s("d14e"),Object(p["a"])(qo,Uo,ko,!1,null,"7335b2bb",null));Yo.options.__file="example-item-page.vue";var Ho=Yo.exports;r["a"].use(y["a"]);var Wo=new y["a"]({routes:[{path:"/",name:"home",component:E},{path:"/debug",name:"debug",component:zo},{path:"/viewer",name:"viewer",component:mo},{path:"/shader",name:"shader-editor",component:So},{path:"/examples",name:"examples",component:Io},{path:"/example/:name",name:"example",component:Ho},{path:"/about",name:"about",component:()=>s.e("about").then(s.bind(null,"f820"))}]}),Zo=s("2f62"),Qo=function(){return er["a"](this,void 0,void 0,function*(){let t=document.querySelector("canvas");const e=new _i(t),s=new zi;let r=new ks;s.root.addChild(r),e.render(s)})};function Ko(t){return er["a"](this,void 0,void 0,function*(){let e=document.querySelector("canvas");const s=new _i(e),r=new zi,i=new tn,n=new ks,a=new Ci,o=new Ei;n.geometry=i,a.geometry=i,o.geometry=i,a.transform.position.x=-5,o.transform.position.x=5,r.root.addChild(n),r.root.addChild(a),r.root.addChild(o);const h=s.camera;function c(){s.connectCamera(),s.renderer.state.colorbuffer.setClearColor(new Bt(.9,.9,.9,1)),s.renderer.state.colorbuffer.clear(),s.render(r)}h.transform.position.set(0,0,15),h.lookAt(new kt(0,0,0)),c(),yield t.screenShotCompareElement(e,"test");const l=new wi(e),u=new an(h);u.registerInteractor(l),t.framer.setFrame(()=>{u.update(),c()})})}const Jo=[{name:"basic scene",build:Qo},{name:"primitive",build:Ko}];window.artglExamples=Jo,window.HeadlessTestBridge=Go,r["a"].use(Zo["a"]);var th=new Zo["a"].Store({state:{showConfigPanel:!1,showScenePanel:!1,examples:Jo,viewExample:""},mutations:{},actions:{}});r["a"].config.productionTip=!1,new r["a"]({router:Wo,store:th,render:t=>t(b)}).$mount("#app")},d078:function(t,e,s){},d14e:function(t,e,s){"use strict";var r=s("d2b6"),i=s.n(r);i.a},d235:function(t,e,s){},d2b6:function(t,e,s){},d781:function(t,e,s){"use strict";var r=s("dc85"),i=s.n(r);i.a},d97a:function(t,e,s){},dc85:function(t,e,s){},df0b:function(t,e,s){"use strict";var r=s("9c93"),i=s.n(r);i.a},e88d:function(t,e,s){},f078:function(t,e,s){"use strict";var r=s("0223"),i=s.n(r);i.a},f596:function(t,e,s){}});
//# sourceMappingURL=app.a1b9ca61.js.map